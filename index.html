<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPACEDUST - Cosmic Strategy</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        /* –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è –≤—Å–µ—Ö UI-–ø–∞–Ω–µ–ª–µ–π –∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        :root {
            --safe-top: env(safe-area-inset-top, 40px);
            --ui-top-offset: calc(80px + var(--safe-top));
        }
        body { background: linear-gradient(135deg, #0a0a2e 0%, #16213e 50%, #000000 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: 'Orbitron', monospace; overflow: hidden; touch-action: none; color: #fff; }
        
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        #gameContainer, #galaxyContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #galaxyContainer {
            display: none;
            background:
                radial-gradient(circle at 20% 30%, rgba(120, 0, 200, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 100, 255, 0.3) 0%, transparent 50%);
        }
        
        canvas {
            border: 0.314px solid rgba(0, 255, 255, 0.7);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5), inset 0 0 20px rgba(0, 255, 255, 0.2);
            background: #000;
            display: block;
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —à—É—Ç–µ—Ä–∞ */
        #ui {
            position: absolute;
            top: var(--ui-top-offset);
            left: 50%;
            transform: translateX(-50%);
            color: #00ffff;
            font-size: 16px;
            text-shadow: 0 0 10px #00ffff;
            z-index: 10;
            pointer-events: none;
            background: rgba(0, 20, 30, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 255, 0.5);
            display: flex;
            flex-direction: row;
            gap: 20px;
            animation: ui-glow 2s infinite alternate;
        }
        
        @keyframes ui-glow {
            from { box-shadow: 0 0 10px rgba(0, 255, 255, 0.5); }
            to { box-shadow: 0 0 20px rgba(0, 255, 255, 0.8); }
        }
        
        .ui-item { display: flex; align-items: center; gap: 8px; }
        
        
        #gameOver, #startScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 20;
            width: 90%;
            max-width: 400px;
            background: rgba(10, 20, 40, 0.9);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid rgba(0, 255, 255, 0.7);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            animation: screen-pulse 1.5s infinite alternate;
        }
        
        @keyframes screen-pulse {
            from { transform: translate(-50%, -50%) scale(1); opacity: 0.9; }
            to { transform: translate(-50%, -50%) scale(1.02); opacity: 1; }
        }
        
        #gameOver { display: none; }
        
        #startScreen h1 {
            font-size: 36px;
            text-shadow: 0 0 20px #00ffff;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
            background: linear-gradient(to right, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        #gameOver h1 {
            font-size: 32px;
            text-shadow: 0 0 20px #ff3232;
            margin-bottom: 10px;
            color: #ff3232;
        }
        
        #startScreen p, #gameOver p {
            font-size: 16px;
            margin: 10px 0;
            color: #a0e0ff;
            line-height: 1.5;
        }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .btn {
            background: transparent;
            border: 2px solid #00ffff;
            color: #00ffff;
            padding: 15px 40px;
            font-size: 18px;
            margin-top: 20px;
            transition: all 0.3s;
            font-family: 'Orbitron', monospace;
            touch-action: manipulation;
            border-radius: 30px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before, .btn:active::before { left: 100%; }
        .btn:active { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 20px #00ffff; }
        
        #leftZone, #rightZone {
            position: absolute;
            bottom: 0;
            width: 35%;
            height: 150px;
            z-index: 14;
            opacity: 0;
        }
        
        #leftZone { left: 0; }
        #rightZone { right: 0; }
        
        .instructions { margin-top: 15px; font-size: 14px; color: #80c0ff; }
        
        .power-ups { display: flex; justify-content: center; gap: 8px; margin-top: 8px; }
        
        .power-up {
            width: 33px;
            height: 33px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.3);
            border: 1px solid gold;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            animation: power-glow 1s infinite alternate;
        }
        
        @keyframes power-glow { from { box-shadow: 0 0 5px gold; } to { box-shadow: 0 0 3.14px gold; } }
        
        .stars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        
        .star { position: absolute; background-color: white; border-radius: 50%; animation: twinkle 2s infinite alternate; }
        
        @keyframes twinkle { from { opacity: 0.5; } to { opacity: 1; } }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≥–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç—ã */
        /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å: –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–ê–Ø –ú–ò–°–°–ò–Ø */
        .mission-locked {
            border: 3px dashed #5555ff;
            color: #5555ff;
            background: rgba(50, 50, 150, 0.4);
            box-shadow: 0 0 20px rgba(85, 85, 255, 0.5);
            animation: pulse-lock 2s infinite alternate;
        }

        /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å: –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–ê–Ø –ú–ò–°–°–ò–Ø */
        .mission-unlocked {
            border: 3px solid #ff00ff;
            color: #ff00ff;
            background: rgba(150, 50, 150, 0.6);
            box-shadow: 0 0 30px #ff00ff;
            animation: pulse-unlock 1s infinite alternate;
        }

        @keyframes pulse-lock {
            from { opacity: 0.7; }
            to { opacity: 1.0; }
        }

        @keyframes pulse-unlock {
            from { transform: scale(1.0); box-shadow: 0 0 30px #ff00ff; }
            to { transform: scale(1.1); box-shadow: 0 0 40px #ff00ff; }
        }
        .sector {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 3s infinite alternate;
        }
        
        .sector.controlled {
            background: radial-gradient(circle, #00ff88, #0088ff);
            box-shadow: 0 0 30px #00ff88;
        }
        
        .sector.enemy {
            background: radial-gradient(circle, #ff4444, #ff0088);
            box-shadow: 0 0 30px #ff4444;
        }
        
        .sector.neutral {
            background: radial-gradient(circle, #8888ff, #4444aa);
            box-shadow: 0 0 20px #8888ff;
        }
        
        .sector:hover {
            transform: scale(1.2);
            z-index: 10;
        }
        
        .sirius-dust {
            position: absolute;
            top: 20%;
            left: 15%;
            font-size: 24px;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff;
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { opacity: 0.7; transform: scale(1); }
            to { opacity: 1; transform: scale(1.05); }
        }
        
        .resources-panel {
            position: absolute;
            top: var(--ui-top-offset);
            right: 20px;
            background: rgba(0, 20, 40, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #00ffff;
        }
        
        .mission-alert {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 100, 0, 0.9);
            padding: 15px 30px;
            border-radius: 25px;
            animation: alert-pulse 1.5s infinite;
        }
        
        @keyframes alert-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 100, 0, 0.7); }
            50% { box-shadow: 0 0 40px rgba(255, 100, 0, 1); }
        }
        

        /* –£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        #bottomPanel {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 0);
            left: 0;
            width: 100%;
            padding: 10px 20px calc(20px + env(safe-area-inset-bottom, 0)) 20px;
            box-sizing: border-box;
            z-index: 15;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: auto;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
        }

        .control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #00ffff;
            color: #00ffff;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            transition: all 0.1s;
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }

        #fireBtn {
            width: 80px;
            height: 80px;
            background: rgba(255, 50, 50, 0.2);
            border-color: #ff3232;
            color: #ff3232;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 50, 50, 0.5);
            touch-action: manipulation;
            text-align: center;
            line-height: 1.2;
        }

        #mapBtn, #shooterBtn {
            width: 60px;
            height: 60px;
            background: rgba(0, 150, 255, 0.3);
            border: 2px solid #00aaff;
            color: #00aaff;
            font-size: 20px;
            box-shadow: 0 0 15px rgba(0, 150, 255, 0.5);
            pointer-events: auto;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –¥—ã—Ö–∞–Ω–∏—è –∏ —Å–∏—è–Ω–∏—è –¥–ª—è —Å–µ–∫—Ç–æ—Ä–∞ $XDUST-9001 */
        .sector.mission-unlocked::after {
            content: "";
            position: absolute;
            width: 120%;
            height: 120%;
            border-radius: 50%;
            background: radial-gradient(rgba(255,0,255,0.4), transparent 70%);
            animation: xdustBreath 2.5s infinite ease-in-out;
            z-index: -1;
        }

        @keyframes xdustBreath {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* –ó–≤–µ–∑–¥–Ω—ã–π —Ñ–æ–Ω –≥–∞–ª–∞–∫—Ç–∏–∫–∏ */
        #galaxyContainer::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1), transparent 70%),
                        url('https://www.transparenttextures.com/patterns/stardust.png');
            background-size: cover;
            animation: starsDrift 60s linear infinite;
            z-index: 0;
        }

        @keyframes starsDrift {
            from { background-position: 0 0; }
            to { background-position: 1000px 1000px; }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è "–≤–∑—Ä—ã–≤–∞ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–≥–æ —Å–≤–µ—Ç–∞" */
        @keyframes burstFade {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            to { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —à—É—Ç–µ—Ä -->
    <div id="gameContainer">
        <div class="stars" id="stars"></div>
        
        <div id="ui">
            <div class="ui-item"><span>‚ö°</span><span id="score">0</span></div>
            <div class="ui-item"><span>‚ù§Ô∏è</span><span id="lives">3</span></div>
        </div>
        
        <div id="startScreen">
            <h1>üöÄ SPACEDUST</h1>
            <p>Defend Galaxy!</p>
            <p>Dust Your Enemy and Collect Bonuses</p>
            <div class="instructions">Use Buttons to Move and Fire</div>
            <div class="power-ups"><div class="power-up">S</div><div class="power-up">P</div><div class="power-up">L</div></div>
            <button class="btn" ontouchstart="startGame()" onclick="startGame()">–°–¢–ê–†–¢</button>
            <div style="margin-top: 15px;">
                <button class="mode-btn" onclick="switchToGalaxy()">üåå –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞</button>
            </div>
        </div>
        
        <div id="gameOver">
            <h1>Mission Fail</h1>
            <p>Score: <span id="finalScore">0</span></p>
            <p>Sector under enemy control!</p>
            <button class="btn" ontouchstart="restartGame()" onclick="restartGame()">–ü–û–í–¢–û–†–ò–¢–¨</button>
            <div style="margin-top: 15px;">
                <button class="mode-btn" onclick="switchToGalaxy()">üåå –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞</button>
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>

        <div id="bottomPanel" style="display: none;">
            <button id="mapBtn" class="control-btn" onclick="switchToGalaxy()">üåå</button>
            
            <div style="display: flex; gap: 15px; pointer-events: auto;">
                <div class="control-btn" id="leftBtn">‚óÄ</div>
                <div class="control-btn" id="rightBtn">‚ñ∂</div>
            </div>
            
            <div id="fireBtn" class="control-btn">FIRE</div>
        </div>

        <div id="leftZone"></div>
        <div id="rightZone"></div>
    </div>

    <!-- –ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ -->
    <div id="galaxyContainer">
        <div class="sirius-dust">‚ú® XDUST –° –°–ò–†–ò–£–°–ê! ‚ú®</div>
        
        <div class="resources-panel">
            <h3>–†–µ—Å—É—Ä—Å—ã XDUST</h3>
            <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energy">1500</span></div>
            <div>ü™ê –ú–µ—Ç–∞–ª–ª—ã: <span id="metals">800</span></div>
            <div>üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã: <span id="crystals">300</span></div>
            <div>üöÄ –û—á–∫–∏: <span id="galaxyScore">0</span></div>
        </div>
        
        <div id="achievementsPanel" style="
            position: absolute;
            top: var(--ui-top-offset);
            left: 20px;
            width: 200px;
            background: rgba(0, 20, 40, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ff00ff;
            box-shadow: 0 0 15px #ff00ff;
            max-height: calc(100vh - var(--ui-top-offset) - 130px);
            overflow-y: auto;
            z-index: 10;
        ">
            <h3>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
            <div id="achievementsList"></div>
        </div>

        <div class="mission-alert">
            üö® –°–∏—Ä–∏—É—Å –ø–µ—Ä–µ–¥–∞–µ—Ç XDUST –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è —Ñ–ª–æ—Ç–∞!
        </div>

        <!-- Upgrade Shop Modal Button -->
        <button id="openUpgradeModalBtn" style="
            position: fixed;
            bottom: 110px;
            left: 20px;
            z-index: 30;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            color: #fff;
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            box-shadow: 0 0 15px #ff00ff;
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            letter-spacing: 1px;
            transition: box-shadow 0.2s;
        " onclick="openUpgradeShopModal()">üõ†Ô∏è –ê–ø–≥—Ä–µ–π–¥—ã</button>
        <!-- Upgrade Shop Modal (Full Screen) -->
        <div id="upgradeShopModal" style="
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(10, 5, 40, 0.98);
            z-index: 9999;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            padding-top: var(--ui-top-offset);
            padding-bottom: 6vw;
        ">
            <div style="
                margin: 0 auto;
                width: 96vw;
                max-width: 400px;
                background: rgba(5, 5, 50, 0.97);
                padding: 28px 18px 18px 18px;
                border-radius: 18px;
                border: 2px solid #ff00ff;
                box-shadow: 0 0 35px #ff00ff;
                position: relative;
                min-height: 270px;
                color: #fff;
            ">
                <button onclick="closeUpgradeShopModal()" style="
                    position: absolute;
                    top: 12px; right: 12px;
                    background: #ff00ff;
                    color: #fff;
                    border: none;
                    border-radius: 50%;
                    width: 34px; height: 34px;
                    font-size: 20px;
                    font-weight: bold;
                    box-shadow: 0 0 10px #ff00ff;
                    cursor: pointer;
                    z-index: 2;
                " aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
                <h3 style="color: #ff00ff; text-align: center; margin-bottom: 14px; text-shadow: 0 0 12px #ff00ff;">
                    üõ†Ô∏è –ú–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏–∏ XDUST
                </h3>
                <div id="upgradesListModal"></div>
                <p style="font-size: 13px; margin-top: 14px; color: #aaa; text-align: center;">
                    ‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="shopEnergyModal" class="resource-value">0</span>
                </p>
            </div>
        </div>
        
        <!-- –£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –ö–ù–û–ü–ö–ê –í–ù–ò–ó–£ -->
        <div id="bottomPanel-galaxy" style="position: fixed; bottom: 0; right: 20px; z-index: 100; padding-bottom: 20px;">
            <button id="shooterBtn" class="control-btn" onclick="switchToShooter()">üéÆ</button>
        </div>
    </div>

    <script>
        // === –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ú–ï–ñ–î–£ –†–ï–ñ–ò–ú–ê–ú–ò ===
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
        let currentEnergy = 1500;
        let currentMetals = 800;
        let currentCrystals = 300;
        let miningInterval; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –º–∞–π–Ω–∏–Ω–≥–∞

        // === –ê–ü–ì–†–ï–ô–î–´ XDUST ===
        let upgradeLevels = { fireRate: 0, bulletDamage: 0, hull: 0 };

        // –î–∞–Ω–Ω—ã–µ –∞–ø–≥—Ä–µ–π–¥–æ–≤: —Å—Ç–æ–∏–º–æ—Å—Ç—å, —ç—Ñ—Ñ–µ–∫—Ç –∏ –º–∞–∫—Å–∏–º—É–º
        
        
        const UPGRADE_DATA = {
            fireRate: {
                name: "–°–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å",
                maxLevel: 5,
                baseCost: 500,
                costMultiplier: 1.5,
                effect: level => level > 0 ? (250 / (1 + level * 0.15)) : 250,
                description: "–£–º–µ–Ω—å—à–∞–µ—Ç –∫—É–ª–¥–∞—É–Ω –≤—ã—Å—Ç—Ä–µ–ª–æ–≤."
            },
            bulletDamage: {
                name: "–£—Ä–æ–Ω",
                maxLevel: 5,
                baseCost: 1000,
                costMultiplier: 1.8,
                effect: level => 1 + level * 0.5,
                description: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–Ω –æ—Ç –ø—É–ª—å."
            },
            hull: {
                name: "–ü—Ä–æ—á–Ω–æ—Å—Ç—å –∫–æ—Ä–ø—É—Å–∞",
                maxLevel: 3,
                baseCost: 800,
                costMultiplier: 2.0,
                effect: level => 3 + level,
                description: "–î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∂–∏–∑–Ω—å."
            }
        };

        // ‚≠ê –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Ä–µ—Å—É—Ä—Å—ã + –∞–ø–≥—Ä–µ–π–¥—ã)
        function saveData() {
            const gameState = {
                energy: currentEnergy,
                metals: currentMetals,
                crystals: currentCrystals,
                shooterScore: score,
                shooterLives: lives,
                upgradeLevels: upgradeLevels
            };
            try { localStorage.setItem('xdust_save_data', JSON.stringify(gameState)); } catch(e){}
        }

        // ‚≠ê –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadData() {
            try {
                const savedData = localStorage.getItem('xdust_save_data');
                if(!savedData) return false;
                const data = JSON.parse(savedData);
                if(typeof data.energy === 'number') currentEnergy = data.energy;
                if(typeof data.metals === 'number') currentMetals = data.metals;
                if(typeof data.crystals === 'number') currentCrystals = data.crystals;
                if(typeof data.shooterScore === 'number') score = data.shooterScore;
                if(typeof data.shooterLives === 'number') lives = data.shooterLives;
                if(data.upgradeLevels) upgradeLevels = data.upgradeLevels;
                applyUpgradeEffects();
                updateUI();
                return true;
            } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e); return false; }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∞–ø–≥—Ä–µ–π–¥–æ–≤
        function applyUpgradeEffects() {
            shootCooldown = UPGRADE_DATA.fireRate.effect(upgradeLevels.fireRate);
            const maxLives = UPGRADE_DATA.hull.effect(upgradeLevels.hull);
            lives = Math.min(lives, maxLives);
            updateUI();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∞–Ω–µ–ª–∏ –∞–ø–≥—Ä–µ–π–¥–æ–≤ (—Å—Ç–∞—Ä—ã–π –±–ª–æ–∫ –¥–ª—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ - –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
        function renderUpgradeShop() {
            // legacy, –æ—Å—Ç–∞–≤–∏–º –≤—ã–∑–æ–≤ –ø—É—Å—Ç—ã–º, –ª–∏–±–æ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            // –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å renderUpgradeShopModal() –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
        }

        
        
        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç—Ä–µ—á–∏ —Å —Å–µ–∫—Ç–æ—Ä–æ–º $XDUST ===
        function handleXDUSTEncounter(sector) {
            if (sector.type === "xdust") {
                if (sector.visited) {
                    if (typeof tg !== "undefined" && tg && tg.showAlert) {
                        tg.showAlert("‚ú® –í—ã —É–∂–µ –ø–æ—Å–µ—Ç–∏–ª–∏ —Å–µ–∫—Ç–æ—Ä $XDUST!");
                    } else {
                        alert("‚ú® –í—ã —É–∂–µ –ø–æ—Å–µ—Ç–∏–ª–∏ —Å–µ–∫—Ç–æ—Ä $XDUST!");
                    }
                    return;
                }
                // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç: –±–∏—Ä—é–∑–æ–≤—ã–π –≤—Å–ø–ª–µ—Å–∫
                const galaxyContainer = document.getElementById('galaxyContainer');
                const burst = document.createElement('div');
                burst.style.position = 'absolute';
                burst.style.left = `${sector.x}%`;
                burst.style.top = `${sector.y}%`;
                burst.style.width = '180px';
                burst.style.height = '180px';
                burst.style.borderRadius = '50%';
                burst.style.background = 'radial-gradient(circle, rgba(0,255,255,0.7), transparent 70%)';
                burst.style.transform = 'translate(-50%, -50%)';
                burst.style.animation = 'burstFade 2s ease-out forwards';
                burst.style.pointerEvents = 'none';
                galaxyContainer.appendChild(burst);
                setTimeout(() => burst.remove(), 1700);
                // –ë–æ–Ω—É—Å $XSDC
                const xsdcReward = 3141;
                currentXSDC += xsdcReward;
                displayResources();
                saveDataAll && saveDataAll();
                sector.visited = true;
                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                    tg.showAlert(`‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–µ–∫—Ç–æ—Ä $XDUST! –ë–æ–Ω—É—Å: +${xsdcReward} $XSDC`);
                } else {
                    alert(`‚ú® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–µ–∫—Ç–æ—Ä $XDUST! –ë–æ–Ω—É—Å: +${xsdcReward} $XSDC`);
                }
                // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–µ—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –∑–∞—Ç–µ–º–Ω–∏—Ç—å —Å–µ–∫—Ç–æ—Ä)
                initGalaxyMap();
            }
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        }

        // –ù–æ–≤—ã–π: –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–ø–≥—Ä–µ–π–¥–æ–≤ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function renderUpgradeShopModal() {
            const list = document.getElementById('upgradesListModal');
            const shopEnergy = document.getElementById('shopEnergyModal');
            if(!list || !shopEnergy) return;
            list.innerHTML = '';
            shopEnergy.textContent = Math.floor(currentEnergy);
            for(const key in UPGRADE_DATA){
                const data = UPGRADE_DATA[key];
                const currentLevel = upgradeLevels[key];
                const nextCost = Math.floor(data.baseCost * Math.pow(data.costMultiplier, currentLevel));
                const isMaxLevel = currentLevel >= data.maxLevel;
                const upgradeDiv = document.createElement('div');
                upgradeDiv.className = 'upgrade-item';
                upgradeDiv.style.border='1px solid rgba(255,0,255,0.4)';
                upgradeDiv.style.padding='10px 8px 8px 8px';
                upgradeDiv.style.marginBottom='12px';
                upgradeDiv.style.borderRadius='7px';
                upgradeDiv.style.backgroundColor = isMaxLevel?'rgba(0,255,136,0.08)':'rgba(0,0,0,0.26)';

                const levelIndicators = Array(data.maxLevel).fill(0).map((_,i)=>
                    `<span style="display:inline-block;width:10px;height:10px;margin:0 2px;border-radius:50%;background-color:${i<currentLevel?'#ff00ff':'#333'};box-shadow:${i<currentLevel?'0 0 6px #ff00ff':'none'}"></span>`
                ).join('');

                if(isMaxLevel){
                    upgradeDiv.innerHTML = `
                        <div style="color:#00ff88;font-weight:bold;">${data.name} (–ú–ê–ö–°)</div>
                        <div style="font-size:11px;color:#00ff88;margin-bottom:5px;">${levelIndicators}</div>
                        <div style="font-size:13px;color:#00ff88;">–ú–ê–ö–°–ò–ú–£–ú.</div>
                    `;
                } else {
                    const canAfford = currentEnergy>=nextCost;
                    const btnColor = canAfford?'#ff00ff':'#444';
                    const btnShadow = canAfford?'0 0 10px #ff00ff':'none';
                    upgradeDiv.innerHTML = `
                        <div style="color:#fff;font-weight:bold;">${data.name} (–£—Ä. ${currentLevel})</div>
                        <div style="font-size:11px;color:#ccc;margin-bottom:5px;">${levelIndicators}</div>
                        <div style="font-size:13px;color:#aaa;">${data.description}</div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                            <span style="color:${canAfford?'#00ffff':'#ff3333'};font-weight:bold;">‚ö° ${nextCost}</span>
                            <button onclick="buyUpgrade('${key}'); setTimeout(renderUpgradeShopModal, 10);" style="background:${btnColor};color:#000;border:none;padding:6px 16px;cursor:${canAfford?'pointer':'not-allowed'};border-radius:3px;font-family:'Orbitron',monospace;font-weight:bold;box-shadow:${btnShadow};font-size:15px;transition:all 0.2s;" ${canAfford?'':'disabled'}>–ö–£–ü–ò–¢–¨</button>
                        </div>
                    `;
                }
                list.appendChild(upgradeDiv);
            }
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–ø–≥—Ä–µ–π–¥–æ–≤
        function openUpgradeShopModal() {
            const modal = document.getElementById('upgradeShopModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                renderUpgradeShopModal();
            }
        }
        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–ø–≥—Ä–µ–π–¥–æ–≤
        function closeUpgradeShopModal() {
            const modal = document.getElementById('upgradeShopModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // –ü–æ–∫—É–ø–∫–∞ –∞–ø–≥—Ä–µ–π–¥–∞
        function buyUpgrade(key){
            const data = UPGRADE_DATA[key];
            const currentLevel = upgradeLevels[key];
            const cost = Math.floor(data.baseCost * Math.pow(data.costMultiplier, currentLevel));
            if(currentEnergy>=cost && currentLevel<data.maxLevel){
                currentEnergy -= cost;
                upgradeLevels[key]++;
                saveData();
                applyUpgradeEffects();

                const itemElement = document.querySelector(`#upgradesList .upgrade-item:nth-child(${Object.keys(UPGRADE_DATA).indexOf(key)+1})`);
                if(itemElement){
                    itemElement.style.boxShadow='0 0 20px #00ff88';
                    setTimeout(()=>{itemElement.style.boxShadow='none'; renderUpgradeShopModal();},300);
                } else { renderUpgradeShopModal(); }

                if(tg) tg.showAlert(`‚úÖ ${data.name} –ø–æ–≤—ã—à–µ–Ω –¥–æ –£—Ä. ${upgradeLevels[key]}!`);
            } else {
                if(tg) tg.showAlert("üö´ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!");
                // –ü–æ–∫–∞—á–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –æ—à–∏–±–∫–∏
                const modal = document.getElementById('upgradeShopModal');
                if (modal) {
                    const inner = modal.querySelector('div');
                    if (inner) {
                        inner.style.transform = 'translateX(-7px)';
                        setTimeout(()=>{inner.style.transform='translateX(7px)';
                            setTimeout(()=>{inner.style.transform='translateX(0)'},50);},50);
                    }
                }
            }
        }

        // === –ü–†–û–ì–†–ï–°–° –ê–ü–ì–†–ï–ô–î–û–í: –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê ===
        function saveUpgradeData() {
            // –ü—Ä–∏–º–µ—Ä: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Å—É—Ä—Å—ã –∏ –∞–ø–≥—Ä–µ–π–¥—ã (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
            const data = {
                currentEnergy,
                currentMetals,
                currentCrystals,
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å: upgrades: upgrades (–µ—Å–ª–∏ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç upgrades)
            };
            localStorage.setItem('xdgame_upgrade_data', JSON.stringify(data));
        }

        function switchToGalaxy() {
            // Hide shooter UI
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('galaxyContainer').style.display = 'flex';
            // Hide shooter bottom panel/buttons
            document.getElementById('bottomPanel').style.display = 'none';
            // Show galaxy bottom panel/button
            const galaxyPanel = document.getElementById('bottomPanel-galaxy');
            if (galaxyPanel) galaxyPanel.style.display = 'block';
            // Hide shooter-specific controls if present
            // Also ensure shooterBtn (if present in shooter) is hidden
            const shooterBtn = document.getElementById('shooterBtn');
            if (shooterBtn) shooterBtn.style.display = 'block';
            // Hide any shooter overlays if present
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            try { backgroundMusic.pause(); } catch(e) {}
            try { galaxyMusic.play().catch(() => {}); } catch(e) {}
            initGalaxyMap();
            startMining();
        }

        // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è switchToShooter: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –º–∏—Å—Å–∏–π, $XSDC –∏ –∫–æ–ª–±—ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏—Å—Å–∏–∏
        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º —à—É—Ç–µ—Ä–∞.
         * @param {boolean} isMission - true –µ—Å–ª–∏ —ç—Ç–æ –º–∏—Å—Å–∏—è, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω–∞—è –∏–≥—Ä–∞
         * @param {number} missionDifficulty - —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏—Å—Å–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
         * @param {function} onMissionComplete - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ª–±—ç–∫ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –º–∏—Å—Å–∏–∏
         * @param {object} missionOptions - –æ–ø—Ü–∏–∏ –º–∏—Å—Å–∏–∏: { xsdcReward, missionScoreBase }
         */
        function switchToShooter(isMission = false, missionDifficulty = 1, onMissionComplete = null, missionOptions = {}) {
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞–π–Ω–∏–Ω–≥ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —à—É—Ç–µ—Ä
            stopMining();

            // UI: –ø–æ–∫–∞–∑–∞—Ç—å —à—É—Ç–µ—Ä, —Å–∫—Ä—ã—Ç—å –≥–∞–ª–∞–∫—Ç–∏–∫—É –∏ –ª–∏—à–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
            document.getElementById('galaxyContainer').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            document.getElementById('bottomPanel').style.display = 'flex';
            const galaxyPanel = document.getElementById('bottomPanel-galaxy');
            if (galaxyPanel) galaxyPanel.style.display = 'none';
            const shooterBtn = document.getElementById('shooterBtn');
            if (shooterBtn) shooterBtn.style.display = 'none';

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ñ–æ–Ω–æ–≤—É—é –º—É–∑—ã–∫—É
            try { backgroundMusic.play().catch(() => {}); } catch(e) {}
            try { galaxyMusic.pause(); galaxyMusic.currentTime = 0; } catch(e) {}

            // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è UI —Å—Ç–∞—Ä—Ç/–≥–µ–π–º-–æ–≤–µ—Ä (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–≥—Ä—ã)
            if (!gameRunning) {
                if (lives <= 0) {
                    document.getElementById('gameOver').style.display = 'block';
                } else {
                    document.getElementById('startScreen').style.display = 'block';
                }
            }

            // --- –ú–∏—Å—Å–∏–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º ---
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –º–∏—Å—Å–∏–∏
            if (isMission) {
                // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
                enemies = [];
                bullets = [];
                powerups = [];
                explosions = [];
                particles = [];
                boss = null;
                bossActive = false;

                // –ó–∞–ø—É—Å–∫ –º–∏—Å—Å–∏–∏
                startMission(missionOptions);
            }
            if (isMission) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∏—Å—Å–∏–∏
                gameRunning = true;
                // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–æ missionScoreBase, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º score
                if (typeof missionOptions.missionScoreBase === 'number') {
                    score = missionOptions.missionScoreBase;
                } else {
                    score = Math.floor(score * missionDifficulty);
                }
                // –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–ª–∏—è–µ—Ç –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –≤—Ä–∞–≥–æ–≤ –∏ –±–æ—Å—Å–æ–≤
                enemySpawnRate = 0.03 * missionDifficulty;
                bossInterval = 45000 / missionDifficulty;

                // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏—Å—Å–∏–∏
                let missionActive = true;
                // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏—Å—Å–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏—é –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é —Ü–µ–ª–∏)
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ—é –º–µ—Ö–∞–Ω–∏–∫—É, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ —Ç–∞–π–º–µ—Ä—É –∏–ª–∏ –ø–æ –æ—á–∫–∞–º
                // –ü—Ä–∏–º–µ—Ä: –º–∏—Å—Å–∏—è –¥–ª–∏—Ç—Å—è N —Å–µ–∫—É–Ω–¥, –∑–∞—Ç–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                if (typeof missionOptions.durationMs === 'number' && missionOptions.durationMs > 0) {
                    setTimeout(() => {
                        if (!missionActive) return;
                        missionActive = false;
                        gameRunning = false;
                        // –ù–∞–≥—Ä–∞–¥–∞ $XSDC
                        const xsdcReward = typeof missionOptions.xsdcReward === 'number' ? missionOptions.xsdcReward : Math.floor(1000 * missionDifficulty);
                        currentXSDC += xsdcReward;
                        displayResources();
                        saveDataAll && saveDataAll();
                        if (typeof onMissionComplete === 'function') {
                            onMissionComplete({ success: true, xsdcReward, score, difficulty: missionDifficulty });
                        } else {
                            // UI-—Ñ–∏–¥–±–µ–∫
                            if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                tg.showAlert(`‚úÖ –ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ù–∞–≥—Ä–∞–¥–∞: +${xsdcReward} $XSDC`);
                            } else {
                                alert(`‚úÖ –ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ù–∞–≥—Ä–∞–¥–∞: +${xsdcReward} $XSDC`);
                            }
                        }
                        // –í–µ—Ä–Ω—É—Ç—å –∏–≥—Ä–æ–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É
                        switchToGalaxy();
                    }, missionOptions.durationMs);
                }
                // –õ–æ–≥ –∑–∞–ø—É—Å–∫–∞ –º–∏—Å—Å–∏–∏
                console.log("üí• –ú–∏—Å—Å–∏—è –∑–∞–ø—É—â–µ–Ω–∞!", { missionDifficulty, missionOptions });
            } else {
                // --- –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º ---
                gameRunning = true;
                enemySpawnRate = 0.03;
                bossInterval = 45000;
            }

            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
            gameLoop();
        }

        // –ó–∞–ø—É—Å–∫ –º–∞–π–Ω–∏–Ω–≥–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∫–∞—Ä—Ç—É
        function startMining() {
            if (miningInterval) return;
            miningInterval = setInterval(() => {
                // 1% –æ—Ç —Ç–µ–∫—É—â–µ–π —ç–Ω–µ—Ä–≥–∏–∏ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –¥–æ–±—ã—á–∏
                const miningAmount = Math.max(5, Math.floor(currentEnergy * 0.01));
                updateGalaxyResources(miningAmount);
            }, 3500);
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞–π–Ω–∏–Ω–≥–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∫–∞—Ä—Ç—ã
        function stopMining() {
            if (miningInterval) {
                clearInterval(miningInterval);
                miningInterval = null;
            }
        }
        
        // === –ì–ê–õ–ê–ö–¢–ò–ß–ï–°–ö–ê–Ø –ö–ê–†–¢–ê (–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ) ===
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è $XSDC (–±–∞–ª–∞–Ω—Å)
        let currentXSDC = 0;
        let telegramId = null;

        function loadUpgradeData() {
            try {
                const data = JSON.parse(localStorage.getItem('xdgame_upgrade_data'));
                if (data) {
                    if (typeof data.currentEnergy === 'number') currentEnergy = data.currentEnergy;
                    if (typeof data.currentMetals === 'number') currentMetals = data.currentMetals;
                    if (typeof data.currentCrystals === 'number') currentCrystals = data.currentCrystals;
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å: if (data.upgrades) upgrades = data.upgrades;
                }
            } catch (e) {}
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ $XSDC –≤ —Ä–µ—Å—É—Ä—Å–∞—Ö
        function displayResources() {
            const energyElem = document.getElementById('energy');
            const metalsElem = document.getElementById('metals');
            const crystalsElem = document.getElementById('crystals');
            const scoreElem = document.getElementById('galaxyScore');

            // $XSDC –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            let xsdcElem = document.getElementById('xsdcAmount');
            if (!xsdcElem) {
                const panel = document.querySelector('.resources-panel');
                if (panel) {
                    const div = document.createElement('div');
                    div.innerHTML = `ü™ô <span id="xsdcAmount">${Math.floor(currentXSDC)}</span> <span style="color:#ff00ff;">$XSDC</span>`;
                    panel.appendChild(div);
                    xsdcElem = div.querySelector('#xsdcAmount');
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            const highlightChange = (elem) => {
                if (!elem) return;
                elem.style.transition = 'background-color 0.3s';
                elem.style.backgroundColor = '#00ffff33';
                setTimeout(() => { elem.style.backgroundColor = 'transparent'; }, 300);
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (energyElem) { energyElem.textContent = Math.floor(currentEnergy); highlightChange(energyElem); }
            if (metalsElem) { metalsElem.textContent = Math.floor(currentMetals); highlightChange(metalsElem); }
            if (crystalsElem) { crystalsElem.textContent = Math.floor(currentCrystals); highlightChange(crystalsElem); }
            if (scoreElem) { scoreElem.textContent = score; highlightChange(scoreElem); }
            if (xsdcElem) { xsdcElem.textContent = Math.floor(currentXSDC); highlightChange(xsdcElem); }

            console.log("Telegram ID:", telegramId);
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∏ $XSDC + –∞–ø–≥—Ä–µ–π–¥—ã
        function saveDataAll() {
            const gameState = {
                energy: currentEnergy,
                metals: currentMetals,
                crystals: currentCrystals,
                shooterScore: score,
                shooterLives: lives,
                upgradeLevels: upgradeLevels,
                xsdc: currentXSDC,
                telegramId: telegramId,
            };
            try { localStorage.setItem('xdust_save_data', JSON.stringify(gameState)); } catch(e){}
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∏ $XSDC
        function loadDataAll() {
            try {
                const savedData = localStorage.getItem('xdust_save_data');
                if(!savedData) return false;
                const data = JSON.parse(savedData);
                if(typeof data.energy === 'number') currentEnergy = data.energy;
                if(typeof data.metals === 'number') currentMetals = data.metals;
                if(typeof data.crystals === 'number') currentCrystals = data.crystals;
                if(typeof data.shooterScore === 'number') score = data.shooterScore;
                if(typeof data.shooterLives === 'number') lives = data.shooterLives;
                if(data.upgradeLevels) upgradeLevels = data.upgradeLevels;
                if(typeof data.xsdc === 'number') currentXSDC = data.xsdc;
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                    telegramId = tg.initDataUnsafe.user.id;
                }
                if (typeof data.telegramId === 'number' || typeof data.telegramId === 'string') {
                    telegramId = data.telegramId;
                }
                applyUpgradeEffects();
                displayResources();
                return true;
            } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e); return false; }
        }

        // === GalacticMap: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∏—Å—Å–∏–π, –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ $XSDC ===
        function attemptCapture(sectorId, sectorObj, onFinish) {
            // sectorObj: –æ–±—ä–µ–∫—Ç —Å–µ–∫—Ç–æ—Ä–∞ (—Å–æ–¥–µ—Ä–∂–∏—Ç type, resources, ...).
            // –î–ª—è –º–∏—Å—Å–∏–∏: –Ω–∞—á–∏—Å–ª—è–µ–º xsdcRequired*2, –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞: 10% —Ä–µ—Å—É—Ä—Å–æ–≤
            if (sectorObj.type === 'mission') {
                // –¢–æ–ª—å–∫–æ –¥–ª—è –º–∏—Å—Å–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, $XDUST-9001)
                const xsdcRequired = 3000; // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–∏—Å—Å–∏–∏
                const missionDuration = 5000;
                setTimeout(() => {
                    sectorObj.type = 'controlled';
                    currentXSDC += xsdcRequired * 2;
                    displayResources();
                    saveDataAll();
                    if (typeof onFinish === 'function') onFinish();
                    initGalaxyMap();
                }, missionDuration);
            } else {
                // –û–±—ã—á–Ω—ã–π —Å–µ–∫—Ç–æ—Ä
                sectorObj.type = 'controlled';
                // –í—ã–¥–∞–µ–º –±–æ–Ω—É—Å $XSDC
                const bonus = Math.floor((sectorObj.resources || 0) * 0.1);
                currentXSDC += bonus;
                displayResources();
                saveDataAll();
                if (typeof onFinish === 'function') onFinish();
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É
                initGalaxyMap();
            }
        }

        // === –ù–æ–≤—ã–π initGalaxyMap —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ ===
        function initGalaxyMap() {
            loadUpgradeData();
            loadDataAll();
            applyUpgradeEffects();
            displayResources();

            const galaxyContainer = document.getElementById('galaxyContainer');
            Array.from(galaxyContainer.querySelectorAll('.sector')).forEach(el => el.remove());
            Array.from(galaxyContainer.querySelectorAll('div'))
                .forEach(el => {
                    if (!el.className && !el.id && el.style && el.style.position === 'absolute' && el.style.background === 'white') {
                        el.remove();
                    }
                });

            // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ —Å–µ–∫—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å)
            const sectors = getGalaxySectors();

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è: —à–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–Ω–æ–≥–æ –∞—Å—Ç–µ—Ä–æ–∏–¥–∞, —Ä–µ–π–¥–∞, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏, —Å–∏–≥–Ω–∞–ª–∞ –±–µ–¥—Å—Ç–≤–∏—è –∏ —Ç.–¥.
            if (Math.random() < 0.18) spawnResourceAsteroid(sectors, galaxyContainer);
            if (Math.random() < 0.13) enemyRaid(sectors, galaxyContainer);
            if (Math.random() < 0.11) offerTrade(sectors, galaxyContainer);
            if (Math.random() < 0.09) triggerDistressSignal(sectors, galaxyContainer);
            if (Math.random() < 0.07) buildDefense(sectors, galaxyContainer);

            // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–∞–≥–æ—Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–æ–≤ (–ø—Ä–∏–º–µ—Ä)
            produceSectorResources(sectors);
            updateSectorProsperity(sectors);

            sectors.forEach(sector => {
                let sectorElement = document.createElement('div');
                let adjustedY = sector.y;
                if (sector.name === "–ê–õ–¨–§–ê –¶–ï–ù–¢–ê–í–†–ê") adjustedY = 55;
                if (sector.name === "$XDUST" || sector.name === "$XDUST-9999" || sector.name === "$XDUST-9001") {
                    adjustedY -= 8;
                    if (adjustedY < 0) adjustedY = 0;
                }
                if (sector.type === "mission") {
                    const isUnlocked = !sector.locked;
                    sectorElement.className = isUnlocked ? "sector mission-unlocked" : "sector mission-locked";
                    sectorElement.style.left = `${sector.x}%`;
                    sectorElement.style.top = `${adjustedY}%`;
                    sectorElement.innerHTML = `
                        <div style="text-align:center; font-size:11px;">
                            <strong>${sector.name}</strong><br>
                            ${isUnlocked ? "üöÄ –ú–ï–ì–ê-–ú–ò–°–°–ò–Ø" : "üîí –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û"}<br>
                            ‚ö°${sector.resources}
                        </div>
                    `;
                    sectorElement.addEventListener('click', () => {
                        if (sector.name === "$XDUST-9001") {
                            if (currentEnergy >= 3000) {
                                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                    tg.showAlert("üöÄ –ú–ï–ì–ê-–ú–ò–°–°–ò–Ø –ó–ê–ü–£–©–ï–ù–ê!\n–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫...");
                                } else {
                                    alert("üöÄ –ú–ï–ì–ê-–ú–ò–°–°–ò–Ø –ó–ê–ü–£–©–ï–ù–ê!\n–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫...");
                                }
                                const burst = document.createElement('div');
                                burst.style.position = 'absolute';
                                burst.style.left = '50%';
                                burst.style.top = '50%';
                                burst.style.width = '200px';
                                burst.style.height = '200px';
                                burst.style.borderRadius = '50%';
                                burst.style.background = 'radial-gradient(circle, rgba(255,0,255,0.6), transparent 70%)';
                                burst.style.transform = 'translate(-50%, -50%)';
                                burst.style.animation = 'burstFade 2s ease-out forwards';
                                galaxyContainer.appendChild(burst);
                                setTimeout(() => burst.remove(), 2000);
                                attemptCapture(sector.id, sector, () => {
                                    if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                        tg.showAlert("‚úÖ –ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–æ–ª—É—á–µ–Ω–æ $XSDC!");
                                    } else {
                                        alert("‚úÖ –ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–æ–ª—É—á–µ–Ω–æ $XSDC!");
                                    }
                                });
                            } else {
                                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                    tg.showAlert(`üîí –ù—É–∂–Ω–æ 3000 ‚ö°\n–£ –≤–∞—Å: ${currentEnergy}`);
                                } else {
                                    alert(`üîí –ù—É–∂–Ω–æ 3000 ‚ö°\n–£ –≤–∞—Å: ${currentEnergy}`);
                                }
                            }
                        }
                    });
                } else if (sector.type === "xdust9999") {
                    sectorElement.className = "sector xdust9999-sector";
                    sectorElement.style.left = `${sector.x}%`;
                    sectorElement.style.top = `${adjustedY}%`;
                    sectorElement.innerHTML = `
                        <div style="text-align:center; font-size:13px;">
                            <strong style="color:#ff2222; text-shadow:0 0 12px #ff2222;">${sector.name}</strong><br>
                            <span style="color:#ff5555;">${sector.description}</span><br>
                            <span style="color:#ff2222;">‚ö°${sector.resources}</span>
                        </div>
                    `;
                    sectorElement.style.boxShadow = "0 0 40px 12px #ff2222, 0 0 80px 24px #ff2222";
                    sectorElement.style.background = "radial-gradient(circle at 55% 60%, #ff3333 0%, #990000 70%, transparent 100%)";
                    sectorElement.style.border = "3px solid #ff2222";
                    sectorElement.style.animation = "xdust9999-glow 1.3s infinite alternate";
                    sectorElement.style.zIndex = 11;
                    let tail = document.createElement('div');
                    tail.style.position = 'absolute';
                    tail.style.left = '50%';
                    tail.style.top = '100%';
                    tail.style.transform = 'translateX(-50%)';
                    tail.style.width = '18px';
                    tail.style.height = '80px';
                    tail.style.background = 'linear-gradient(180deg, rgba(255,0,0,0.7) 0%, rgba(255,0,0,0.1) 100%)';
                    tail.style.borderRadius = '50% 50% 70% 70%/30% 30% 100% 100%';
                    tail.style.filter = 'blur(2.7px)';
                    tail.style.pointerEvents = 'none';
                    tail.style.zIndex = 10;
                    tail.style.opacity = "0.85";
                    tail.className = "xdust9999-tail";
                    sectorElement.appendChild(tail);
                    sectorElement.addEventListener('click', () => {
                        handleXDUSTEncounter(sector);
                    });
                } else if (sector.type === "xdust") {
                    sectorElement.className = "sector xdust-sector";
                    sectorElement.style.left = `${sector.x}%`;
                    sectorElement.style.top = `${adjustedY}%`;
                    sectorElement.innerHTML = `
                        <div style="text-align:center; font-size:13px;">
                            <strong style="color:#00ffff; text-shadow:0 0 14px #00ffff;">${sector.name}</strong><br>
                            <span style="color:#00ffff;">${sector.description}</span><br>
                            <span style="color:#00ffff;">‚ö°${sector.resources}</span>
                        </div>
                    `;
                    sectorElement.style.boxShadow = "0 0 40px 10px #00ffff, 0 0 80px 30px #00ffff";
                    sectorElement.style.background = "radial-gradient(circle at 50% 60%, #00ffff 0%, #005577 70%, transparent 100%)";
                    sectorElement.style.border = "3px solid #00ffff";
                    sectorElement.style.animation = "xdust-glow 1.7s infinite alternate";
                    sectorElement.style.zIndex = 12;
                    let ring = document.createElement('div');
                    ring.style.position = 'absolute';
                    ring.style.left = '-15%';
                    ring.style.top = '-15%';
                    ring.style.width = '130%';
                    ring.style.height = '130%';
                    ring.style.border = '2.5px solid #00ffff';
                    ring.style.borderRadius = '50%';
                    ring.style.opacity = '0.5';
                    ring.style.pointerEvents = 'none';
                    ring.style.animation = "xdust-ring 2.7s infinite linear";
                    ring.className = "xdust-ring";
                    sectorElement.appendChild(ring);
                    sectorElement.addEventListener('click', () => {
                        handleXDUSTEncounter(sector);
                    });
                } else {
                    sectorElement.className = `sector ${sector.type}`;
                    sectorElement.style.left = `${sector.x}%`;
                    sectorElement.style.top = `${adjustedY}%`;
                    sectorElement.innerHTML = `
                        <div style="text-align: center; font-size: 10px;">
                            <strong>${sector.name}</strong><br>
                            ‚ö°${sector.resources}
                        </div>
                    `;
                    sectorElement.addEventListener('click', () => {
                        if (sector.type === 'enemy' || sector.type === 'neutral') {
                            if (sector.type !== 'controlled') {
                                attemptCapture(sector.id, sector, () => {
                                    if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                        tg.showAlert(`‚úÖ –°–µ–∫—Ç–æ—Ä –∑–∞—Ö–≤–∞—á–µ–Ω! –ë–æ–Ω—É—Å: +${Math.floor((sector.resources||0)*0.1)} $XSDC`);
                                    } else {
                                        alert(`‚úÖ –°–µ–∫—Ç–æ—Ä –∑–∞—Ö–≤–∞—á–µ–Ω! –ë–æ–Ω—É—Å: +${Math.floor((sector.resources||0)*0.1)} $XSDC`);
                                    }
                                });
                            }
                        } else {
                            alert(`üöÄ –í—ã–±—Ä–∞–Ω —Å–µ–∫—Ç–æ—Ä: ${sector.name}\nüíé –†–µ—Å—É—Ä—Å—ã: ${sector.resources} XDUST`);
                        }
                        if (sector.type === 'enemy') {
                            createResourceStream(sector);
                        }
                    });
                }
                galaxyContainer.appendChild(sectorElement);
            });
            // –î–æ–±–∞–≤–∏–º CSS-–∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Å–µ–∫—Ç–æ—Ä–æ–≤ $XDUST-9999 –∏ $XDUST (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ)
            if (!document.getElementById('xdust9999-glow-style')) {
                const style = document.createElement('style');
                style.id = 'xdust9999-glow-style';
                style.innerHTML = `
                @keyframes xdust9999-glow {
                    0% { box-shadow: 0 0 40px 12px #ff2222, 0 0 80px 24px #ff2222; opacity:0.93;}
                    50% { box-shadow: 0 0 70px 25px #ff2222, 0 0 150px 60px #ff2222; opacity:1;}
                    100% { box-shadow: 0 0 40px 12px #ff2222, 0 0 80px 24px #ff2222; opacity:0.93;}
                }
                @keyframes xdust-glow {
                    0% { box-shadow: 0 0 40px 10px #00ffff, 0 0 80px 30px #00ffff; opacity:0.8;}
                    50% { box-shadow: 0 0 80px 25px #00ffff, 0 0 160px 60px #00ffff; opacity:1;}
                    100% { box-shadow: 0 0 40px 10px #00ffff, 0 0 80px 30px #00ffff; opacity:0.8;}
                }
                @keyframes xdust-ring {
                    0% { transform: scale(1); opacity: 0.5;}
                    70% { transform: scale(1.3); opacity: 0.9;}
                    100% { transform: scale(1.7); opacity: 0;}
                }
                `;
                document.head.appendChild(style);
            }
            if (!galaxyContainer.querySelector('.galaxy-star')) {
                createGalaxyStars();
            }
            if (!galaxyContainer._xdustAutoTransfer) {
                galaxyContainer._xdustAutoTransfer = setInterval(() => {
                    const filtered = sectors.filter(s => s.name !== "–°–ò–†–ò–£–°" && s.type !== "mission");
                    const randomSector = filtered[Math.floor(Math.random() * filtered.length)];
                    if (randomSector) {
                        createResourceStream(randomSector);
                    }
                }, 5000);
            }
        }

        // === –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏–π –Ω–∞ –≥–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç–µ ===
        // 1. –†–µ—Å—É—Ä—Å–Ω—ã–π –∞—Å—Ç–µ—Ä–æ–∏–¥
        function spawnResourceAsteroid(sectors, container) {
            const target = sectors[Math.floor(Math.random() * sectors.length)];
            const asteroid = document.createElement('div');
            asteroid.className = 'sector asteroid-event';
            asteroid.style.position = 'absolute';
            asteroid.style.left = `${target.x + (Math.random() * 10 - 5)}%`;
            asteroid.style.top = `${target.y + (Math.random() * 10 - 5)}%`;
            asteroid.style.width = '60px';
            asteroid.style.height = '60px';
            asteroid.style.background = 'radial-gradient(circle, #aaa 40%, #333 100%)';
            asteroid.style.border = '2px solid #ffaa00';
            asteroid.style.boxShadow = '0 0 20px #ffaa00, 0 0 60px #ffaa00';
            asteroid.style.zIndex = 100;
            asteroid.innerHTML = '<div style="text-align:center;font-size:10px;color:#ffaa00;">ü™® –ê–°–¢–ï–†–û–ò–î<br>+XDUST</div>';
            asteroid.addEventListener('click', () => {
                updateGalaxyResources(400 + Math.floor(Math.random() * 400));
                asteroid.remove();
                if (tg && tg.showAlert) tg.showAlert("ü™® –°–æ–±—Ä–∞–Ω —Ä–µ—Å—É—Ä—Å–Ω—ã–π –∞—Å—Ç–µ—Ä–æ–∏–¥!");
            });
            container.appendChild(asteroid);
            setTimeout(() => asteroid.remove(), 11000);
        }

        // 2. –í—Ä–∞–∂–µ—Å–∫–∏–π —Ä–µ–π–¥
        function enemyRaid(sectors, container) {
            const targets = sectors.filter(s => s.type === 'controlled');
            if (targets.length === 0) return;
            const target = targets[Math.floor(Math.random() * targets.length)];
            const raid = document.createElement('div');
            raid.className = 'sector raid-event';
            raid.style.position = 'absolute';
            raid.style.left = `${target.x}%`;
            raid.style.top = `${target.y}%`;
            raid.style.width = '68px';
            raid.style.height = '68px';
            raid.style.background = 'radial-gradient(circle, #ff2222 40%, #660000 100%)';
            raid.style.border = '2px dashed #ff2222';
            raid.style.boxShadow = '0 0 30px #ff2222';
            raid.style.zIndex = 110;
            raid.innerHTML = '<div style="text-align:center;font-size:10px;color:#fff;">‚öîÔ∏è –†–ï–ô–î<br>-XDUST</div>';
            raid.addEventListener('click', () => {
                updateGalaxyResources(-250 - Math.floor(Math.random() * 200));
                raid.remove();
                if (tg && tg.showAlert) tg.showAlert("‚öîÔ∏è –û—Ç—Ä–∞–∂—ë–Ω –≤—Ä–∞–∂–µ—Å–∫–∏–π —Ä–µ–π–¥!");
            });
            container.appendChild(raid);
            setTimeout(() => raid.remove(), 9000);
        }

        // 3. –¢–æ—Ä–≥–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        function offerTrade(sectors, container) {
            const target = sectors[Math.floor(Math.random() * sectors.length)];
            const trade = document.createElement('div');
            trade.className = 'sector trade-event';
            trade.style.position = 'absolute';
            trade.style.left = `${target.x + (Math.random() * 8 - 4)}%`;
            trade.style.top = `${target.y + (Math.random() * 8 - 4)}%`;
            trade.style.width = '56px';
            trade.style.height = '56px';
            trade.style.background = 'radial-gradient(circle, #00ffaa 40%, #006666 100%)';
            trade.style.border = '2px solid #00ffaa';
            trade.style.boxShadow = '0 0 20px #00ffaa';
            trade.style.zIndex = 120;
            trade.innerHTML = '<div style="text-align:center;font-size:10px;color:#00ffaa;">ü§ù –¢–û–†–ì–û–í–õ–Ø<br>+/-XDUST</div>';
            trade.addEventListener('click', () => {
                const gain = Math.random() < 0.5 ? 200 : -150;
                updateGalaxyResources(gain);
                trade.remove();
                if (tg && tg.showAlert) tg.showAlert(gain > 0 ? "ü§ù –£–¥–∞—á–Ω–∞—è —Å–¥–µ–ª–∫–∞!" : "ü§ù –ù–µ—É–¥–∞—á–Ω–∞—è —Å–¥–µ–ª–∫–∞!");
            });
            container.appendChild(trade);
            setTimeout(() => trade.remove(), 8000);
        }

        // 4. –°–∏–≥–Ω–∞–ª –±–µ–¥—Å—Ç–≤–∏—è
        function triggerDistressSignal(sectors, container) {
            const target = sectors[Math.floor(Math.random() * sectors.length)];
            const distress = document.createElement('div');
            distress.className = 'sector distress-event';
            distress.style.position = 'absolute';
            distress.style.left = `${target.x + (Math.random() * 7 - 3)}%`;
            distress.style.top = `${target.y + (Math.random() * 7 - 3)}%`;
            distress.style.width = '50px';
            distress.style.height = '50px';
            distress.style.background = 'radial-gradient(circle, #ff00ff 40%, #330044 100%)';
            distress.style.border = '2px solid #ff00ff';
            distress.style.boxShadow = '0 0 18px #ff00ff';
            distress.style.zIndex = 130;
            distress.innerHTML = '<div style="text-align:center;font-size:10px;color:#ff00ff;">üÜò –°–ò–ì–ù–ê–õ<br>+/-XDUST</div>';
            distress.addEventListener('click', () => {
                const gain = Math.random() < 0.7 ? 150 : -120;
                updateGalaxyResources(gain);
                distress.remove();
                if (tg && tg.showAlert) tg.showAlert(gain > 0 ? "üÜò –°–ø–∞—Å—ë–Ω –∫–æ—Ä–∞–±–ª—å!" : "üÜò –ö–æ—Ä–∞–±–ª—å –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–ø–∞—Å—Ç–∏!");
            });
            container.appendChild(distress);
            setTimeout(() => distress.remove(), 7000);
        }

        // 5. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –æ–±–æ—Ä–æ–Ω—É
        function buildDefense(sectors, container) {
            const target = sectors.filter(s => s.type === 'controlled')[Math.floor(Math.random() * sectors.filter(s => s.type === 'controlled').length)];
            if (!target) return;
            const defense = document.createElement('div');
            defense.className = 'sector defense-event';
            defense.style.position = 'absolute';
            defense.style.left = `${target.x}%`;
            defense.style.top = `${target.y}%`;
            defense.style.width = '58px';
            defense.style.height = '58px';
            defense.style.background = 'radial-gradient(circle, #00aaff 40%, #003355 100%)';
            defense.style.border = '2px solid #00aaff';
            defense.style.boxShadow = '0 0 18px #00aaff';
            defense.style.zIndex = 140;
            defense.innerHTML = '<div style="text-align:center;font-size:10px;color:#00aaff;">üõ°Ô∏è –û–ë–û–†–û–ù–ê<br>-–≠–ù–ï–†–ì–ò–Ø</div>';
            defense.addEventListener('click', () => {
                if (currentEnergy > 300) {
                    currentEnergy -= 300;
                    displayResources();
                    saveDataAll();
                    if (tg && tg.showAlert) tg.showAlert("üõ°Ô∏è –û–±–æ—Ä–æ–Ω–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞!");
                } else {
                    if (tg && tg.showAlert) tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –æ–±–æ—Ä–æ–Ω—ã!");
                }
                defense.remove();
            });
            container.appendChild(defense);
            setTimeout(() => defense.remove(), 9000);
        }

        // 6. –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ —Å–µ–∫—Ç–æ—Ä–∞—Ö (–ø—Ä–∏–º–µ—Ä)
        function produceSectorResources(sectors) {
            sectors.forEach(sector => {
                if (sector.type === 'controlled') {
                    sector.resources += Math.floor(Math.random() * 15 + 5);
                }
            });
        }

        // 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–±–ª–∞–≥–æ—Å–æ—Å—Ç–æ—è–Ω–∏—è" —Å–µ–∫—Ç–æ—Ä–∞ (–ø—Ä–∏–º–µ—Ä)
        function updateSectorProsperity(sectors) {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ > 3000
            sectors.forEach(sector => {
                if (sector.resources > 3000 && sector.type === 'controlled') {
                    // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç –∏–ª–∏ –±–æ–Ω—É—Å
                }
            });
        }

        // 8. –ü–æ–ª—É—á–∏—Ç—å –º–∞—Å—Å–∏–≤ —Å–µ–∫—Ç–æ—Ä–æ–≤ (—Ä–∞—Å—à–∏—Ä—è–µ–º—ã–π)
        function getGalaxySectors() {
            const baseSectors = [
                { id: 1, x: 15, y: 20, name: "–°–ò–†–ò–£–°", type: "controlled", resources: 2000 },
                { id: 2, x: 25, y: 60, name: "–ê–õ–¨–§–ê –¶–ï–ù–¢–ê–í–†–ê", type: "enemy", resources: 1500 },
                { id: 3, x: 50, y: 30, name: "–ë–ï–¢–ï–õ–¨–ì–ï–ô–ó–ï", type: "neutral", resources: 800 },
                { id: 4, x: 70, y: 50, name: "–ü–†–û–¶–ò–û–ù", type: "controlled", resources: 1200 },
                { id: 5, x: 40, y: 70, name: "–í–ï–ì–ê", type: "enemy", resources: 1800 },
                { id: 6, x: 60, y: 20, name: "–ê–†–ö–¢–£–†", type: "neutral", resources: 600 },
                { id: 7, x: 80, y: 40, name: "–†–ò–ì–ï–õ–¨", type: "controlled", resources: 2500 },
                {
                    id: 9001,
                    x: 55, y: 80,
                    name: "$XDUST-9001",
                    type: "mission",
                    resources: 9001,
                    locked: currentEnergy < 3000,
                    requiredEnergy: 3000
                }
            ];
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞
            baseSectors.push({
                id: 9999,
                x: 75,
                y: 85,
                name: "$XDUST-9999",
                type: "xdust9999",
                resources: 9999,
                description: "–°–ï–ö–†–ï–¢–ù–´–ô –°–ï–ö–¢–û–†",
            });
            baseSectors.push({
                id: 7777,
                x: 30,
                y: 88,
                name: "$XDUST",
                type: "xdust",
                resources: 7777,
                description: "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–µ–∫—Ç–æ—Ä XDUST",
                visited: false
            });
            return baseSectors;
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—Ç–æ–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å –°–∏—Ä–∏—É—Å–∞
        function createResourceStream(targetSector) {
            const sectors = [
                { id: 1, x: 15, y: 20, name: "–°–ò–†–ò–£–°", type: "controlled", resources: 2000 },
                { id: 2, x: 25, y: 60, name: "–ê–õ–¨–§–ê –¶–ï–ù–¢–ê–í–†–ê", type: "enemy", resources: 1500 },
                { id: 3, x: 50, y: 30, name: "–ë–ï–¢–ï–õ–¨–ì–ï–ô–ó–ï", type: "neutral", resources: 800 },
                { id: 4, x: 70, y: 50, name: "–ü–†–û–¶–ò–û–ù", type: "controlled", resources: 1200 },
                { id: 5, x: 40, y: 70, name: "–í–ï–ì–ê", type: "enemy", resources: 1800 },
                { id: 6, x: 60, y: 20, name: "–ê–†–ö–¢–£–†", type: "neutral", resources: 600 },
                { id: 7, x: 80, y: 40, name: "–†–ò–ì–ï–õ–¨", type: "controlled", resources: 2500 }
            ];
            
            const sirius = sectors.find(s => s.name === "–°–ò–†–ò–£–°");
            const stream = document.createElement('div');
            stream.style.position = 'absolute';
            stream.style.left = `${sirius.x}%`;
            stream.style.top = `${sirius.y}%`;
            stream.style.width = '4px';
            stream.style.height = '4px';
            stream.style.background = '#00ffff';
            stream.style.borderRadius = '50%';
            stream.style.boxShadow = '0 0 10px #00ffff';
            document.getElementById('galaxyContainer').appendChild(stream);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
            const animation = stream.animate([
                {
                    left: `${sirius.x}%`,
                    top: `${sirius.y}%`,
                    opacity: 1
                },
                {
                    left: `${targetSector.x}%`,
                    top: `${targetSector.y}%`,
                    opacity: 0
                }
            ], {
                duration: 2000,
                easing: 'ease-out'
            });
            
            animation.onfinish = () => {
                stream.remove();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
                updateGalaxyResources(targetSector.resources * 0.3);
            };
        }

        function updateGalaxyResources(amount) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å–æ–≤
            currentEnergy += amount;
            currentMetals += amount * 0.7;
            currentCrystals += amount * 0.3;
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –≤–∫–ª—é—á–∞—è $XSDC
            displayResources();
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ $XSDC
            saveDataAll();
            // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
            document.body.style.animation = 'glow 0.5s';
            setTimeout(() => {
                document.body.style.animation = '';
            }, 500);
        }

        // === $XDUST-9001 –ú–ï–ì–ê-–ú–ò–°–°–ò–Ø: –í–ò–ó–£–ê–õ–¨–ù–ê–Ø –ù–ê–ì–†–ê–î–ê –ò –ú–ï–ì–ê–†–ï–°–£–†–°–´ ===
        function rewardXDUST9001Resources(targetSector) {
            const galaxyContainer = document.getElementById('galaxyContainer');
            const sirius = { x: 15, y: 20 }; // Sirius coordinates on map

            const rewards = [
                { type: 'energy', amount: currentEnergy },
                { type: 'metals', amount: currentMetals },
                { type: 'crystals', amount: currentCrystals }
            ];

            rewards.forEach(reward => {
                const stream = document.createElement('div');
                stream.style.position = 'absolute';
                stream.style.left = `${sirius.x}%`;
                stream.style.top = `${sirius.y}%`;
                stream.style.width = '6px';
                stream.style.height = '6px';
                stream.style.background = reward.type === 'energy' ? '#00ffff' :
                                         reward.type === 'metals' ? '#ffaa00' : '#ff00ff';
                stream.style.borderRadius = '50%';
                stream.style.boxShadow = `0 0 12px ${stream.style.background}`;
                galaxyContainer.appendChild(stream);

                const anim = stream.animate([
                    { left: `${sirius.x}%`, top: `${sirius.y}%`, opacity: 1 },
                    { left: `${targetSector.x}%`, top: `${targetSector.y}%`, opacity: 0 }
                ], {
                    duration: 2000,
                    easing: 'ease-out'
                });

                anim.onfinish = () => {
                    stream.remove();
                    switch (reward.type) {
                        case 'energy': currentEnergy += reward.amount; break;
                        case 'metals': currentMetals += reward.amount; break;
                        case 'crystals': currentCrystals += reward.amount; break;
                    }
                    displayResources();
                    saveDataAll();
                };
            });
        }

        function handleXDUST9001Click(isUnlocked, requiredEnergy) {
            if (!isUnlocked) {
                if (tg && tg.showAlert) {
                    tg.showAlert(`üîí –ú–∏—Å—Å–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!\n–¢—Ä–µ–±—É–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è: ${requiredEnergy}`);
                } else {
                    alert(`üîí –ú–∏—Å—Å–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!\n–¢—Ä–µ–±—É–µ—Ç—Å—è —ç–Ω–µ—Ä–≥–∏—è: ${requiredEnergy}`);
                }
                return;
            }

            if (tg && tg.showAlert) {
                tg.showAlert('üöÄ –ú–ï–ì–ê-–ú–ò–°–°–ò–Ø $XDUST-9001 –ó–ê–ü–£–©–ï–ù–ê!\n–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫...');
            } else {
                alert('üöÄ –ú–ï–ì–ê-–ú–ò–°–°–ò–Ø $XDUST-9001 –ó–ê–ü–£–©–ï–ù–ê!\n–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫...');
            }

            const galaxyContainer = document.getElementById('galaxyContainer');
            const burst = document.createElement('div');
            burst.style.position = 'absolute';
            burst.style.left = '50%';
            burst.style.top = '50%';
            burst.style.width = '200px';
            burst.style.height = '200px';
            burst.style.borderRadius = '50%';
            burst.style.background = 'radial-gradient(circle, rgba(255,0,255,0.6), transparent 70%)';
            burst.style.transform = 'translate(-50%, -50%)';
            burst.style.animation = 'burstFade 2s ease-out forwards';
            galaxyContainer.appendChild(burst);
            setTimeout(() => burst.remove(), 2000);

            setTimeout(() => {
                const sector = { type: 'mission', resources: 9001, x: 55, y: 80 };
                sector.type = 'controlled';

                rewardXDUST9001Resources(sector);

                const xsdcReward = 5000;
                currentXSDC += xsdcReward;
                displayResources();
                saveDataAll();

                if (tg && tg.showAlert) {
                    tg.showAlert(`‚úÖ –ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–æ–ª—É—á–µ–Ω–æ +${xsdcReward} $XSDC`);
                } else {
                    alert(`‚úÖ –ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–æ–ª—É—á–µ–Ω–æ +${xsdcReward} $XSDC`);
                }

                initGalaxyMap();
            }, 5000);
        }

        function createGalaxyStars() {
            const galaxyContainer = document.getElementById('galaxyContainer');
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.style.position = 'absolute';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 2 + 1}px`;
                star.style.height = star.style.width;
                star.style.background = 'white';
                star.style.borderRadius = '50%';
                star.style.opacity = Math.random() * 0.7 + 0.3;
                star.style.animation = `twinkle ${Math.random() * 3 + 2}s infinite alternate`;
                galaxyContainer.appendChild(star);
            }
        }

        // === –ö–û–°–ú–ò–ß–ï–°–ö–ò–ô –®–£–¢–ï–† ===
        // === –ó–í–£–ö–ò: –ü–£–õ –î–õ–Ø –ë–ï–ó–õ–ê–ì–û–í–û–ô –ò–ì–†–´ ===
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        const shootSounds = [
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/shoot.ogg'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/shoot.mp3'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/shoot.m4a')
        ];
        const explosionSounds = [
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/explosion.ogg'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/explosion.mp3'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/explosion.m4a')
        ];
        const powerupSounds = [
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/powerup.ogg'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/powerup.mp3'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/powerup.m4a')
        ];

        const backgroundMusic = new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/melody.mp3');
        backgroundMusic.loop = true;
        backgroundMusic.volume = 0.5;

        // === –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –¥–ª—è –∫–∞—Ä—Ç—ã ===
        const galaxyMusic = new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/map.mp3');
        galaxyMusic.loop = true;
        galaxyMusic.volume = 0.4;
        galaxyMusic.load();

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º—É–∑—ã–∫–æ–π –∫–∞—Ä—Ç—ã
        function playGalaxyMusic() {
            if (galaxyMusic.paused) {
                galaxyMusic.play().catch(e => console.warn("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏ –∫–∞—Ä—Ç—ã:", e));
            }
        }

        function pauseGalaxyMusic() {
            if (!galaxyMusic.paused) {
                galaxyMusic.pause();
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫/–ø–∞—É–∑–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–æ–≤
        function switchToMapMode() {
            playGalaxyMusic();
            // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
        }

        function leaveMapMode() {
            pauseGalaxyMusic();
        }

        let shootIndex = 0;
        let explosionIndex = 0;
        let powerupIndex = 0;

        // === Web Audio API –¥–ª—è –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Å—Ç—Ä–µ–ª–∞ ===
        let audioContext = null;
        let shootBuffer = null;
        let isAudioLoaded = false;
        let fireIntensity = 0;
        const MAX_INTENSITY = 1.0;
        const shootSoundPath = "https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/shoot.ogg";

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞ –¥–ª—è Web Audio API
        function initAudio() {
            if (isAudioLoaded) return;
            try {
                audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                // –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞—É–¥–∏–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç
                return;
            }
            fetch(shootSoundPath)
                .then(r => r.arrayBuffer())
                .then(b => audioContext.decodeAudioData(b))
                .then(buffer => {
                    shootBuffer = buffer;
                    isAudioLoaded = true;
                });
        }

        function playShoot() {
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Web Audio API, –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
            if (audioContext && shootBuffer && isAudioLoaded) {
                try {
                    const src = audioContext.createBufferSource();
                    src.buffer = shootBuffer;
                    // –ú–æ—Ä—Ñ–∏–Ω–≥: –º–µ–Ω—è–µ–º playbackRate –∏ –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç fireIntensity
                    let morph = Math.min(1, Math.max(0, fireIntensity / MAX_INTENSITY));
                    src.playbackRate.value = 1.0 + morph * 0.25 + (Math.random() - 0.5) * 0.05;
                    const gain = audioContext.createGain();
                    gain.gain.value = 0.4 + morph * 0.4;
                    src.connect(gain).connect(audioContext.destination);
                    // –ì—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å: –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–µ–∑ —Å –Ω–µ–±–æ–ª—å—à–∏–º —Å–º–µ—â–µ–Ω–∏–µ–º
                    const duration = Math.max(0.08, 0.12 + morph * 0.04);
                    const offset = Math.random() * (shootBuffer.duration - duration - 0.01);
                    src.start(0, offset, duration);
                } catch (e) {
                    // fallback
                    const s = shootSounds[shootIndex];
                    s.currentTime = 0;
                    s.play().catch(() => {});
                    shootIndex = (shootIndex + 1) % shootSounds.length;
                }
            } else {
                // fallback
                const s = shootSounds[shootIndex];
                s.currentTime = 0;
                s.play().catch(() => {});
                shootIndex = (shootIndex + 1) % shootSounds.length;
            }
        }

        function playExplosion() {
            const s = explosionSounds[explosionIndex];
            s.currentTime = 0;
            s.play().catch(() => {});
            explosionIndex = (explosionIndex + 1) % explosionSounds.length;
        }

        function playPowerup() {
            const s = powerupSounds[powerupIndex];
            s.currentTime = 0;
            s.play().catch(() => {});
            powerupIndex = (powerupIndex + 1) % powerupSounds.length;
        }

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–æ–≤
        function preloadSounds() {
            [...shootSounds, ...explosionSounds, ...powerupSounds].forEach(sound => {
                sound.load();
                sound.volume = 0.7;
            });
            backgroundMusic.load();
        }

        // Telegram WebApp
        let tg = window.Telegram?.WebApp;
        if (tg) { tg.expand(); tg.ready(); }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // –ó–≤—ë–∑–¥–Ω—ã–π —Ñ–æ–Ω
        function createStars() {
            const starsContainer = document.getElementById('stars');
            starsContainer.innerHTML = '';
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 2;
                star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`; star.style.top = `${Math.random() * 100}%`;
                star.style.opacity = 0.5 + Math.random() * 0.5;
                star.style.animationDelay = `${Math.random() * 2}s`;
                starsContainer.appendChild(star);
            }
        }
        createStars();

        // –ê–¥–∞–ø—Ç–∏–≤ canvas
        function resizeCanvas() {
            const maxWidth = window.innerWidth - 20;
            const maxHeight = window.innerHeight - 20;
            const aspectRatio = 3 / 4;
            if (maxWidth / maxHeight > aspectRatio) {
                canvas.height = maxHeight;
                canvas.width = maxHeight * aspectRatio;
            } else {
                canvas.width = maxWidth;
                canvas.height = maxWidth / aspectRatio;
            }
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let gameRunning = false;
        let score = 0;
        let lives = 3;
        let animationId;
        let lastShot = 0;
        let shootCooldown = 250;

        const player = { x: canvas.width / 2 - 20, y: canvas.height - 60, width: 40, height: 40, speed: 5, dx: 0, isDamaged: false, damageTime: 0, flashTime: 0 };
        let bullets = [], enemies = [], stars = [], particles = [], powerUps = [];
        let enemySpawnRate = 0.03;
        let lastSpawnIncrease = Date.now();
        let bossTimer = Date.now();
        let bossInterval = 45000;
        let bossActive = false;
        let boss = null;
        let shieldActive = false;
        let megaShieldStage = 0;
        let megaShieldEnd = 0;
        let speedBoostEnd = 0;
        let laserModeEnd = 0;

        function createGameStars() {
            stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2 + 0.5, speed: Math.random() * 1.5 + 0.5, opacity: 0.5 + Math.random() * 0.5 });
            }
        }
        createGameStars();

        function createParticles(x, y, color = null, count = 12) {
            for (let i = 0; i < count; i++) {
                const colors = color ? [color] : ['#ff0000', '#ff8800', '#ffff00'];
                particles.push({ x, y, vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 0.5) * 8, life: 30 + Math.random() * 20, size: 3 + Math.random() * 2, color: colors[Math.floor(Math.random() * colors.length)] });
            }
            playExplosion();
        }

        function createPowerUp(x, y, forcedType = null) {
            if (forcedType) {
                powerUps.push({ x: x - 10, y: y - 10, width: 24, height: 24, speed: 2, type: forcedType });
                return;
            }
            if (Math.random() < 0.3) {
                const types = ['shield', 'speed', 'laser'];
                powerUps.push({ x: x - 10, y: y - 10, width: 20, height: 20, speed: 2, type: types[Math.floor(Math.random() * types.length)] });
            }
        }

        function applyPowerUp(type) {
            playPowerup();
            player.flashTime = Date.now() + 300;
            switch(type) {
                case 'shield': shieldActive = true; setTimeout(() => { shieldActive = false; }, 10000); break;
                case 'speed': speedBoostEnd = Date.now() + 10000; break;
                case 'laser': laserModeEnd = Date.now() + 10000; break;
                case 'megaShield': megaShieldStage = 2; megaShieldEnd = Date.now() + 15000; break;
            }
        }

        // === –†–ò–°–û–í–ê–ù–ò–ï (–í–°–Å –ü–û–õ–ù–û–°–¢–¨–Æ) ===
        function drawPlayer() {
            ctx.save();
            let blink = false;
            if (player.isDamaged && Date.now() - player.damageTime < 1000) {
                blink = Math.floor((Date.now() - player.damageTime) / 60) % 2 === 0;
                ctx.globalAlpha = blink ? 0.2 : 1;
            }
            if (player.flashTime && Date.now() < player.flashTime) {
                ctx.save();
                ctx.globalAlpha = 0.7 * (1 - (player.flashTime - Date.now()) / 300);
                ctx.beginPath();
                ctx.arc(player.x + player.width/2, player.y + player.height/2, player.width * 1.2, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.shadowBlur = 50;
                ctx.shadowColor = '#fff';
                ctx.fill();
                ctx.restore();
            }
            const gradient = ctx.createLinearGradient(player.x, player.y, player.x, player.y + player.height);
            gradient.addColorStop(0, '#00ffff');
            gradient.addColorStop(1, '#0088ff');
            ctx.fillStyle = gradient;
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#00ffff';
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.lineTo(player.x + player.width / 2, player.y + player.height - 10);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ff00ff';
            ctx.shadowColor = '#ff00ff';
            ctx.beginPath();
            ctx.moveTo(player.x + 5, player.y + player.height - 15);
            ctx.lineTo(player.x + 10, player.y + player.height);
            ctx.lineTo(player.x + 15, player.y + player.height - 15);
            ctx.closePath();
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(player.x + 25, player.y + player.height - 15);
            ctx.lineTo(player.x + 30, player.y + player.height);
            ctx.lineTo(player.x + 35, player.y + player.height - 15);
            ctx.closePath();
            ctx.fill();
            const flameHeight = 10 + Math.random() * 10;
            const flameGradient = ctx.createLinearGradient(0, 0, 0, flameHeight);
            flameGradient.addColorStop(0, '#ffff00');
            flameGradient.addColorStop(1, '#ff8800');
            ctx.fillStyle = flameGradient;
            ctx.shadowColor = '#ffff00';
            ctx.beginPath();
            ctx.moveTo(player.x + 7, player.y + player.height);
            ctx.lineTo(player.x + 13, player.y + player.height);
            ctx.lineTo(player.x + 10, player.y + player.height + flameHeight);
            ctx.closePath();
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(player.x + 27, player.y + player.height);
            ctx.lineTo(player.x + 33, player.y + player.height);
            ctx.lineTo(player.x + 30, player.y + player.height + flameHeight);
            ctx.closePath();
            ctx.fill();

            // --- –≠–§–§–ï–ö–¢ –î–´–ú–ê/–ö–û–°–ú–ò–ß–ï–°–ö–û–ì–û –°–õ–ï–î–ê ---
            for (let i = 0; i < 3; i++) {
                particles.push({
                    x: player.x + player.width/2 + (Math.random()*12 - 6),
                    y: player.y + player.height + 4,
                    vx: (Math.random() - 0.5) * 0.6,
                    vy: Math.random() * 2 + 1.5,
                    life: 12 + Math.random() * 6,
                    size: 1.5 + Math.random() * 1.5,
                    color: 'rgba(255,180,60,0.85)'
                });
            }
            if (megaShieldStage > 0 && Date.now() < megaShieldEnd) {
                ctx.save();
                ctx.beginPath();
                ctx.ellipse(player.x + player.width / 2, player.y + player.height / 2, player.width / 1.25, player.height / 1.05, 0, 0, Math.PI * 2);
                ctx.strokeStyle = megaShieldStage === 2 ? '#00ccff' : '#00ff00';
                ctx.lineWidth = 6;
                ctx.shadowColor = megaShieldStage === 2 ? '#00ccff' : '#00ff00';
                ctx.shadowBlur = 35;
                ctx.globalAlpha = 0.7;
                ctx.stroke();
                ctx.beginPath();
                ctx.ellipse(player.x + player.width / 2, player.y + player.height / 2, player.width / 1.7, player.height / 1.45, 0, 0, Math.PI * 2);
                ctx.strokeStyle = megaShieldStage === 2 ? '#00ff00' : '#0055ff';
                ctx.lineWidth = 3;
                ctx.shadowColor = megaShieldStage === 2 ? '#00ff00' : '#0055ff';
                ctx.shadowBlur = 18;
                ctx.globalAlpha = 0.5;
                ctx.stroke();
                ctx.restore();
            } else if (shieldActive) {
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.ellipse(player.x + player.width / 2, player.y + player.height / 2, player.width / 1.5, player.height / 1.2, 0, 0, Math.PI * 2);
                ctx.stroke();
            }
            ctx.restore();
            ctx.globalAlpha = 1;
        }

        function drawBullet(bullet) {
            ctx.save();
            const isLaser = Date.now() < laserModeEnd;
            ctx.fillStyle = isLaser ? '#ff00ff' : '#ffff00';
            ctx.shadowBlur = isLaser ? 15 : 10;
            ctx.shadowColor = isLaser ? '#ff00ff' : '#ffff00';
            const width = isLaser ? 8 : 4;
            const height = isLaser ? 20 : 12;
            ctx.beginPath();
            ctx.moveTo(bullet.x, bullet.y + height);
            ctx.lineTo(bullet.x + width, bullet.y + height);
            ctx.lineTo(bullet.x + width / 2, bullet.y);
            ctx.closePath();
            ctx.fill();
            if (isLaser) {
                const trailGradient = ctx.createLinearGradient(bullet.x + width / 2, bullet.y + height, bullet.x + width / 2, bullet.y + height + 10);
                trailGradient.addColorStop(0, 'rgba(255, 0, 255, 0.8)');
                trailGradient.addColorStop(1, 'rgba(255, 0, 255, 0)');
                ctx.fillStyle = trailGradient;
                ctx.fillRect(bullet.x, bullet.y + height, width, 10);
            }
            ctx.restore();
        }

        function drawEnemy(enemy) {
            ctx.save();
            const gradient = ctx.createLinearGradient(enemy.x, enemy.y, enemy.x, enemy.y + enemy.height);
            gradient.addColorStop(0, '#ff3232');
            gradient.addColorStop(1, '#880000');
            ctx.fillStyle = gradient;
            ctx.shadowBlur = 12;
            ctx.shadowColor = '#ff3232';
            ctx.beginPath();
            ctx.moveTo(enemy.x + enemy.width / 2, enemy.y + enemy.height);
            ctx.lineTo(enemy.x, enemy.y);
            ctx.lineTo(enemy.x + enemy.width / 2, enemy.y + 12);
            ctx.lineTo(enemy.x + enemy.width, enemy.y);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ff9999';
            ctx.beginPath();
            ctx.arc(enemy.x + 10, enemy.y + 10, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(enemy.x + enemy.width - 10, enemy.y + 10, 5, 0, Math.PI * 2);
            ctx.fill();
            const flameHeight = 3 + Math.random() * 3;
            ctx.fillStyle = '#ffff00';
            ctx.shadowColor = '#ffff00';
            ctx.fillRect(enemy.x + 5, enemy.y - flameHeight, 5, flameHeight);
            ctx.fillRect(enemy.x + enemy.width - 10, enemy.y - flameHeight, 5, flameHeight);
            ctx.restore();
        }

        function drawPowerUp(powerUp) {
            ctx.save();
            let color, symbol;
            switch(powerUp.type) {
                case 'shield': color = '#00aaff'; symbol = 'S'; break;
                case 'speed': color = '#00ff00'; symbol = 'P'; break;
                case 'laser': color = '#ffaa00'; symbol = 'L'; break;
                case 'megaShield': color = '#00ccff'; symbol = 'M'; break;
            }
            const gradient = ctx.createRadialGradient(powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, 0, powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, powerUp.width/2);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(1, color);
            ctx.fillStyle = gradient;
            ctx.shadowBlur = 18;
            ctx.shadowColor = color;
            ctx.beginPath();
            ctx.arc(powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, powerUp.width/2, 0, Math.PI * 2);
            ctx.fill();
            ctx.font = 'bold 14px Orbitron';
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(symbol, powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2);
            ctx.restore();
        }

        function drawBoss(bossObj) {
            ctx.save();
            ctx.shadowBlur = 30;
            ctx.shadowColor = '#ff00cc';
            ctx.fillStyle = '#ff0055';
            ctx.beginPath();
            ctx.moveTo(bossObj.x + bossObj.width/2, bossObj.y);
            ctx.lineTo(bossObj.x, bossObj.y + bossObj.height);
            ctx.lineTo(bossObj.x + bossObj.width/2, bossObj.y + bossObj.height - 20);
            ctx.lineTo(bossObj.x + bossObj.width, bossObj.y + bossObj.height);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(bossObj.x + 20, bossObj.y + 30, 8, 0, Math.PI*2);
            ctx.arc(bossObj.x + bossObj.width - 20, bossObj.y + 30, 8, 0, Math.PI*2);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.globalAlpha = 0.8;
            ctx.fillStyle = '#222';
            ctx.fillRect(bossObj.x + 10, bossObj.y + bossObj.height + 4, bossObj.width - 20, 10);
            ctx.fillStyle = '#00ffcc';
            ctx.fillRect(bossObj.x + 10, bossObj.y + bossObj.height + 4, (bossObj.width - 20) * (bossObj.hp/bossObj.maxhp), 10);
            ctx.globalAlpha = 1;
            ctx.restore();
        }

        function drawStars() {
            ctx.fillStyle = '#ffffff';
            stars.forEach(star => {
                ctx.globalAlpha = star.opacity;
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });
            ctx.globalAlpha = 1;
        }

        function drawParticles() {
            particles.forEach((p, i) => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 50;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }


        function movePlayer() {
            const currentSpeed = Date.now() < speedBoostEnd ? player.speed * 1.5 : player.speed;
            player.x += player.dx;
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
        }

        function shoot() {
            const now = Date.now();
            if (now - lastShot > shootCooldown) {
                const isLaser = now < laserModeEnd;
                bullets.push({
                    x: player.x + player.width / 2 - (isLaser ? 4 : 2),
                    y: player.y,
                    width: isLaser ? 8 : 4,
                    height: isLaser ? 20 : 12,
                    speed: isLaser ? 12 : 8
                });
                lastShot = now;
                playShoot();

                // --- Overheat effect ---
                fireIntensity += 0.1;
                if (fireIntensity > MAX_INTENSITY) fireIntensity = MAX_INTENSITY;
                applyOverheatEffect(fireIntensity);
            }
        }


        function spawnEnemy() {
            if (Date.now() - lastSpawnIncrease > 15000) {
                enemySpawnRate = Math.min(enemySpawnRate + 0.005, 0.1);
                lastSpawnIncrease = Date.now();
            }
            if (Math.random() < enemySpawnRate) {
                const size = 30 + Math.random() * 10;
                enemies.push({
                    x: Math.random() * (canvas.width - size),
                    y: -size,
                    width: size,
                    height: size,
                    speed: 1.5 + Math.random() * 1.5,
                    type: 'normal'
                });
            }
            // –ö–æ–¥–æ–≤—ã–π –î—Ä–æ–Ω (Code Drone) ‚Äî 1% —à–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è
            if (Math.random() < 0.01) { // 1% —à–∞–Ω—Å –Ω–∞ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ö–æ–¥–æ–≤–æ–≥–æ –î—Ä–æ–Ω–∞
                const size = 30;
                enemies.push({
                    x: Math.random() * (canvas.width - size),
                    y: -size,
                    width: size,
                    height: size,
                    speed: 3 + Math.random(),
                    type: 'code-drone'
                });
            }
            if (!bossActive && Date.now() - bossTimer > bossInterval) {
                bossActive = true;
                boss = {
                    x: canvas.width / 2 - 40,
                    y: -90,
                    width: 80,
                    height: 80,
                    speed: 1,
                    hp: 10,
                    maxhp: 10,
                    type: 'boss',
                    shootCooldown: 2000,
                    lastShot: 0
                };
            }
        }

        // === Code Drone movement & destruction ===
        function updateCodeDrone(drone, time) {
            drone.x += Math.sin(time / 200) * 1.5 * timeDilationFactor;
            drone.y += 1.2 * timeDilationFactor;

            if (!drone.nextGlitch || Date.now() > drone.nextGlitch) {
                drone.nextGlitch = Date.now() + 2500 + Math.random() * 1000;
                setTimeout(() => {
                    drone.x += (Math.random() - 0.5) * 120;
                    drone.y += (Math.random() - 0.5) * 60;

                    // --- –ù–ï –í–´–ü–ê–î–ê–¢–¨ –ó–ê –ì–†–ê–ù–ò–¶–´ ---
                    drone.x = Math.max(0, Math.min(canvas.width - drone.width, drone.x));
                    drone.y = Math.max(0, Math.min(canvas.height - drone.height, drone.y));
                    // ------------------------------

                    createVisualGlitch(drone.x, drone.y);
                }, 100);
            }
        }

        function destroyCodeDrone(drone) {
            createCodeExplosion(drone.x, drone.y);
            timeDilationFactor = 0.4;
            setTimeout(() => timeDilationFactor = 1.0, 2000);
        }
        // === Boss Shooting Logic ===
        function bossShoot() {
            if (!bossActive || !boss) return;
            const now = Date.now();
            if (now - boss.lastShot > boss.shootCooldown) {
                const centerX = boss.x + boss.width / 2;
                const centerY = boss.y + boss.height;

                // –í–µ–µ—Ä –∏–∑ 9 –ø—É–ª—å, —É–≥–ª—ã –æ—Ç -60 –¥–æ +60 –≥—Ä–∞–¥—É—Å–æ–≤
                const angles = [-Math.PI/3, -Math.PI/4, -Math.PI/6, -Math.PI/12, 0, Math.PI/12, Math.PI/6, Math.PI/4, Math.PI/3];
                angles.forEach(angle => {
                    bullets.push({
                        x: centerX - 4,
                        y: centerY,
                        width: 8,
                        height: 12,
                        speed: 5,
                        angle: angle,
                        isEnemy: true
                    });
                });

                boss.lastShot = now;
            }
        }


        // === Time Dilation –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        let timeDilationFactor = 1.0;
        let timeDilationMax = 0.5; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–º–µ–¥–ª–µ–Ω–∏–∏
        let isDilating = false;
        let overheatLevel = 0;
        const MAX_OVERHEAT = 100;
        const DILATED_SHOOT_COOLDOWN = 250;

        // === –û–ë–ù–û–í–õ–ï–ù–ò–Ø —Å —É—á–µ—Ç–æ–º Time Dilation ===
        function updateStars() {
            stars.forEach(star => {
                star.y += star.speed * timeDilationFactor;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx * timeDilationFactor;
                p.y += p.vy * timeDilationFactor;
                p.vx *= 0.95;
                p.vy *= 0.95;
                p.life -= timeDilationFactor;
                p.size *= 0.98;
                if (p.life <= 0 || p.size <= 0.1) particles.splice(i, 1);
            }
        }

        function updatePowerUps() {
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                powerUp.y += powerUp.speed * timeDilationFactor;
                if (player.x < powerUp.x + powerUp.width && player.x + player.width > powerUp.x && player.y < powerUp.y + powerUp.height && player.y + player.height > powerUp.y) {
                    applyPowerUp(powerUp.type);
                    powerUps.splice(i, 1);
                    createParticles(powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, '#00ffff', 20);
                    score += 50;
                    updateUI();
                } else if (powerUp.y > canvas.height) {
                    powerUps.splice(i, 1);
                }
            }
        }

        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                if (bullet.isEnemy) {
                    if (bullet.angle !== undefined) {
                        bullet.x += Math.sin(bullet.angle) * bullet.speed * timeDilationFactor;
                        bullet.y += Math.cos(bullet.angle) * bullet.speed * timeDilationFactor;
                    } else {
                        bullet.y += bullet.speed * timeDilationFactor;
                    }
                    if (bullet.y > canvas.height || bullet.x < 0 || bullet.x > canvas.width) bullets.splice(i, 1);
                    else if (player.x < bullet.x + bullet.width && player.x + player.width > bullet.x &&
                             player.y < bullet.y + bullet.height && player.y + player.height > bullet.y) {
                        bullets.splice(i, 1);
                        if (shieldActive || (megaShieldStage > 0 && Date.now() < megaShieldEnd)) {
                            // –ø–æ–ø–∞–ª –ø–æ —â–∏—Ç—É
                        } else {
                            lives--;
                            player.isDamaged = true;
                            player.damageTime = Date.now();
                            if (lives <= 0) endGame();
                        }
                        updateUI();
                    }
                } else {
                    bullet.y -= bullet.speed * timeDilationFactor;
                    if (bullet.y < 0) bullets.splice(i, 1);
                }
            }
        }

        // === –ü–µ—Ä–µ–≥—Ä–µ–≤ –æ—Ä—É–∂–∏—è: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ===
        function updateOverheat() {
            // –ü–ª–∞–≤–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –≤—ã—Å—Ç—Ä–µ–ª–∞
            fireIntensity *= 0.95;
            if (fireIntensity < 0.01) fireIntensity = 0;

            // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ/—É–º–µ–Ω—å—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø–µ—Ä–µ–≥—Ä–µ–≤–∞
            if (fireIntensity > 0.7) {
                overheatLevel += 0.8; // –±—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç –ø–µ—Ä–µ–≥—Ä–µ–≤–∞ –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –æ–≥–Ω–µ
            } else {
                overheatLevel -= 0.5; // –º–µ–¥–ª–µ–Ω–Ω–æ–µ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ
            }
            if (overheatLevel < 0) overheatLevel = 0;
            if (overheatLevel > MAX_OVERHEAT) overheatLevel = MAX_OVERHEAT;

            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø–µ—Ä–µ–≥—Ä–µ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ–Ω/–≥—Ä–∞–¥–∏–µ–Ω—Ç)
            const overheatBar = document.getElementById('overheatBar');
            if (overheatBar) {
                overheatBar.style.width = `${(overheatLevel / MAX_OVERHEAT) * 100}%`;
                overheatBar.style.background = `linear-gradient(to right, #ff3300, #ffcc00)`;
            }
        }

        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.y += enemy.speed * timeDilationFactor;
                if (enemy.type === 'code-drone') {
                    updateCodeDrone(enemy, Date.now());
                }
                if (enemy.y > canvas.height) {
                    enemies.splice(i, 1);
                    lives--;
                    updateUI();
                    if (lives <= 0) endGame();
                }
            }
            if (bossActive && boss) {
                boss.y += boss.speed * timeDilationFactor;
                if (boss.y > 40) boss.y = 40;
                bossShoot();
            }
        }

        function checkCollisions() {
            const bulletsToRemove = [];
            const enemiesToRemove = [];
            const powerUpsToCreate = [];

            for (let b = 0; b < bullets.length; b++) {
                const bullet = bullets[b];
                for (let e = 0; e < enemies.length; e++) {
                    const enemy = enemies[e];
                    if (bullet.x < enemy.x + enemy.width && bullet.x + bullet.width > enemy.x && bullet.y < enemy.y + enemy.height && bullet.y + bullet.height > enemy.y) {
                        bulletsToRemove.push(b);
                        enemiesToRemove.push(e);
                        createParticles(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2, null, 20);
                        powerUpsToCreate.push({x: enemy.x + enemy.width / 2, y: enemy.y + enemy.height / 2});
                        // –ê–ø–≥—Ä–µ–π–¥ —É—Ä–æ–Ω–∞ –∏ –æ—á–∫–æ–≤
                        const dmg = UPGRADE_DATA.bulletDamage.effect(upgradeLevels.bulletDamage);
                        score += Math.round(10 * dmg);
                        updateUI();
                        if (enemy.type === 'code-drone') destroyCodeDrone(enemy);
                        break;
                    }
                }
            }

            for (let e = 0; e < enemies.length; e++) {
                const enemy = enemies[e];
                if (player.x < enemy.x + enemy.width && player.x + player.width > enemy.x && player.y < enemy.y + enemy.height && player.y + player.height > enemy.y) {
                    enemiesToRemove.push(e);
                    createParticles(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2, null, 20);
                    if (megaShieldStage > 0 && Date.now() < megaShieldEnd) {
                        megaShieldStage--;
                        if (megaShieldStage === 0) megaShieldEnd = 0;
                    } else if (shieldActive) {
                        shieldActive = false;
                    } else {
                        lives--;
                        player.isDamaged = true;
                        player.damageTime = Date.now();
                    }
                    updateUI();
                    if (lives <= 0) endGame();
                }
            }

            if (bossActive && boss) {
                for (let b = 0; b < bullets.length; b++) {
                    const bullet = bullets[b];
                    if (bullet.x < boss.x + boss.width && bullet.x + bullet.width > boss.x && bullet.y < boss.y + boss.height && bullet.y + bullet.height > boss.y) {
                        bulletsToRemove.push(b);
                        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Ä–æ–Ω–∞ –ø–æ –±–æ—Å—Å—É
                        const dmg = UPGRADE_DATA.bulletDamage.effect(upgradeLevels.bulletDamage);
                        boss.hp -= dmg;
                        createParticles(bullet.x + bullet.width/2, bullet.y + bullet.height/2, '#00ccff', 6);
                        if (boss.hp <= 0) {
                            createParticles(boss.x + boss.width/2, boss.y + boss.height/2, null, 60);
                            score += Math.round(500 * dmg);
                            updateUI();
                            if (Math.random() < 0.1) createPowerUp(boss.x + boss.width/2, boss.y + boss.height/2, 'megaShield');
                            bossActive = false;
                            boss = null;
                            bossTimer = Date.now();
                        }
                        break;
                    }
                }
            }

            if (bossActive && boss) {
                if (player.x < boss.x + boss.width && player.x + player.width > boss.x && player.y < boss.y + boss.height && player.y + player.height > boss.y) {
                    if (megaShieldStage > 0 && Date.now() < megaShieldEnd) {
                        megaShieldStage--;
                        if (megaShieldStage === 0) megaShieldEnd = 0;
                    } else if (shieldActive) {
                        shieldActive = false;
                    } else {
                        lives--;
                        player.isDamaged = true;
                        player.damageTime = Date.now();
                    }
                    updateUI();
                    if (lives <= 0) endGame();
                }
            }

            bulletsToRemove.sort((a, b) => b - a).forEach(idx => bullets.splice(idx, 1));
            enemiesToRemove.sort((a, b) => b - a).forEach(idx => enemies.splice(idx, 1));
            powerUpsToCreate.forEach(pos => createPowerUp(pos.x, pos.y));
        }

        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ö–æ–¥–æ–≤–æ–≥–æ –î—Ä–æ–Ω–∞
        function drawCodeDrone(enemy) {
            ctx.save();
            // –¢–µ–ª–æ –¥—Ä–æ–Ω–∞
            const grad = ctx.createLinearGradient(enemy.x, enemy.y, enemy.x + enemy.width, enemy.y + enemy.height);
            grad.addColorStop(0, '#00ffff');
            grad.addColorStop(1, '#ff00ff');
            ctx.fillStyle = grad;
            ctx.shadowBlur = 16;
            ctx.shadowColor = '#00ffff';
            ctx.beginPath();
            ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.width/2, 0, Math.PI*2);
            ctx.fill();
            // "–ö–æ–¥–æ–≤—ã–µ" –ª–∏–Ω–∏–∏
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.6;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                const angle = (Math.PI * 2 / 5) * i + (Date.now()/500 % Math.PI*2);
                ctx.lineTo(
                    enemy.x + enemy.width/2 + Math.cos(angle) * enemy.width/2,
                    enemy.y + enemy.height/2 + Math.sin(angle) * enemy.height/2
                );
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è "–º–∏–≥–∞—é—â–∞—è" —Ç–æ—á–∫–∞
            ctx.beginPath();
            ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height/2, 4 + 2*Math.sin(Date.now()/150), 0, Math.PI*2);
            ctx.fillStyle = '#fff';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#fff';
            ctx.fill();
            ctx.restore();
        }

        // === Visual Glitch & Code Explosion Particle Effects ===
        function createVisualGlitch(x, y) {
            for (let i = 0; i < 12; i++) {
                particles.push({
                    x: x + (Math.random() * 30 - 15),
                    y: y + (Math.random() * 30 - 15),
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 18 + Math.random() * 12,
                    size: 2,
                    color: `rgba(${100 + Math.random()*155}, ${50 + Math.random()*105}, 255, 0.9)`
                });
            }
        }

        function createCodeExplosion(x, y) {
            for (let i = 0; i < 40; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    life: 25 + Math.random() * 20,
                    size: 2.5 + Math.random() * 1.5,
                    color: `rgba(${100 + Math.random()*155}, ${50 + Math.random()*105}, 255, 1)`
                });
            }
        }

        function gameLoop() {
            if (!gameRunning) return;
            updateOverheat(); // –ø–ª–∞–≤–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ fireIntensity
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawStars(); updateStars();
            drawParticles(); updateParticles();
            powerUps.forEach(drawPowerUp); updatePowerUps();
            drawPlayer(); movePlayer();
            bullets.forEach(drawBullet); updateBullets();
            enemies.forEach(enemy => {
                if (enemy.type === 'code-drone') drawCodeDrone(enemy);
                else drawEnemy(enemy);
            }); updateEnemies(); spawnEnemy();
            if (bossActive && boss) drawBoss(boss);
            if (megaShieldStage > 0 && Date.now() > megaShieldEnd) megaShieldStage = 0;
            if (player.isDamaged && Date.now() - player.damageTime > 1000) player.isDamaged = false;
            checkCollisions();
            animationId = requestAnimationFrame(gameLoop);
        }

        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï ===
        let isLeftPressed = false, isRightPressed = false, fireInterval;
        function updateDx() {
            const currentSpeed = Date.now() < speedBoostEnd ? player.speed * 1.5 : player.speed;
            player.dx = (isRightPressed ? currentSpeed : 0) - (isLeftPressed ? currentSpeed : 0);
        }
        function setLeft(active) { isLeftPressed = active; document.getElementById('leftBtn').classList.toggle('active', active); updateDx(); }
        function setRight(active) { isRightPressed = active; document.getElementById('rightBtn').classList.toggle('active', active); updateDx(); }
        // --- Time Dilation Fire/Overheat ---
        function setFire(active) {
            document.getElementById('fireBtn').classList.toggle('active', active);
            clearInterval(fireInterval);
            if (active) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
                if (!isAudioLoaded) initAudio();
                fireIntensity = Math.min(MAX_INTENSITY, fireIntensity + 0.25);
                // Time Dilation: –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–≥—Ä–µ—Ç–æ, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                if (overheatLevel < MAX_OVERHEAT) {
                    isDilating = true;
                    timeDilationFactor = timeDilationMax;
                } else {
                    isDilating = false;
                    timeDilationFactor = 1.0;
                }
                shoot();
                fireInterval = setInterval(() => {
                    // –ü–µ—Ä–µ–≥—Ä–µ–≤ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç—Ä–µ–ª—å–±–µ –≤ —Ä–µ–∂–∏–º–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
                    if (isDilating) {
                        overheatLevel += 2;
                        if (overheatLevel >= MAX_OVERHEAT) {
                            overheatLevel = MAX_OVERHEAT;
                            isDilating = false;
                            timeDilationFactor = 1.0;
                        }
                    } else {
                        // –û—Å—Ç—ã–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –∑–∞–º–µ–¥–ª—è–µ–º
                        overheatLevel = Math.max(0, overheatLevel - 1);
                    }
                    fireIntensity = Math.min(MAX_INTENSITY, fireIntensity + 0.08);
                    shoot();
                }, DILATED_SHOOT_COOLDOWN);
            } else {
                fireIntensity = 0;
                isDilating = false;
                timeDilationFactor = 1.0;
                // –ë—ã—Å—Ç—Ä–æ–µ –æ—Å—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏ FIRE
                const coolInterval = setInterval(() => {
                    overheatLevel = Math.max(0, overheatLevel - 2);
                    if (overheatLevel === 0) clearInterval(coolInterval);
                }, 40);
            }
        }

        const leftBtn = document.getElementById('leftBtn'), rightBtn = document.getElementById('rightBtn'), fireBtn = document.getElementById('fireBtn');
        const leftZone = document.getElementById('leftZone'), rightZone = document.getElementById('rightZone');
        [leftBtn, leftZone].forEach(el => {
            el.addEventListener('touchstart', e => { e.preventDefault(); setLeft(true); });
            el.addEventListener('touchend', e => { e.preventDefault(); setLeft(false); });
        });
        [rightBtn, rightZone].forEach(el => {
            el.addEventListener('touchstart', e => { e.preventDefault(); setRight(true); });
            el.addEventListener('touchend', e => { e.preventDefault(); setRight(false); });
        });
        fireBtn.addEventListener('touchstart', e => { e.preventDefault(); setFire(true); });
        fireBtn.addEventListener('touchend', e => { e.preventDefault(); setFire(false); });
        window.addEventListener('blur', () => { setLeft(false); setRight(false); setFire(false); });

        document.addEventListener('keydown', e => {
            if (!gameRunning || e.repeat) return;
            if (e.code === 'ArrowLeft') setLeft(true);
            if (e.code === 'ArrowRight') setRight(true);
            if (e.code === 'Space') setFire(true);
        });
        document.addEventListener('keyup', e => {
            if (e.code === 'ArrowLeft') setLeft(false);
            if (e.code === 'ArrowRight') setRight(false);
            if (e.code === 'Space') setFire(false);
        });

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('bottomPanel').style.display = 'flex';
            gameRunning = true;
            try { backgroundMusic.play().catch(() => {}); } catch(e) {}
            score = 0; lives = 3; bullets = []; enemies = [];
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            gameLoop();
        }

        function endGame() {
            try { backgroundMusic.pause(); backgroundMusic.currentTime = 0; } catch(e) {}
            try { galaxyMusic.pause(); galaxyMusic.currentTime = 0; } catch(e) {}
            gameRunning = false;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('bottomPanel').style.display = 'none';
            if (tg) tg.showAlert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á—ë—Ç: ${score}`);
        }

        function restartGame() { startGame(); }

        document.body.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', preloadSounds);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –ø–æ –ø–µ—Ä–≤–æ–º—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è Web Audio API)
        document.body.addEventListener('touchstart', initAudio, { once: true });
        document.body.addEventListener('mousedown', initAudio, { once: true });
    </script>
</body>
</html>
