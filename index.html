<!DOCTYPE html>
<html lang="ru">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>SPACEDUST - Cosmic Strategy</title>
Â  Â  <script src="https://telegram.org/js/telegram-web-app.js"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
Â  Â  Â  Â  /* Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ ÑĞ²ĞµÑ€Ñ…Ñƒ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… UI-Ğ¿Ğ°Ğ½ĞµĞ»ĞµĞ¹ Ğ¸ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¾ĞºĞ¾Ğ½ */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --safe-top: env(safe-area-inset-top, 40px);
Â  Â  Â  Â  Â  Â  --ui-top-offset: calc(80px + var(--safe-top));
Â  Â  Â  Â  }
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #0a0a2e 0%, #16213e 50%, #000000 100%);
Â  Â  Â  Â  Â  Â  background-size: cover;
Â  Â  Â  Â  Â  Â  background-repeat: no-repeat;
Â  Â  Â  Â  Â  Â  background-attachment: fixed;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  font-family: 'Orbitron', monospace;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  touch-action: none;
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  /* ĞĞ±Ñ‰Ğ¸Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ */
Â  Â  Â  Â  #gameContainer, #galaxyContainer {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  #galaxyContainer {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  /* background:
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 20% 30%, rgba(120, 0, 200, 0.3) 0%, transparent 50%) no-repeat,
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 80% 70%, rgba(0, 100, 255, 0.3) 0%, transparent 50%) no-repeat;
Â  Â  Â  Â  Â  Â  background-size: cover; */
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  z-index: 5;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  canvas {
Â  Â  Â  Â  Â  Â  border: 0.314px solid rgba(0, 255, 255, 0.7);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(0, 255, 255, 0.5), inset 0 0 20px rgba(0, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  background: #000;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 100%;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  /* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ÑˆÑƒÑ‚ĞµÑ€Ğ° */
Â  Â  Â  Â  #ui {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: var(--ui-top-offset);
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  color: #00ffff;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 10px #00ffff;
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  background: rgba(0, 20, 30, 0.7);
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0, 255, 255, 0.5);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: row;
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  animation: ui-glow 2s infinite alternate;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  @keyframes ui-glow {
Â  Â  Â  Â  Â  Â  from { box-shadow: 0 0 10px rgba(0, 255, 255, 0.5); }
Â  Â  Â  Â  Â  Â  to { box-shadow: 0 0 20px rgba(0, 255, 255, 0.8); }
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .ui-item { display: flex; align-items: center; gap: 8px; }
Â Â  Â  Â  Â 
Â Â  Â  Â  Â 
Â  Â  Â  Â  #gameOver, #startScreen {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  z-index: 20;
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  Â  Â  background: rgba(10, 20, 40, 0.9);
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  border: 2px solid rgba(0, 255, 255, 0.7);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  animation: screen-pulse 1.5s infinite alternate;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  @keyframes screen-pulse {
Â  Â  Â  Â  Â  Â  from { transform: translate(-50%, -50%) scale(1); opacity: 0.9; }
Â  Â  Â  Â  Â  Â  to { transform: translate(-50%, -50%) scale(1.02); opacity: 1; }
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  #gameOver { display: none; }
Â Â  Â  Â  Â 
Â  Â  Â  Â  #startScreen h1 {
Â  Â  Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 20px #00ffff;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  animation: pulse 2s infinite;
Â  Â  Â  Â  Â  Â  background: linear-gradient(to right, #00ffff, #ff00ff);
Â  Â  Â  Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  #gameOver h1 {
Â  Â  Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 20px #ff3232;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  color: #ff3232;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  #startScreen p, #gameOver p {
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  color: #a0e0ff;
Â  Â  Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  border: 2px solid #00ffff;
Â  Â  Â  Â  Â  Â  color: #00ffff;
Â  Â  Â  Â  Â  Â  padding: 15px 40px;
Â  Â  Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s;
Â  Â  Â  Â  Â  Â  font-family: 'Orbitron', monospace;
Â  Â  Â  Â  Â  Â  touch-action: manipulation;
Â  Â  Â  Â  Â  Â  border-radius: 30px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .btn::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: -100%;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.4), transparent);
Â  Â  Â  Â  Â  Â  transition: left 0.5s;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .btn:hover::before, .btn:active::before { left: 100%; }
Â  Â  Â  Â  .btn:active { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 20px #00ffff; }
Â Â  Â  Â  Â 
Â  Â  Â  Â  #leftZone, #rightZone {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  width: 35%;
Â  Â  Â  Â  Â  Â  height: 150px;
Â  Â  Â  Â  Â  Â  z-index: 14;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  #leftZone { left: 0; }
Â  Â  Â  Â  #rightZone { right: 0; }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .instructions { margin-top: 15px; font-size: 14px; color: #80c0ff; }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .power-ups { display: flex; justify-content: center; gap: 8px; margin-top: 8px; }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .power-up {
Â  Â  Â  Â  Â  Â  width: 33px;
Â  Â  Â  Â  Â  Â  height: 33px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: rgba(255, 215, 0, 0.3);
Â  Â  Â  Â  Â  Â  border: 1px solid gold;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  animation: power-glow 1s infinite alternate;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  @keyframes power-glow { from { box-shadow: 0 0 5px gold; } to { box-shadow: 0 0 3.14px gold; } }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .stars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .star { position: absolute; background-color: white; border-radius: 50%; animation: twinkle 2s infinite alternate; }
Â Â  Â  Â  Â 
Â  Â  Â  Â  @keyframes twinkle { from { opacity: 0.5; } to { opacity: 1; } }
Â Â  Â  Â  Â 
Â  Â  Â  Â  /* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ³Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ñ‹ */
Â  Â  Â  Â  /* ĞĞ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ: Ğ—ĞĞ‘Ğ›ĞĞšĞ˜Ğ ĞĞ’ĞĞĞĞĞ¯ ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯ */
Â  Â  Â  Â  .mission-locked {
Â  Â  Â  Â  Â  Â  border: 3px dashed #5555ff;
Â  Â  Â  Â  Â  Â  color: #5555ff;
Â  Â  Â  Â  Â  Â  background: rgba(50, 50, 150, 0.4);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(85, 85, 255, 0.5);
Â  Â  Â  Â  Â  Â  animation: pulse-lock 2s infinite alternate;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  /* ĞĞ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ: Ğ ĞĞ—Ğ‘Ğ›ĞĞšĞ˜Ğ ĞĞ’ĞĞĞĞĞ¯ ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯ */
Â  Â  Â  Â  .mission-unlocked {
Â  Â  Â  Â  Â  Â  border: 3px solid #ff00ff;
Â  Â  Â  Â  Â  Â  color: #ff00ff;
Â  Â  Â  Â  Â  Â  background: rgba(150, 50, 150, 0.6);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 30px #ff00ff;
Â  Â  Â  Â  Â  Â  animation: pulse-unlock 1s infinite alternate;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  @keyframes pulse-lock {
Â  Â  Â  Â  Â  Â  from { opacity: 0.7; }
Â  Â  Â  Â  Â  Â  to { opacity: 1.0; }
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  @keyframes pulse-unlock {
Â  Â  Â  Â  Â  Â  from { transform: scale(1.0); box-shadow: 0 0 30px #ff00ff; }
Â  Â  Â  Â  Â  Â  to { transform: scale(1.1); box-shadow: 0 0 40px #ff00ff; }
Â  Â  Â  Â  }
Â  Â  Â  Â  .sector {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  animation: pulse 3s infinite alternate;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .sector.controlled {
Â  Â  Â  Â  Â  Â  background: radial-gradient(circle, #00ff88, #0088ff);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 30px #00ff88;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .sector.enemy {
Â  Â  Â  Â  Â  Â  background: radial-gradient(circle, #ff4444, #ff0088);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 30px #ff4444;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .sector.neutral {
Â  Â  Â  Â  Â  Â  background: radial-gradient(circle, #8888ff, #4444aa);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px #8888ff;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .sector:hover {
Â  Â  Â  Â  Â  Â  transform: scale(1.2);
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .sirius-dust {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 20%;
Â  Â  Â  Â  Â  Â  left: 15%;
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  color: #00ffff;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 20px #00ffff;
Â  Â  Â  Â  Â  Â  animation: glow 2s infinite alternate;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  @keyframes glow {
Â  Â  Â  Â  Â  Â  from { opacity: 0.7; transform: scale(1); }
Â  Â  Â  Â  Â  Â  to { opacity: 1; transform: scale(1.05); }
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .resources-panel {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: var(--ui-top-offset);
Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  background: rgba(0, 20, 40, 0.8);
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  border: 1px solid #00ffff;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  .mission-alert {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  background: rgba(255, 100, 0, 0.9);
Â  Â  Â  Â  Â  Â  padding: 15px 30px;
Â  Â  Â  Â  Â  Â  border-radius: 25px;
Â  Â  Â  Â  Â  Â  animation: alert-pulse 1.5s infinite;
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â  Â  Â  Â  @keyframes alert-pulse {
Â  Â  Â  Â  Â  Â  0%, 100% { box-shadow: 0 0 20px rgba(255, 100, 0, 0.7); }
Â  Â  Â  Â  Â  Â  50% { box-shadow: 0 0 40px rgba(255, 100, 0, 1); }
Â  Â  Â  Â  }
Â Â  Â  Â  Â 
Â 
Â  Â  Â  Â  /* Ğ£ĞĞ˜Ğ¤Ğ˜Ğ¦Ğ˜Ğ ĞĞ’ĞĞĞĞĞ¯ ĞĞ˜Ğ–ĞĞ¯Ğ¯ ĞŸĞĞĞ•Ğ›Ğ¬ */
Â  Â  Â  Â  #bottomPanel {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: env(safe-area-inset-bottom, 0);
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 10px 20px calc(20px + env(safe-area-inset-bottom, 0)) 20px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  z-index: 15;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: flex-end;
Â  Â  Â  Â  Â  Â  pointer-events: auto;
Â  Â  Â  Â  Â  Â  background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  .control-btn {
Â  Â  Â  Â  Â  Â  width: 70px;
Â  Â  Â  Â  Â  Â  height: 70px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: rgba(0, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  border: 2px solid #00ffff;
Â  Â  Â  Â  Â  Â  color: #00ffff;
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  touch-action: none;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
Â  Â  Â  Â  Â  Â  transition: all 0.1s;
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  Â  Â  Â  pointer-events: auto;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  #fireBtn {
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  Â  Â  background: rgba(255, 50, 50, 0.2);
Â  Â  Â  Â  Â  Â  border-color: #ff3232;
Â  Â  Â  Â  Â  Â  color: #ff3232;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px rgba(255, 50, 50, 0.5);
Â  Â  Â  Â  Â  Â  touch-action: manipulation;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  line-height: 1.2;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  #mapBtn, #shooterBtn {
Â  Â  Â  Â  Â  Â  width: 60px;
Â  Â  Â  Â  Â  Â  height: 60px;
Â  Â  Â  Â  Â  Â  background: rgba(0, 150, 255, 0.3);
Â  Â  Â  Â  Â  Â  border: 2px solid #00aaff;
Â  Â  Â  Â  Â  Â  color: #00aaff;
Â  Â  Â  Â  Â  Â  font-size: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px rgba(0, 150, 255, 0.5);
Â  Â  Â  Â  Â  Â  pointer-events: auto;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  /* --- $XDUST Sector --- */
Â  Â  Â  Â  .sector.xdust {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: #005577; /* Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ†Ğ²ĞµÑ‚ */
Â  Â  Â  Â  Â  Â  border: 3px solid #00ffff;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
Â  Â  Â  Â  Â  Â  overflow: visible;
Â  Â  Â  Â  Â  Â  z-index: 12;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  /* ĞŸĞ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ´Ñ‹Ñ…Ğ°Ğ½Ğ¸Ğµ/ÑĞ¸ÑĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ::before */
Â  Â  Â  Â  .sector.xdust::before {
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 140%;
Â  Â  Â  Â  Â  Â  height: 140%;
Â  Â  Â  Â  Â  Â  top: -20%;
Â  Â  Â  Â  Â  Â  left: -20%;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: radial-gradient(circle, rgba(0,255,255,0.5) 0%, rgba(0,85,119,0) 70%);
Â  Â  Â  Â  Â  Â  animation: xdustBreath 2.7s infinite ease-in-out;
Â  Â  Â  Â  Â  Â  z-index: -1;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  /* ĞŸÑƒĞ»ÑŒÑĞ¸Ñ€ÑƒÑÑ‰ĞµĞµ ĞºĞ¾Ğ»ÑŒÑ†Ğ¾ Ğ²Ğ¾ĞºÑ€ÑƒĞ³ ÑĞµĞºÑ‚Ğ¾Ñ€Ğ° */
Â  Â  Â  Â  .sector.xdust::after {
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 130%;
Â  Â  Â  Â  Â  Â  height: 130%;
Â  Â  Â  Â  Â  Â  top: -15%;
Â  Â  Â  Â  Â  Â  left: -15%;
Â  Â  Â  Â  Â  Â  border: 2.5px solid #00ffff;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  opacity: 0.5;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  animation: xdustRing 2.7s infinite linear;
Â  Â  Â  Â  Â  Â  z-index: -1;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  /* --- $XDUST-9999 Sector --- */
Â  Â  Â  Â  .sector.xdust9999 {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: #990000; /* Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ†Ğ²ĞµÑ‚ */
Â  Â  Â  Â  Â  Â  border: 3px solid #ff2222;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 40px 12px #ff2222, 0 0 80px 24px #ff2222;
Â  Â  Â  Â  Â  Â  overflow: visible;
Â  Â  Â  Â  Â  Â  z-index: 11;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  .sector.xdust9999::before {
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 140%;
Â  Â  Â  Â  Â  Â  height: 140%;
Â  Â  Â  Â  Â  Â  top: -20%;
Â  Â  Â  Â  Â  Â  left: -20%;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: radial-gradient(circle, rgba(255,34,34,0.6) 0%, rgba(153,0,0,0) 70%);
Â  Â  Â  Â  Â  Â  animation: xdust9999Breath 2.5s infinite ease-in-out;
Â  Â  Â  Â  Â  Â  z-index: -1;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  /* --- Keyframes --- */
Â  Â  Â  Â  @keyframes xdustBreath {
Â  Â  Â  Â  Â  Â  0%, 100% { transform: scale(1); opacity: 0.6; }
Â  Â  Â  Â  Â  Â  50% { transform: scale(1.3); opacity: 1; }
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  @keyframes xdustRing {
Â  Â  Â  Â  Â  Â  0% { transform: scale(1); opacity: 0.5; }
Â  Â  Â  Â  Â  Â  70% { transform: scale(1.3); opacity: 0.9; }
Â  Â  Â  Â  Â  Â  100% { transform: scale(1.7); opacity: 0; }
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  @keyframes xdust9999Breath {
Â  Â  Â  Â  Â  Â  0%, 100% { transform: scale(1); opacity: 0.6; }
Â  Â  Â  Â  Â  Â  50% { transform: scale(1.3); opacity: 1; }
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  /* Ğ—Ğ²ĞµĞ·Ğ´Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ğ½ Ğ³Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸ĞºĞ¸ */
Â  Â  Â  Â  #galaxyContainer::before {
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0; left: 0;
Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 80%);
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  z-index: 0;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  #galaxyContainer::after {
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: -50%; left: -50%;
Â  Â  Â  Â  Â  Â  width: 200%;
Â  Â  Â  Â  Â  Â  height: 200%;
Â  Â  Â  Â  Â  Â  background: url('https://www.transparenttextures.com/patterns/stardust.png') repeat;
Â  Â  Â  Â  Â  Â  z-index: 0;
Â  Â  Â  Â  Â  Â  animation: starsDrift 60s linear infinite;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  @keyframes starsDrift {
Â  Â  Â  Â  Â  Â  from { background-position: 0 0; }
Â  Â  Â  Â  Â  Â  to { background-position: 1000px 1000px; }
Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  /* ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ "Ğ²Ğ·Ñ€Ñ‹Ğ²Ğ° Ñ„Ñ€Ğ°ĞºÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞ²ĞµÑ‚Ğ°" */
Â  Â  Â  Â  @keyframes burstFade {
Â  Â  Â  Â  Â  Â  from { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
Â  Â  Â  Â  Â  Â  to { transform: translate(-50%, -50%) scale(2); opacity: 0; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <!-- Space Shooter -->
Â  Â  <div id="gameContainer">
Â  Â  Â  Â  <div class="stars" id="stars"></div>
Â Â  Â  Â  Â 
Â  Â  Â  Â  <div id="ui">
Â  Â  Â  Â  Â  Â  <div class="ui-item"><span>âš¡</span><span id="score">0</span></div>
Â  Â  Â  Â  Â  Â  <div class="ui-item"><span>â¤ï¸</span><span id="lives">3</span></div>
Â  Â  Â  Â  </div>
Â Â  Â  Â  Â 
Â  Â  Â  Â  <div id="startScreen">
Â  Â  Â  Â  Â  Â  <h1>ğŸš€ SPACEDUST</h1>
Â  Â  Â  Â  Â  Â  <p>Defend the Galaxy!</p>
Â  Â  Â  Â  Â  Â  <p>Dust your enemies and collect bonuses</p>
Â  Â  Â  Â  Â  Â  <div class="instructions">Use Buttons to Move and Fire</div>
Â  Â  Â  Â  Â  Â  <div class="power-ups"><div class="power-up">S</div><div class="power-up">P</div><div class="power-up">L</div></div>
Â  Â  Â  Â  Â  Â  <button class="btn" ontouchstart="startGame()" onclick="startGame()">START</button>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="mode-btn" onclick="switchToGalaxy()">ğŸŒŒ Galaxy Map</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â Â  Â  Â  Â 
Â  Â  Â  Â  <div id="gameOver">
Â  Â  Â  Â  Â  Â  <h1>Mission Failed</h1>
Â  Â  Â  Â  Â  Â  <p>Score: <span id="finalScore">0</span></p>
Â  Â  Â  Â  Â  Â  <p>Sector captured by enemy!</p>
Â  Â  Â  Â  Â  Â  <button class="btn" ontouchstart="restartGame()" onclick="restartGame()">RESTART</button>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="mode-btn" onclick="switchToGalaxy()">ğŸŒŒ Galaxy Map</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â Â  Â  Â  Â 
Â  Â  Â  Â  <canvas id="gameCanvas"></canvas>
Â 
Â  Â  Â  Â  <div id="bottomPanel" style="display: none;">
Â  Â  Â  Â  Â  Â  <button id="mapBtn" class="control-btn" onclick="switchToGalaxy()">ğŸŒŒ</button>
Â Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 15px; pointer-events: auto;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="control-btn" id="leftBtn">â—€</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="control-btn" id="rightBtn">â–¶</div>
Â  Â  Â  Â  Â  Â  </div>
Â Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  <div id="fireBtn" class="control-btn">FIRE</div>
Â  Â  Â  Â  </div>
Â 
Â  Â  Â  Â  <div id="leftZone"></div>
Â  Â  Â  Â  <div id="rightZone"></div>
Â  Â  </div>
Â 
Â  Â  <!-- Galaxy Map -->
Â  Â  <div id="galaxyContainer">
Â  Â  Â  Â  <div class="sirius-dust">âœ¨ XDUST FROM SIRIUS! âœ¨</div>
Â Â  Â  Â  Â 
Â  Â  Â  Â  <div class="resources-panel">
Â  Â  Â  Â  Â  Â  <h3>XDUST Resources</h3>
Â  Â  Â  Â  Â  Â  <div>âš¡ Energy: <span id="energy">1500</span></div>
Â  Â  Â  Â  Â  Â  <div>ğŸª Metals: <span id="metals">800</span></div>
Â  Â  Â  Â  Â  Â  <div>ğŸ’ Crystals: <span id="crystals">300</span></div>
Â  Â  Â  Â  Â  Â  <div>ğŸš€ Score: <span id="galaxyScore">0</span></div>
Â  Â  Â  Â  </div>
Â Â  Â  Â  Â 
Â  Â  Â  Â  <div id="achievementsPanel" style="
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: var(--ui-top-offset);
Â  Â  Â  Â  Â  Â  left: 20px;
Â  Â  Â  Â  Â  Â  width: 200px;
Â  Â  Â  Â  Â  Â  background: rgba(0, 20, 40, 0.8);
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ff00ff;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px #ff00ff;
Â  Â  Â  Â  Â  Â  max-height: calc(100vh - var(--ui-top-offset) - 130px);
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  ">
Â  Â  Â  Â  Â  Â  <h3>ğŸ† Achievements</h3>
Â  Â  Â  Â  Â  Â  <div id="achievementsList"></div>
Â  Â  Â  Â  </div>
Â 
Â  Â  Â  Â  <div class="mission-alert">
Â  Â  Â  Â  Â  Â  ğŸš¨ Sirius delivers XDUST to boost your fleet!
Â  Â  Â  Â  </div>
Â 
Â  Â  Â  Â  <!-- Upgrade Shop Modal Button -->
Â  Â  Â  Â  <button id="openUpgradeModalBtn" style="
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 110px;
Â  Â  Â  Â  Â  Â  left: 20px;
Â  Â  Â  Â  Â  Â  z-index: 30;
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, #ff00ff, #00ffff);
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  padding: 12px 24px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 30px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px #ff00ff;
Â  Â  Â  Â  Â  Â  font-family: 'Orbitron', monospace;
Â  Â  Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  Â  Â  transition: box-shadow 0.2s;
Â  Â  Â  Â  " onclick="openUpgradeShopModal()">ğŸ› ï¸ Upgrades</button>
Â  Â  Â  Â  <!-- Upgrade Shop Modal (Full Screen) -->
Â  Â  Â  Â  <div id="upgradeShopModal" style="
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0; left: 0; right: 0; bottom: 0;
Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  background: rgba(10, 5, 40, 0.98);
Â  Â  Â  Â  Â  Â  z-index: 9999;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  padding-top: var(--ui-top-offset);
Â  Â  Â  Â  Â  Â  padding-bottom: 6vw;
Â  Â  Â  Â  ">
Â  Â  Â  Â  Â  Â  <div style="
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  Â  Â  width: 96vw;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  Â  Â  Â  Â  background: rgba(5, 5, 50, 0.97);
Â  Â  Â  Â  Â  Â  Â  Â  padding: 28px 18px 18px 18px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 18px;
Â  Â  Â  Â  Â  Â  Â  Â  border: 2px solid #ff00ff;
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 0 35px #ff00ff;
Â  Â  Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 270px;
Â  Â  Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  ">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeUpgradeShopModal()" style="
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  top: 12px; right: 12px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background: #ff00ff;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width: 34px; height: 34px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font-size: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px #ff00ff;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  z-index: 2;
Â  Â  Â  Â  Â  Â  Â  Â  " aria-label="Close">âœ•</button>
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: #ff00ff; text-align: center; margin-bottom: 14px; text-shadow: 0 0 12px #ff00ff;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ› ï¸ XDUST Upgrades
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="upgradesListModal"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 13px; margin-top: 14px; color: #aaa; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âš¡ Energy: <span id="shopEnergyModal" class="resource-value">0</span>
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  <!-- Unified Bottom Button -->
Â  Â  Â  Â  <div id="bottomPanel-galaxy" style="position: fixed; bottom: 0; right: 20px; z-index: 100; padding-bottom: 20px;">
Â  Â  Â  Â  Â  Â  <button id="shooterBtn" class="control-btn" onclick="switchToShooter()">ğŸ®</button>
Â  Â  Â  Â  </div>
Â  Â  </div> update design don't delete update and Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ Ñ ĞºĞ°ĞºĞ¸Ğµ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ñ‹ ÑĞ²ĞµÑ€Ñ…Ñƒ Ğ´ĞµĞ»Ğ°Ñ ÑÑ‚ Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµĞ³Ñ€Ğ°Ğ¼Ğ¼

    <script>
        // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('bottomPanel').style.display = 'flex';
            // Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ ĞºĞ¾Ğ´ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ³Ñ€Ñ‹
        }
        
        function restartGame() {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('bottomPanel').style.display = 'flex';
            // Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ ĞºĞ¾Ğ´ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¸Ğ³Ñ€Ñ‹
        }
        
        function switchToGalaxy() {
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('galaxyContainer').style.display = 'block';
        }
        
        function switchToShooter() {
            document.getElementById('galaxyContainer').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
        }
        
        function openUpgradeShopModal() {
            document.getElementById('upgradeShopModal').style.display = 'flex';
        }
        
        function closeUpgradeShopModal() {
            document.getElementById('upgradeShopModal').style.display = 'none';
        }
        
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
        window.onload = function() {
            // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ²ĞµĞ·Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ñ„Ğ¾Ğ½Ğ°
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                starsContainer.appendChild(star);
            }
        };
    </script>
</body>
</html>

    <script>
        // === ĞŸĞ•Ğ Ğ•ĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ• ĞœĞ•Ğ–Ğ”Ğ£ Ğ Ğ•Ğ–Ğ˜ĞœĞĞœĞ˜ ===
        // Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
        let currentEnergy = 1500;
        let currentMetals = 800;
        let currentCrystals = 300;
        let miningInterval; // ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ID Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğ° Ğ¼Ğ°Ğ¹Ğ½Ğ¸Ğ½Ğ³Ğ°

        // === ĞĞŸĞ“Ğ Ğ•Ğ™Ğ”Ğ« XDUST ===
        let upgradeLevels = { fireRate: 0, bulletDamage: 0, hull: 0 };

        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¾Ğ²: ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ, ÑÑ„Ñ„ĞµĞºÑ‚ Ğ¸ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼
        
        
        // ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¾Ğ² Ñ Ğ¼ÑƒĞ»ÑŒÑ‚Ğ¸-Ñ€ĞµÑÑƒÑ€ÑĞ½Ğ¾Ğ¹ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒÑ
        const UPGRADE_DATA = {
            fireRate: {
                name: "Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚Ñ€ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ",
                maxLevel: 5,
                cost: [
                    { energy: 500, metals: 100, crystals: 10 },
                    { energy: 750, metals: 180, crystals: 22 },
                    { energy: 1130, metals: 270, crystals: 38 },
                    { energy: 1700, metals: 400, crystals: 60 },
                    { energy: 2550, metals: 600, crystals: 90 }
                ],
                effect: level => level > 0 ? (250 / (1 + level * 0.15)) : 250,
                description: "Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ°ĞµÑ‚ ĞºÑƒĞ»Ğ´Ğ°ÑƒĞ½ Ğ²Ñ‹ÑÑ‚Ñ€ĞµĞ»Ğ¾Ğ²."
            },
            bulletDamage: {
                name: "Ğ£Ñ€Ğ¾Ğ½",
                maxLevel: 5,
                cost: [
                    { energy: 1000, metals: 250, crystals: 30 },
                    { energy: 1800, metals: 400, crystals: 60 },
                    { energy: 3200, metals: 650, crystals: 100 },
                    { energy: 5000, metals: 1100, crystals: 160 },
                    { energy: 8000, metals: 1800, crystals: 250 }
                ],
                effect: level => 1 + level * 0.5,
                description: "Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ÑƒÑ€Ğ¾Ğ½ Ğ¾Ñ‚ Ğ¿ÑƒĞ»ÑŒ."
            },
            hull: {
                name: "ĞŸÑ€Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ°",
                maxLevel: 3,
                cost: [
                    { energy: 800, metals: 200, crystals: 20 },
                    { energy: 1600, metals: 350, crystals: 45 },
                    { energy: 3200, metals: 600, crystals: 80 }
                ],
                effect: level => 3 + level,
                description: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ Ğ¶Ğ¸Ğ·Ğ½ÑŒ."
            }
        };

        // â­ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ñ€ĞµÑÑƒÑ€ÑÑ‹ + Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ñ‹)
        function saveData() {
            const gameState = {
                energy: currentEnergy,
                metals: currentMetals,
                crystals: currentCrystals,
                shooterScore: score,
                shooterLives: lives,
                upgradeLevels: upgradeLevels
            };
            try { localStorage.setItem('xdust_save_data', JSON.stringify(gameState)); } catch(e){}
        }

        // â­ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        function loadData() {
            try {
                const savedData = localStorage.getItem('xdust_save_data');
                if(!savedData) return false;
                const data = JSON.parse(savedData);
                if(typeof data.energy === 'number') currentEnergy = data.energy;
                if(typeof data.metals === 'number') currentMetals = data.metals;
                if(typeof data.crystals === 'number') currentCrystals = data.crystals;
                if(typeof data.shooterScore === 'number') score = data.shooterScore;
                if(typeof data.shooterLives === 'number') lives = data.shooterLives;
                if(data.upgradeLevels) upgradeLevels = data.upgradeLevels;
                applyUpgradeEffects();
                updateUI();
                return true;
            } catch(e) { console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:", e); return false; }
        }

        // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¾Ğ² Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¾Ğ²
        function applyUpgradeEffects() {
            shootCooldown = UPGRADE_DATA.fireRate.effect(upgradeLevels.fireRate);
            const maxLives = UPGRADE_DATA.hull.effect(upgradeLevels.hull);
            lives = Math.min(lives, maxLives);
            updateUI();
        }

        // ĞÑ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¾Ğ² (ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ±Ğ¾ĞºĞ¾Ğ²Ğ¾Ğ¹ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ - Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ)
        function renderUpgradeShop() {
            // legacy, Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ Ğ²Ñ‹Ğ·Ğ¾Ğ² Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼, Ğ»Ğ¸Ğ±Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾
            // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ renderUpgradeShopModal() ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
        }

        
        
        // === ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸ Ñ ÑĞµĞºÑ‚Ğ¾Ñ€Ğ¾Ğ¼ $XDUST ===
        function handleXDUSTEncounter(sector) {
            if (sector.type === "xdust") {
                if (sector.visited) {
                    if (typeof tg !== "undefined" && tg && tg.showAlert) {
                        tg.showAlert("âœ¨ Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ¿Ğ¾ÑĞµÑ‚Ğ¸Ğ»Ğ¸ ÑĞµĞºÑ‚Ğ¾Ñ€ $XDUST!");
                    } else {
                        alert("âœ¨ Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ¿Ğ¾ÑĞµÑ‚Ğ¸Ğ»Ğ¸ ÑĞµĞºÑ‚Ğ¾Ñ€ $XDUST!");
                    }
                    return;
                }
                // Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¿ĞµÑ†ÑÑ„Ñ„ĞµĞºÑ‚: Ğ±Ğ¸Ñ€ÑĞ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ²ÑĞ¿Ğ»ĞµÑĞº
                const galaxyContainer = document.getElementById('galaxyContainer');
                const burst = document.createElement('div');
                burst.style.position = 'absolute';
                burst.style.left = `${sector.x}%`;
                burst.style.top = `${sector.y}%`;
                burst.style.width = '180px';
                burst.style.height = '180px';
                burst.style.borderRadius = '50%';
                burst.style.background = 'radial-gradient(circle, rgba(0,255,255,0.7), transparent 70%)';
                burst.style.transform = 'translate(-50%, -50%)';
                burst.style.animation = 'burstFade 2s ease-out forwards';
                burst.style.pointerEvents = 'none';
                galaxyContainer.appendChild(burst);
                setTimeout(() => burst.remove(), 1700);
                // Ğ‘Ğ¾Ğ½ÑƒÑ $XSDC
                const xsdcReward = 3141;
                currentXSDC += xsdcReward;
                displayResources();
                saveDataAll && saveDataAll();
                sector.visited = true;
                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                    tg.showAlert(`âœ¨ Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµĞºÑ‚Ğ¾Ñ€ $XDUST! Ğ‘Ğ¾Ğ½ÑƒÑ: +${xsdcReward} $XSDC`);
                } else {
                    alert(`âœ¨ Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµĞºÑ‚Ğ¾Ñ€ $XDUST! Ğ‘Ğ¾Ğ½ÑƒÑ: +${xsdcReward} $XSDC`);
                }
                // ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞµÑ‰ĞµĞ½Ğ¸Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ñ‚ĞµĞ¼Ğ½Ğ¸Ñ‚ÑŒ ÑĞµĞºÑ‚Ğ¾Ñ€)
                initGalaxyMap();
            }
            // Ğ”Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
        }

        // ĞĞ¾Ğ²Ñ‹Ğ¹: Ğ¾Ñ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¾Ğ² Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ½Ğ°
        function renderUpgradeShopModal() {
            const list = document.getElementById('upgradesListModal');
            const shopEnergy = document.getElementById('shopEnergyModal');
            if(!list || !shopEnergy) return;
            list.innerHTML = '';
            shopEnergy.textContent = Math.floor(currentEnergy);
            for(const key in UPGRADE_DATA){
                const data = UPGRADE_DATA[key];
                const currentLevel = upgradeLevels[key];
                const isMaxLevel = currentLevel >= data.maxLevel;
                const upgradeDiv = document.createElement('div');
                upgradeDiv.className = 'upgrade-item';
                upgradeDiv.style.border='1px solid rgba(255,0,255,0.4)';
                upgradeDiv.style.padding='10px 8px 8px 8px';
                upgradeDiv.style.marginBottom='12px';
                upgradeDiv.style.borderRadius='7px';
                upgradeDiv.style.backgroundColor = isMaxLevel?'rgba(0,255,136,0.08)':'rgba(0,0,0,0.26)';

                const levelIndicators = Array(data.maxLevel).fill(0).map((_,i)=>
                    `<span style="display:inline-block;width:10px;height:10px;margin:0 2px;border-radius:50%;background-color:${i<currentLevel?'#ff00ff':'#333'};box-shadow:${i<currentLevel?'0 0 6px #ff00ff':'none'}"></span>`
                ).join('');

                if(isMaxLevel){
                    upgradeDiv.innerHTML = `
                        <div style="color:#00ff88;font-weight:bold;">${data.name} (ĞœĞĞšĞ¡)</div>
                        <div style="font-size:11px;color:#00ff88;margin-bottom:5px;">${levelIndicators}</div>
                        <div style="font-size:13px;color:#00ff88;">ĞœĞĞšĞ¡Ğ˜ĞœĞ£Ğœ.</div>
                    `;
                } else {
                    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ
                    const nextCost = data.cost[currentLevel];
                    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ Ğ»Ğ¸ Ğ²ÑĞµÑ… Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
                    const canAfford =
                        currentEnergy >= nextCost.energy &&
                        currentMetals >= nextCost.metals &&
                        currentCrystals >= nextCost.crystals;
                    const btnColor = canAfford?'#ff00ff':'#444';
                    const btnShadow = canAfford?'0 0 10px #ff00ff':'none';
                    // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ²ÑĞµÑ… Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
                    let costHtml = `
                        <span style="color:${currentEnergy>=nextCost.energy?'#00ffff':'#ff3333'};font-weight:bold;">âš¡ ${nextCost.energy}</span>
                        <span style="color:${currentMetals>=nextCost.metals?'#ffaa00':'#ff3333'};font-weight:bold;">ğŸª ${nextCost.metals}</span>
                        <span style="color:${currentCrystals>=nextCost.crystals?'#ff00ff':'#ff3333'};font-weight:bold;">ğŸ’ ${nextCost.crystals}</span>
                    `;
                    upgradeDiv.innerHTML = `
                        <div style="color:#fff;font-weight:bold;">${data.name} (Ğ£Ñ€. ${currentLevel})</div>
                        <div style="font-size:11px;color:#ccc;margin-bottom:5px;">${levelIndicators}</div>
                        <div style="font-size:13px;color:#aaa;">${data.description}</div>
                        <div style="display:flex;flex-direction:column;gap:6px;margin-top:10px;">
                            <div style="display:flex;gap:12px;justify-content:flex-start;">${costHtml}</div>
                            <div style="display:flex;justify-content:flex-end;">
                                <button onclick="buyUpgrade('${key}'); setTimeout(renderUpgradeShopModal, 10);" style="background:${btnColor};color:#000;border:none;padding:6px 16px;cursor:${canAfford?'pointer':'not-allowed'};border-radius:3px;font-family:'Orbitron',monospace;font-weight:bold;box-shadow:${btnShadow};font-size:15px;transition:all 0.2s;" ${canAfford?'':'disabled'}>ĞšĞ£ĞŸĞ˜Ğ¢Ğ¬</button>
                            </div>
                        </div>
                    `;
                }
                list.appendChild(upgradeDiv);
            }
        }

        // ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¾Ğ²
        function openUpgradeShopModal() {
            const modal = document.getElementById('upgradeShopModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                renderUpgradeShopModal();
            }
        }
        // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ¾Ğ²
        function closeUpgradeShopModal() {
            const modal = document.getElementById('upgradeShopModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ° Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Ğ¼ÑƒĞ»ÑŒÑ‚Ğ¸-Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
        function buyUpgrade(key){
            const data = UPGRADE_DATA[key];
            const currentLevel = upgradeLevels[key];
            if(currentLevel >= data.maxLevel) return;
            const cost = data.cost[currentLevel];
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ Ğ»Ğ¸ Ğ²ÑĞµÑ… Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
            if(
                currentEnergy>=cost.energy &&
                currentMetals>=cost.metals &&
                currentCrystals>=cost.crystals
            ){
                currentEnergy -= cost.energy;
                currentMetals -= cost.metals;
                currentCrystals -= cost.crystals;
                upgradeLevels[key]++;
                saveData();
                applyUpgradeEffects();
                displayResources();
                // Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ¸Ğ´Ğ±ĞµĞº (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ)
                if(tg && tg.showAlert) {
                    tg.showAlert(`âœ… ${data.name} Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞµĞ½ Ğ´Ğ¾ Ğ£Ñ€. ${upgradeLevels[key]}!`);
                }
            } else {
                if(tg && tg.showAlert) tg.showAlert("ğŸš« ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²!");
                // ĞŸĞ¾ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ´Ğ»Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
                const modal = document.getElementById('upgradeShopModal');
                if (modal) {
                    const inner = modal.querySelector('div');
                    if (inner) {
                        inner.style.transform = 'translateX(-7px)';
                        setTimeout(()=>{inner.style.transform='translateX(7px)';
                            setTimeout(()=>{inner.style.transform='translateX(0)'},50);},50);
                    }
                }
            }
        }

        // === ĞŸĞ ĞĞ“Ğ Ğ•Ğ¡Ğ¡ ĞĞŸĞ“Ğ Ğ•Ğ™Ğ”ĞĞ’: Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ•/Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ ===
        function saveUpgradeData() {
            // ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµÑÑƒÑ€ÑÑ‹ Ğ¸ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ñ‹ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)
            const data = {
                currentEnergy,
                currentMetals,
                currentCrystals,
                // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ: upgrades: upgrades (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¾Ğ±ÑŠĞµĞºÑ‚ upgrades)
            };
            localStorage.setItem('xdgame_upgrade_data', JSON.stringify(data));
        }

        // === Enhanced Galaxy Switch & Cosmic Mystery ===
        function switchToGalaxy() {
            // Hide shooter UI, show galaxy map
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('galaxyContainer').style.display = 'flex';
            document.getElementById('bottomPanel').style.display = 'none';
            const galaxyPanel = document.getElementById('bottomPanel-galaxy');
            if (galaxyPanel) galaxyPanel.style.display = 'block';
            const shooterBtn = document.getElementById('shooterBtn');
            if (shooterBtn) shooterBtn.style.display = 'block';
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            try { backgroundMusic.pause(); } catch(e) {}
            try { galaxyMusic.play().catch(() => {}); } catch(e) {}
            initGalaxyMap();
            startMining();
            // Spawn a cosmic mystery event occasionally
            if (Math.random() < 0.16) spawnCosmicMystery();
        }

        // Spawns a rare cosmic mystery event on the galaxy map
        function spawnCosmicMystery() {
            const galaxyContainer = document.getElementById('galaxyContainer');
            if (!galaxyContainer) return;
            // Prevent multiple at once
            if (galaxyContainer.querySelector('.cosmic-mystery-event')) return;
            // Place at a random location
            const x = 15 + Math.random() * 70;
            const y = 15 + Math.random() * 70;
            const event = document.createElement('div');
            event.className = 'sector cosmic-mystery-event';
            event.style.position = 'absolute';
            event.style.left = `${x}%`;
            event.style.top = `${y}%`;
            event.style.width = '74px';
            event.style.height = '74px';
            event.style.borderRadius = '50%';
            event.style.background = 'radial-gradient(circle, #fff 0%, #00ffff 40%, #ff00ff 85%, transparent 100%)';
            event.style.border = '3px double #fff';
            event.style.boxShadow = '0 0 44px #ff00ff, 0 0 88px #00ffff';
            event.style.zIndex = 150;
            event.style.display = 'flex';
            event.style.alignItems = 'center';
            event.style.justifyContent = 'center';
            event.style.cursor = 'pointer';
            event.innerHTML = `<div style="text-align:center;font-size:15px;font-weight:bold;color:#fff;text-shadow:0 0 12px #00ffff;">âœ¨<br>COSMIC<br>MYSTERY</div>`;
            // Animate pulsating
            event.animate([
                { transform: 'scale(1)', opacity: 0.92 },
                { transform: 'scale(1.12)', opacity: 1 },
                { transform: 'scale(1)', opacity: 0.92 }
            ], { duration: 1800, iterations: Infinity });
            event.addEventListener('click', () => {
                // Reward: big resource bonus + $XSDC + random effect
                const base = 1000 + Math.floor(Math.random() * 2000);
                currentEnergy += base;
                currentMetals += Math.floor(base * 0.7);
                currentCrystals += Math.floor(base * 0.4);
                const xsdcGain = 888 + Math.floor(Math.random() * 888);
                currentXSDC += xsdcGain;
                displayResources();
                saveDataAll && saveDataAll();
                // Visual burst
                const burst = document.createElement('div');
                burst.style.position = 'absolute';
                burst.style.left = event.style.left;
                burst.style.top = event.style.top;
                burst.style.width = '220px';
                burst.style.height = '220px';
                burst.style.borderRadius = '50%';
                burst.style.background = 'radial-gradient(circle, #fff 0%, #00ffff 40%, #ff00ff 85%, transparent 100%)';
                burst.style.transform = 'translate(-50%, -50%)';
                burst.style.pointerEvents = 'none';
                burst.style.zIndex = 151;
                burst.style.animation = 'burstFade 2s ease-out forwards';
                galaxyContainer.appendChild(burst);
                setTimeout(() => burst.remove(), 1600);
                // Message
                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                    tg.showAlert(`âœ¨ Cosmic Mystery! +${base} energy, +${xsdcGain} $XSDC & more!`);
                } else {
                    alert(`âœ¨ Cosmic Mystery! +${base} energy, +${xsdcGain} $XSDC & more!`);
                }
                event.remove();
            });
            galaxyContainer.appendChild(event);
            setTimeout(() => { if (event.parentNode) event.remove(); }, 17000);
        }

        // Enhanced startGame: supports cosmic alien boss
        function startGame() {
            // Hide overlays, show shooter UI
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            document.getElementById('bottomPanel').style.display = 'flex';
            // Reset game state
            score = 0;
            lives = UPGRADE_DATA.hull.effect(upgradeLevels.hull);
            applyUpgradeEffects();
            gameRunning = true;
            enemySpawnRate = 0.01;
            bossInterval = 45000;
            // Chance for cosmic alien boss
            if (Math.random() < 0.11) {
                setTimeout(() => {
                    // Spawn a cosmic alien boss with special effects
                    if (typeof spawnCosmicAlienBoss === 'function') {
                        spawnCosmicAlienBoss();
                    } else {
                        // Fallback: show alert
                        if (typeof tg !== "undefined" && tg && tg.showAlert) {
                            tg.showAlert("ğŸ‘¾ Cosmic Alien Boss appears!");
                        } else {
                            alert("ğŸ‘¾ Cosmic Alien Boss appears!");
                        }
                    }
                }, 8000 + Math.random() * 12000);
            }
            gameLoop();
        }

        // ĞĞ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ switchToShooter: Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¼Ğ¸ÑÑĞ¸Ğ¹, $XSDC Ğ¸ ĞºĞ¾Ğ»Ğ±ÑĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ¼Ğ¸ÑÑĞ¸Ğ¸
        /**
         * ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼ ÑˆÑƒÑ‚ĞµÑ€Ğ°.
         * @param {boolean} isMission - true ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¼Ğ¸ÑÑĞ¸Ñ, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°
         * @param {number} missionDifficulty - ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¼Ğ¸ÑÑĞ¸Ğ¸ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 1)
         * @param {function} onMissionComplete - Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ»Ğ±ÑĞº Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸ Ğ¼Ğ¸ÑÑĞ¸Ğ¸
         * @param {object} missionOptions - Ğ¾Ğ¿Ñ†Ğ¸Ğ¸ Ğ¼Ğ¸ÑÑĞ¸Ğ¸: { xsdcReward, missionScoreBase }
         */
        function switchToShooter(isMission = false, missionDifficulty = 1, onMissionComplete = null, missionOptions = {}) {
            // ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¼Ğ°Ğ¹Ğ½Ğ¸Ğ½Ğ³ Ğ¿Ñ€Ğ¸ Ğ²Ñ…Ğ¾Ğ´Ğµ Ğ² ÑˆÑƒÑ‚ĞµÑ€
            stopMining();

            // UI: Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑˆÑƒÑ‚ĞµÑ€, ÑĞºÑ€Ñ‹Ñ‚ÑŒ Ğ³Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸ĞºÑƒ Ğ¸ Ğ»Ğ¸ÑˆĞ½Ğ¸Ğµ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸
            document.getElementById('galaxyContainer').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            document.getElementById('bottomPanel').style.display = 'flex';
            const galaxyPanel = document.getElementById('bottomPanel-galaxy');
            if (galaxyPanel) galaxyPanel.style.display = 'none';
            const shooterBtn = document.getElementById('shooterBtn');
            if (shooterBtn) shooterBtn.style.display = 'none';

            // Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ¸ Ñ„Ğ¾Ğ½Ğ¾Ğ²ÑƒÑ Ğ¼ÑƒĞ·Ñ‹ĞºÑƒ
            try { backgroundMusic.play().catch(() => {}); } catch(e) {}
            try { galaxyMusic.pause(); galaxyMusic.currentTime = 0; } catch(e) {}

            // Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ UI ÑÑ‚Ğ°Ñ€Ñ‚/Ğ³ĞµĞ¹Ğ¼-Ğ¾Ğ²ĞµÑ€ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ Ğ¸Ğ³Ñ€Ñ‹)
            if (!gameRunning) {
                if (lives <= 0) {
                    document.getElementById('gameOver').style.display = 'block';
                } else {
                    document.getElementById('startScreen').style.display = 'block';
                }
            }

            // --- ĞœĞ¸ÑÑĞ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ ---
            // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ğ¾Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼ Ğ¼Ğ¸ÑÑĞ¸Ğ¸
            if (isMission) {
                // ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»Ñ
                enemies = [];
                bullets = [];
                powerups = [];
                explosions = [];
                particles = [];
                boss = null;
                bossActive = false;

                // Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¸ÑÑĞ¸Ğ¸
                startMission(missionOptions);
            }
            if (isMission) {
                // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¼Ğ¸ÑÑĞ¸Ğ¸
                gameRunning = true;
                // Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¾ missionScoreBase, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞµĞ³Ğ¾, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼ score
                if (typeof missionOptions.missionScoreBase === 'number') {
                    score = missionOptions.missionScoreBase;
                } else {
                    score = Math.floor(score * missionDifficulty);
                }
                // Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñƒ Ğ²Ñ€Ğ°Ğ³Ğ¾Ğ² Ğ¸ Ğ±Ğ¾ÑÑĞ¾Ğ²
                enemySpawnRate = 0.03 * missionDifficulty;
                bossInterval = 45000 / missionDifficulty;

                // Ğ¤Ğ»Ğ°Ğ³ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ¼Ğ¸ÑÑĞ¸Ğ¸
                let missionActive = true;
                // Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ¼Ğ¸ÑÑĞ¸Ğ¸ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¿Ğ¾ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ñ†ĞµĞ»Ğ¸)
                // Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ²Ğ¾Ñ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸ĞºÑƒ, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¿Ğ¾ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ñƒ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ Ğ¾Ñ‡ĞºĞ°Ğ¼
                // ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ğ¼Ğ¸ÑÑĞ¸Ñ Ğ´Ğ»Ğ¸Ñ‚ÑÑ N ÑĞµĞºÑƒĞ½Ğ´, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ
                if (typeof missionOptions.durationMs === 'number' && missionOptions.durationMs > 0) {
                    setTimeout(() => {
                        if (!missionActive) return;
                        missionActive = false;
                        gameRunning = false;
                        // ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ° $XSDC
                        const xsdcReward = typeof missionOptions.xsdcReward === 'number' ? missionOptions.xsdcReward : Math.floor(1000 * missionDifficulty);
                        currentXSDC += xsdcReward;
                        displayResources();
                        saveDataAll && saveDataAll();
                        if (typeof onMissionComplete === 'function') {
                            onMissionComplete({ success: true, xsdcReward, score, difficulty: missionDifficulty });
                        } else {
                            // UI-Ñ„Ğ¸Ğ´Ğ±ĞµĞº
                            if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                tg.showAlert(`âœ… ĞœĞ¸ÑÑĞ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°! ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: +${xsdcReward} $XSDC`);
                            } else {
                                alert(`âœ… ĞœĞ¸ÑÑĞ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°! ĞĞ°Ğ³Ñ€Ğ°Ğ´Ğ°: +${xsdcReward} $XSDC`);
                            }
                        }
                        // Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ñƒ
                        switchToGalaxy();
                    }, missionOptions.durationMs);
                }
                // Ğ›Ğ¾Ğ³ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¼Ğ¸ÑÑĞ¸Ğ¸
                console.log("ğŸ’¥ ĞœĞ¸ÑÑĞ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ°!", { missionDifficulty, missionOptions });
            } else {
                // --- ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ ---
                gameRunning = true;
                enemySpawnRate = 0.03;
                bossInterval = 45000;
            }

            // Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ†Ğ¸ĞºĞ»Ğ°
            gameLoop();
        }

        // Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ°Ğ¹Ğ½Ğ¸Ğ½Ğ³Ğ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ²Ñ…Ğ¾Ğ´Ğµ Ğ² ĞºĞ°Ñ€Ñ‚Ñƒ
        function startMining() {
            if (miningInterval) return;
            miningInterval = setInterval(() => {
                // 1% Ğ¾Ñ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑĞ½ĞµÑ€Ğ³Ğ¸Ğ¸ Ğ² ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ Ğ´Ğ¾Ğ±Ñ‹Ñ‡Ğ¸
                const miningAmount = Math.max(5, Math.floor(currentEnergy * 0.01));
                updateGalaxyResources(miningAmount);
            }, 3500);
        }

        // ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¼Ğ°Ğ¹Ğ½Ğ¸Ğ½Ğ³Ğ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğµ Ğ¸Ğ· ĞºĞ°Ñ€Ñ‚Ñ‹
        function stopMining() {
            if (miningInterval) {
                clearInterval(miningInterval);
                miningInterval = null;
            }
        }
        
        // === Ğ“ĞĞ›ĞĞšĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ¯ ĞšĞĞ Ğ¢Ğ (ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ) ===
        // Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ $XSDC (Ğ±Ğ°Ğ»Ğ°Ğ½Ñ)
        let currentXSDC = 0;
        let telegramId = null;

        function loadUpgradeData() {
            try {
                const data = JSON.parse(localStorage.getItem('xdgame_upgrade_data'));
                if (data) {
                    if (typeof data.currentEnergy === 'number') currentEnergy = data.currentEnergy;
                    if (typeof data.currentMetals === 'number') currentMetals = data.currentMetals;
                    if (typeof data.currentCrystals === 'number') currentCrystals = data.currentCrystals;
                    // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ: if (data.upgrades) upgrades = data.upgrades;
                }
            } catch (e) {}
        }

        // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ $XSDC Ğ² Ñ€ĞµÑÑƒÑ€ÑĞ°Ñ…
        function displayResources() {
            const energyElem = document.getElementById('energy');
            const metalsElem = document.getElementById('metals');
            const crystalsElem = document.getElementById('crystals');
            const scoreElem = document.getElementById('galaxyScore');

            // $XSDC Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ
            let xsdcElem = document.getElementById('xsdcAmount');
            if (!xsdcElem) {
                const panel = document.querySelector('.resources-panel');
                if (panel) {
                    const div = document.createElement('div');
                    div.innerHTML = `ğŸª™ <span id="xsdcAmount">${Math.floor(currentXSDC)}</span> <span style="color:#ff00ff;">$XSDC</span>`;
                    panel.appendChild(div);
                    xsdcElem = div.querySelector('#xsdcAmount');
                }
            }

            // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            const highlightChange = (elem) => {
                if (!elem) return;
                elem.style.transition = 'background-color 0.3s';
                elem.style.backgroundColor = '#00ffff33';
                setTimeout(() => { elem.style.backgroundColor = 'transparent'; }, 300);
            };

            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
            if (energyElem) { energyElem.textContent = Math.floor(currentEnergy); highlightChange(energyElem); }
            if (metalsElem) { metalsElem.textContent = Math.floor(currentMetals); highlightChange(metalsElem); }
            if (crystalsElem) { crystalsElem.textContent = Math.floor(currentCrystals); highlightChange(crystalsElem); }
            if (scoreElem) { scoreElem.textContent = score; highlightChange(scoreElem); }
            if (xsdcElem) { xsdcElem.textContent = Math.floor(currentXSDC); highlightChange(xsdcElem); }

            console.log("Telegram ID:", telegramId);
        }

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ²ÑĞµ Ñ€ĞµÑÑƒÑ€ÑÑ‹ Ğ¸ $XSDC + Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ñ‹
        function saveDataAll() {
            const gameState = {
                energy: currentEnergy,
                metals: currentMetals,
                crystals: currentCrystals,
                shooterScore: score,
                shooterLives: lives,
                upgradeLevels: upgradeLevels,
                xsdc: currentXSDC,
                telegramId: telegramId,
            };
            try { localStorage.setItem('xdust_save_data', JSON.stringify(gameState)); } catch(e){}
        }

        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²ÑĞµ Ñ€ĞµÑÑƒÑ€ÑÑ‹ Ğ¸ $XSDC
        function loadDataAll() {
            try {
                const savedData = localStorage.getItem('xdust_save_data');
                if(!savedData) return false;
                const data = JSON.parse(savedData);
                if(typeof data.energy === 'number') currentEnergy = data.energy;
                if(typeof data.metals === 'number') currentMetals = data.metals;
                if(typeof data.crystals === 'number') currentCrystals = data.crystals;
                if(typeof data.shooterScore === 'number') score = data.shooterScore;
                if(typeof data.shooterLives === 'number') lives = data.shooterLives;
                if(data.upgradeLevels) upgradeLevels = data.upgradeLevels;
                if(typeof data.xsdc === 'number') currentXSDC = data.xsdc;
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                    telegramId = tg.initDataUnsafe.user.id;
                }
                if (typeof data.telegramId === 'number' || typeof data.telegramId === 'string') {
                    telegramId = data.telegramId;
                }
                applyUpgradeEffects();
                displayResources();
                return true;
            } catch(e) { console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:", e); return false; }
        }

        // === GalacticMap: Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸ÑÑĞ¸Ğ¹, Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ $XSDC ===
        function attemptCapture(sectorId, sectorObj, onFinish) {
            // sectorObj: Ğ¾Ğ±ÑŠĞµĞºÑ‚ ÑĞµĞºÑ‚Ğ¾Ñ€Ğ° (ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ type, resources, ...).
            // Ğ”Ğ»Ñ Ğ¼Ğ¸ÑÑĞ¸Ğ¸: Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ xsdcRequired*2, Ğ´Ğ»Ñ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑĞµĞºÑ‚Ğ¾Ñ€Ğ°: 10% Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
            if (sectorObj.type === 'mission') {
                // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¼Ğ¸ÑÑĞ¸Ğ¹ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, $XDUST-9001)
                const xsdcRequired = 3000; // Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¼Ğ¸ÑÑĞ¸Ğ¸
                const missionDuration = 5000;
                setTimeout(() => {
                    sectorObj.type = 'controlled';
                    currentXSDC += xsdcRequired * 2;
                    displayResources();
                    saveDataAll();
                    if (typeof onFinish === 'function') onFinish();
                    initGalaxyMap();
                }, missionDuration);
            } else {
                // ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ ÑĞµĞºÑ‚Ğ¾Ñ€
                sectorObj.type = 'controlled';
                // Ğ’Ñ‹Ğ´Ğ°ĞµĞ¼ Ğ±Ğ¾Ğ½ÑƒÑ $XSDC
                const bonus = Math.floor((sectorObj.resources || 0) * 0.1);
                currentXSDC += bonus;
                displayResources();
                saveDataAll();
                if (typeof onFinish === 'function') onFinish();
                // ĞŸĞµÑ€ĞµÑ€Ğ¸ÑĞ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñƒ
                initGalaxyMap();
            }
        }

        // === ĞĞ¾Ğ²Ñ‹Ğ¹: Ñ€ĞµĞ´ĞºĞ¾Ğµ Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¥Ñ…Ğ°Ğ°ÑĞ¾Ğ² ===
        function spawnHhaasEvent() {
            const galaxyContainer = document.getElementById('galaxyContainer');
            if (!galaxyContainer) return;

            if (galaxyContainer.querySelector('.hhaas-event')) return;

            const x = 10 + Math.random() * 80;
            const y = 10 + Math.random() * 80;

            const hhaas = document.createElement('div');
            hhaas.className = 'sector hhaas-event';
            hhaas.style.position = 'absolute';
            hhaas.style.left = `${x}%`;
            hhaas.style.top = `${y}%`;
            hhaas.style.width = '80px';
            hhaas.style.height = '80px';
            hhaas.style.borderRadius = '50%';
            hhaas.style.background = 'radial-gradient(circle, #ff88ff 0%, #ff44ff 50%, transparent 100%)';
            hhaas.style.boxShadow = '0 0 40px #ff44ff, 0 0 80px #ff88ff';
            hhaas.style.zIndex = 160;
            hhaas.style.display = 'flex';
            hhaas.style.alignItems = 'center';
            hhaas.style.justifyContent = 'center';
            hhaas.style.cursor = 'pointer';
            hhaas.innerHTML = `<div style="text-align:center;font-size:14px;font-weight:bold;color:#fff;text-shadow:0 0 8px #ff88ff;">
                                ğŸ‘½ Hhaas Show<br>âœ¨ XDUST
                               </div>`;

            hhaas.animate([
                { transform: 'scale(1)', opacity: 0.9 },
                { transform: 'scale(1.15)', opacity: 1 },
                { transform: 'scale(1)', opacity: 0.9 }
            ], { duration: 2000, iterations: Infinity });

            hhaas.addEventListener('click', () => {
                const energyBonus = 500 + Math.floor(Math.random() * 500);
                const metalsBonus = Math.floor(energyBonus * 0.7);
                const crystalsBonus = Math.floor(energyBonus * 0.4);
                const xsdcBonus = 250 + Math.floor(Math.random() * 250);

                currentEnergy += energyBonus;
                currentMetals += metalsBonus;
                currentCrystals += crystalsBonus;
                currentXSDC += xsdcBonus;
                displayResources();
                saveDataAll && saveDataAll();

                const burst = document.createElement('div');
                burst.style.position = 'absolute';
                burst.style.left = hhaas.style.left;
                burst.style.top = hhaas.style.top;
                burst.style.width = '180px';
                burst.style.height = '180px';
                burst.style.borderRadius = '50%';
                burst.style.background = 'radial-gradient(circle, #ff88ff 0%, #ff44ff 50%, transparent 100%)';
                burst.style.transform = 'translate(-50%, -50%)';
                burst.style.pointerEvents = 'none';
                burst.style.zIndex = 161;
                burst.style.animation = 'burstFade 2s ease-out forwards';
                galaxyContainer.appendChild(burst);
                setTimeout(() => burst.remove(), 1800);

                if (tg && tg.showAlert) {
                    tg.showAlert(`ğŸ‘½ Hhaas event! +${energyBonus}âš¡, +${metalsBonus}ğŸª, +${crystalsBonus}ğŸ’, +${xsdcBonus} $XSDC`);
                } else {
                    alert(`ğŸ‘½ Hhaas event! +${energyBonus}âš¡, +${metalsBonus}ğŸª, +${crystalsBonus}ğŸ’, +${xsdcBonus} $XSDC`);
                }

                hhaas.remove();
            });

            galaxyContainer.appendChild(hhaas);

            setTimeout(() => { if (hhaas.parentNode) hhaas.remove(); }, 20000);
        }

        // === ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿Ñ‹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ½Ğ° Ğ³Ğ°Ğ»Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ğµ ===
        function spawnCosmicStorm(sectors, container) {
            // ĞšĞ¾ÑĞ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑˆÑ‚Ğ¾Ñ€Ğ¼: Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ´Ğ¾Ğ±Ñ‹Ñ‡Ñƒ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
            if (!container) return;
            if (container.querySelector('.cosmic-storm-event')) return;
            const x = 10 + Math.random() * 80;
            const y = 10 + Math.random() * 80;
            const storm = document.createElement('div');
            storm.className = 'sector cosmic-storm-event';
            storm.style.position = 'absolute';
            storm.style.left = `${x}%`;
            storm.style.top = `${y}%`;
            storm.style.width = '68px';
            storm.style.height = '68px';
            storm.style.borderRadius = '50%';
            storm.style.background = 'radial-gradient(circle, #99e 40%, #223366 100%)';
            storm.style.border = '2.5px dashed #99e';
            storm.style.boxShadow = '0 0 36px #99e, 0 0 80px #223366';
            storm.style.zIndex = 170;
            storm.style.display = 'flex';
            storm.style.alignItems = 'center';
            storm.style.justifyContent = 'center';
            storm.style.cursor = 'pointer';
            storm.innerHTML = `<div style="text-align:center;font-size:14px;font-weight:bold;color:#fff;text-shadow:0 0 9px #99e;">ğŸŒ©ï¸<br>COSMIC<br>STORM</div>`;
            storm.animate([
                { transform: 'scale(1)', opacity: 0.92 },
                { transform: 'scale(1.13)', opacity: 1 },
                { transform: 'scale(1)', opacity: 0.92 }
            ], { duration: 1600, iterations: Infinity });
            storm.addEventListener('click', () => {
                // Ğ’Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ğ´Ğ¾Ğ±Ñ‹Ñ‡Ñƒ: ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ Ğ½Ğ° 40% Ğ½Ğ° 15 ÑĞµĞº
                if (!window._stormMiningPenalty) window._stormMiningPenalty = 0;
                window._stormMiningPenalty += 0.4;
                setTimeout(() => { window._stormMiningPenalty -= 0.4; }, 15000);
                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                    tg.showAlert("ğŸŒ©ï¸ Cosmic Storm! Mining -40% for 15 sec.");
                } else {
                    alert("ğŸŒ©ï¸ Cosmic Storm! Mining -40% for 15 sec.");
                }
                storm.remove();
            });
            container.appendChild(storm);
            setTimeout(() => { if (storm.parentNode) storm.remove(); }, 14000);
        }

        function spawnRealityRift(sectors, container) {
            // Ğ ĞµĞ°Ğ»Ğ¸Ñ‚Ğ¸-Ğ Ğ¸Ñ„Ñ‚: ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ, Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ´Ğ°Ñ‚ÑŒ Ñ€ĞµÑÑƒÑ€ÑÑ‹ Ğ¸Ğ»Ğ¸ Ğ¸Ñ… Ğ·Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ
            if (!container) return;
            if (container.querySelector('.reality-rift-event')) return;
            const x = 12 + Math.random() * 76;
            const y = 12 + Math.random() * 76;
            const rift = document.createElement('div');
            rift.className = 'sector reality-rift-event';
            rift.style.position = 'absolute';
            rift.style.left = `${x}%`;
            rift.style.top = `${y}%`;
            rift.style.width = '64px';
            rift.style.height = '64px';
            rift.style.borderRadius = '50%';
            rift.style.background = 'radial-gradient(circle, #fff 0%, #000 45%, #ff00ff 90%, transparent 100%)';
            rift.style.border = '2.5px solid #ff00ff';
            rift.style.boxShadow = '0 0 30px #ff00ff, 0 0 64px #000';
            rift.style.zIndex = 175;
            rift.style.display = 'flex';
            rift.style.alignItems = 'center';
            rift.style.justifyContent = 'center';
            rift.style.cursor = 'pointer';
            rift.innerHTML = `<div style="text-align:center;font-size:13px;font-weight:bold;color:#fff;text-shadow:0 0 10px #ff00ff;">ğŸŒ€<br>REALITY<br>RIFT</div>`;
            rift.animate([
                { transform: 'scale(1)', opacity: 0.90 },
                { transform: 'scale(1.18)', opacity: 1 },
                { transform: 'scale(1)', opacity: 0.90 }
            ], { duration: 1800, iterations: Infinity });
            rift.addEventListener('click', () => {
                // 50% ÑˆĞ°Ğ½Ñ: Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ², 50% - Ğ¿Ğ¾Ñ‚ĞµÑ€ÑÑ‚ÑŒ
                const good = Math.random() < 0.5;
                const base = 500 + Math.floor(Math.random() * 800);
                if (good) {
                    currentEnergy += base;
                    currentMetals += Math.floor(base * 0.7);
                    currentCrystals += Math.floor(base * 0.3);
                    currentXSDC += 222;
                } else {
                    currentEnergy = Math.max(0, currentEnergy - base);
                    currentMetals = Math.max(0, currentMetals - Math.floor(base * 0.7));
                    currentCrystals = Math.max(0, currentCrystals - Math.floor(base * 0.3));
                    currentXSDC = Math.max(0, currentXSDC - 111);
                }
                displayResources();
                saveDataAll && saveDataAll();
                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                    tg.showAlert(good ? "ğŸŒ€ Reality Rift! You gained mysterious resources." : "ğŸŒ€ Reality Rift! You lost resources.");
                } else {
                    alert(good ? "ğŸŒ€ Reality Rift! You gained mysterious resources." : "ğŸŒ€ Reality Rift! You lost resources.");
                }
                rift.remove();
            });
            container.appendChild(rift);
            setTimeout(() => { if (rift.parentNode) rift.remove(); }, 12000);
        }

        function spawnRandomGalaxyEvent(sectors, container) {
            // Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¾Ğ´Ğ½Ğ¾ Ğ¸Ğ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (ĞºÑ€Ğ¾Ğ¼Ğµ cosmic mystery/hhaas)
            const events = [
                () => spawnCosmicStorm(sectors, container),
                () => spawnRealityRift(sectors, container)
            ];
            const idx = Math.floor(Math.random() * events.length);
            events[idx]();
        }

        // === CHAOS PULSE SYSTEM ===
        let chaosPulseActive = false;

        function startChaosPulse() {
            if (chaosPulseActive) return;
            chaosPulseActive = true;

            const galaxyContainer = document.getElementById('galaxyContainer');
            if (!galaxyContainer) return;

            setInterval(() => {
                // 1. Ripple the stars
                const stars = document.getElementById('stars');
                if (stars) {
                    stars.style.transition = 'transform 1.5s ease';
                    stars.style.transform = `scale(${1 + Math.random() * 0.04}) rotate(${Math.random()*2}deg)`;
                }

                // 2. Warp sectors
                Array.from(galaxyContainer.querySelectorAll('.sector')).forEach(sector => {
                    sector.style.transition = 'transform 1.8s ease, left 1.8s ease, top 1.8s ease, filter 1.8s ease';
                    const dx = (Math.random() - 0.5) * 3; // shift X by a few %
                    const dy = (Math.random() - 0.5) * 3; // shift Y by a few %
                    const currentX = parseFloat(sector.style.left);
                    const currentY = parseFloat(sector.style.top);
                    sector.style.left = `${Math.min(100, Math.max(0, currentX + dx))}%`;
                    sector.style.top = `${Math.min(100, Math.max(0, currentY + dy))}%`;

                    // Glitch the visual
                    sector.style.filter = `hue-rotate(${Math.random()*360}deg) brightness(${0.9+Math.random()*0.2})`;
                    sector.style.transform = `scale(${1 + (Math.random()-0.5)*0.15}) rotate(${(Math.random()-0.5)*10}deg)`;
                });

                // 3. Glitch enemies in shooter mode
                if(gameRunning && enemies.length > 0) {
                    enemies.forEach(enemy => {
                        enemy.x += (Math.random()-0.5)*5;
                        enemy.y += (Math.random()-0.5)*5;
                        enemy.vx += (Math.random()-0.5)*0.2;
                        enemy.vy += (Math.random()-0.5)*0.2;
                    });
                }

                // 4. Random resource glitches
                if(Math.random() < 0.05) {
                    const chaosEnergy = 100 + Math.floor(Math.random() * 300);
                    currentEnergy += chaosEnergy;
                    currentMetals += Math.floor(chaosEnergy * 0.7);
                    currentCrystals += Math.floor(chaosEnergy * 0.4);
                    currentXSDC += 50 + Math.floor(Math.random() * 150);
                    displayResources();
                    saveDataAll && saveDataAll();
                }

                // 5. Flicker the background
                galaxyContainer.style.backgroundPosition = `${Math.random()*1000}px ${Math.random()*1000}px`;

            }, 2000); // every 2 seconds, the galaxy pulses
        }

        // Hook chaos pulse into galaxy switch
        const originalSwitchToGalaxy = switchToGalaxy;
        switchToGalaxy = function(...args) {
            originalSwitchToGalaxy(...args);
            startChaosPulse();
        };
        
        // === ĞĞ¾Ğ²Ñ‹Ğ¹ initGalaxyMap Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸ ===
        function initGalaxyMap() {
            loadUpgradeData();
            loadDataAll();
            applyUpgradeEffects();
            displayResources();

            const galaxyContainer = document.getElementById('galaxyContainer');
            Array.from(galaxyContainer.querySelectorAll('.sector')).forEach(el => el.remove());
            Array.from(galaxyContainer.querySelectorAll('div'))
                .forEach(el => {
                    if (!el.className && !el.id && el.style && el.style.position === 'absolute' && el.style.background === 'white') {
                        el.remove();
                    }
                });

            // Get sectors array
            const sectors = getGalaxySectors();

            // Dynamic events
            if (Math.random() < 0.18) spawnResourceAsteroid(sectors, galaxyContainer);
            if (Math.random() < 0.13) enemyRaid(sectors, galaxyContainer);
            if (Math.random() < 0.11) offerTrade(sectors, galaxyContainer);
            if (Math.random() < 0.09) triggerDistressSignal(sectors, galaxyContainer);
            if (Math.random() < 0.07) buildDefense(sectors, galaxyContainer);
            // === ĞĞ¾Ğ²Ñ‹Ğ¹: Ñ€ĞµĞ´ĞºĞ¾Ğµ Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¥Ñ…Ğ°Ğ°ÑĞ¾Ğ² ===
            if (Math.random() < 0.10) spawnHhaasEvent();

            // === ĞĞ¾Ğ²Ñ‹Ğ¹: Ñ€ĞµĞ´ĞºĞ¸Ğµ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğµ ĞºĞ¾ÑĞ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ===
            if (Math.random() < 0.12) spawnRandomGalaxyEvent(sectors, galaxyContainer);

            // Produce resources and update prosperity
            produceSectorResources(sectors);
            updateSectorProsperity(sectors);

            sectors.forEach(sector => {
                let sectorElement = document.createElement('div');
                let adjustedY = sector.y;
                if (sector.name === "ĞĞ›Ğ¬Ğ¤Ğ Ğ¦Ğ•ĞĞ¢ĞĞ’Ğ Ğ" || sector.name === "ALPHA CENTAURI") adjustedY = 55; // Support both
                if (sector.name === "$XDUST" || sector.name === "$XDUST-9999" || sector.name === "$XDUST-9001") {
                    adjustedY -= 8;
                    if (adjustedY < 0) adjustedY = 0;
                }
                if (sector.type === "mission") {
                    const isUnlocked = !sector.locked;
                    sectorElement.className = isUnlocked ? "sector mission-unlocked" : "sector mission-locked";
                    sectorElement.style.left = `${sector.x}%`;
                    sectorElement.style.top = `${adjustedY}%`;
                    sectorElement.innerHTML = `
                        <div style="text-align:center; font-size:11px;">
                            <strong>${sector.name}</strong><br>
                            ${isUnlocked ? "ğŸš€ MEGA MISSION" : "ğŸ”’ LOCKED"}<br>
                            âš¡${sector.resources}
                        </div>
                    `;
                    sectorElement.addEventListener('click', () => {
                        if (sector.name === "$XDUST-9001") {
                            if (currentEnergy >= 3000) {
                                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                    tg.showAlert("ğŸš€ MEGA MISSION STARTED!\nFinishing in 5 sec...");
                                } else {
                                    alert("ğŸš€ MEGA MISSION STARTED!\nFinishing in 5 sec...");
                                }
                                const burst = document.createElement('div');
                                burst.style.position = 'absolute';
                                burst.style.left = '50%';
                                burst.style.top = '50%';
                                burst.style.width = '200px';
                                burst.style.height = '200px';
                                burst.style.borderRadius = '50%';
                                burst.style.background = 'radial-gradient(circle, rgba(255,0,255,0.6), transparent 70%)';
                                burst.style.transform = 'translate(-50%, -50%)';
                                burst.style.animation = 'burstFade 2s ease-out forwards';
                                galaxyContainer.appendChild(burst);
                                setTimeout(() => burst.remove(), 2000);
                                attemptCapture(sector.id, sector, () => {
                                    if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                        tg.showAlert("âœ… Mission Completed! $XSDC received!");
                                    } else {
                                        alert("âœ… Mission Completed! $XSDC received!");
                                    }
                                });
                            } else {
                                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                    tg.showAlert(`ğŸ”’ Need 3000 âš¡\nYou have: ${currentEnergy}`);
                                } else {
                                    alert(`ğŸ”’ Need 3000 âš¡\nYou have: ${currentEnergy}`);
                                }
                            }
                        }
                    });
                } else if (sector.type === "xdust9999") {
                    sectorElement.className = "sector xdust9999-sector";
                    sectorElement.style.left = `${sector.x}%`;
                    sectorElement.style.top = `${adjustedY}%`;
                    sectorElement.innerHTML = `
                        <div style="text-align:center; font-size:13px;">
                            <strong style="color:#ff2222; text-shadow:0 0 12px #ff2222;">${sector.name}</strong><br>
                            <span style="color:#ff5555;">${sector.description && sector.description === "Ğ¡Ğ•ĞšĞ Ğ•Ğ¢ĞĞ«Ğ™ Ğ¡Ğ•ĞšĞ¢ĞĞ " ? "SECRET SECTOR" : sector.description}</span><br>
                            <span style="color:#ff2222;">âš¡${sector.resources}</span>
                        </div>
                    `;
                    sectorElement.style.boxShadow = "0 0 40px 12px #ff2222, 0 0 80px 24px #ff2222";
                    sectorElement.style.background = "radial-gradient(circle at 55% 60%, #ff3333 0%, #990000 70%, transparent 100%)";
                    sectorElement.style.border = "3px solid #ff2222";
                    sectorElement.style.animation = "xdust9999-glow 1.3s infinite alternate";
                    sectorElement.style.zIndex = 11;
                    let tail = document.createElement('div');
                    tail.style.position = 'absolute';
                    tail.style.left = '50%';
                    tail.style.top = '100%';
                    tail.style.transform = 'translateX(-50%)';
                    tail.style.width = '18px';
                    tail.style.height = '80px';
                    tail.style.background = 'linear-gradient(180deg, rgba(255,0,0,0.7) 0%, rgba(255,0,0,0.1) 100%)';
                    tail.style.borderRadius = '50% 50% 70% 70%/30% 30% 100% 100%';
                    tail.style.filter = 'blur(2.7px)';
                    tail.style.pointerEvents = 'none';
                    tail.style.zIndex = 10;
                    tail.style.opacity = "0.85";
                    tail.className = "xdust9999-tail";
                    sectorElement.appendChild(tail);
                    sectorElement.addEventListener('click', () => {
                        handleXDUSTEncounter(sector);
                    });
                } else if (sector.type === "xdust") {
                    sectorElement.className = "sector xdust-sector";
                    sectorElement.style.left = `${sector.x}%`;
                    sectorElement.style.top = `${adjustedY}%`;
                    sectorElement.innerHTML = `
                        <div style="text-align:center; font-size:13px;">
                            <strong style="color:#00ffff; text-shadow:0 0 14px #00ffff;">${sector.name}</strong><br>
                            <span style="color:#00ffff;">${sector.description && sector.description === "Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµĞºÑ‚Ğ¾Ñ€ XDUST" ? "Unique XDUST Sector" : sector.description}</span><br>
                            <span style="color:#00ffff;">âš¡${sector.resources}</span>
                        </div>
                    `;
                    sectorElement.style.boxShadow = "0 0 40px 10px #00ffff, 0 0 80px 30px #00ffff";
                    sectorElement.style.background = "radial-gradient(circle at 50% 60%, #00ffff 0%, #005577 70%, transparent 100%)";
                    sectorElement.style.border = "3px solid #00ffff";
                    sectorElement.style.animation = "xdust-glow 1.7s infinite alternate";
                    sectorElement.style.zIndex = 12;
                    let ring = document.createElement('div');
                    ring.style.position = 'absolute';
                    ring.style.left = '-15%';
                    ring.style.top = '-15%';
                    ring.style.width = '130%';
                    ring.style.height = '130%';
                    ring.style.border = '2.5px solid #00ffff';
                    ring.style.borderRadius = '50%';
                    ring.style.opacity = '0.5';
                    ring.style.pointerEvents = 'none';
                    ring.style.animation = "xdust-ring 2.7s infinite linear";
                    ring.className = "xdust-ring";
                    sectorElement.appendChild(ring);
                    sectorElement.addEventListener('click', () => {
                        handleXDUSTEncounter(sector);
                    });
                } else {
                    sectorElement.className = `sector ${sector.type}`;
                    sectorElement.style.left = `${sector.x}%`;
                    sectorElement.style.top = `${adjustedY}%`;
                    sectorElement.innerHTML = `
                        <div style="text-align: center; font-size: 10px;">
                            <strong>${sector.name === "Ğ¡Ğ˜Ğ Ğ˜Ğ£Ğ¡" ? "SIRIUS"
                                : sector.name === "ĞĞ›Ğ¬Ğ¤Ğ Ğ¦Ğ•ĞĞ¢ĞĞ’Ğ Ğ" ? "ALPHA CENTAURI"
                                : sector.name === "Ğ‘Ğ•Ğ¢Ğ•Ğ›Ğ¬Ğ“Ğ•Ğ™Ğ—Ğ•" ? "BETELGEUSE"
                                : sector.name === "ĞŸĞ ĞĞ¦Ğ˜ĞĞ" ? "PROCYON"
                                : sector.name === "Ğ’Ğ•Ğ“Ğ" ? "VEGA"
                                : sector.name === "ĞĞ ĞšĞ¢Ğ£Ğ " ? "ARCTURUS"
                                : sector.name === "Ğ Ğ˜Ğ“Ğ•Ğ›Ğ¬" ? "RIGEL"
                                : sector.name}
                            </strong><br>
                            âš¡${sector.resources}
                        </div>
                    `;
                    sectorElement.addEventListener('click', () => {
                        if (sector.type === 'enemy' || sector.type === 'neutral') {
                            if (sector.type !== 'controlled') {
                                attemptCapture(sector.id, sector, () => {
                                    if (typeof tg !== "undefined" && tg && tg.showAlert) {
                                        tg.showAlert(`âœ… Sector captured! Bonus: +${Math.floor((sector.resources||0)*0.1)} $XSDC`);
                                    } else {
                                        alert(`âœ… Sector captured! Bonus: +${Math.floor((sector.resources||0)*0.1)} $XSDC`);
                                    }
                                });
                            }
                        } else {
                            alert(`ğŸš€ Selected sector: ${sector.name}\nğŸ’ Resources: ${sector.resources} XDUST`);
                        }
                        if (sector.type === 'enemy') {
                            createResourceStream(sector);
                        }
                    });
                }
                galaxyContainer.appendChild(sectorElement);
            });
            // Add CSS animations for XDUST-9999 and XDUST sectors (once)
            if (!document.getElementById('xdust9999-glow-style')) {
                const style = document.createElement('style');
                style.id = 'xdust9999-glow-style';
                style.innerHTML = `
                @keyframes xdust9999-glow {
                    0% { box-shadow: 0 0 40px 12px #ff2222, 0 0 80px 24px #ff2222; opacity:0.93;}
                    50% { box-shadow: 0 0 70px 25px #ff2222, 0 0 150px 60px #ff2222; opacity:1;}
                    100% { box-shadow: 0 0 40px 12px #ff2222, 0 0 80px 24px #ff2222; opacity:0.93;}
                }
                @keyframes xdust-glow {
                    0% { box-shadow: 0 0 40px 10px #00ffff, 0 0 80px 30px #00ffff; opacity:0.8;}
                    50% { box-shadow: 0 0 80px 25px #00ffff, 0 0 160px 60px #00ffff; opacity:1;}
                    100% { box-shadow: 0 0 40px 10px #00ffff, 0 0 80px 30px #00ffff; opacity:0.8;}
                }
                @keyframes xdust-ring {
                    0% { transform: scale(1); opacity: 0.5;}
                    70% { transform: scale(1.3); opacity: 0.9;}
                    100% { transform: scale(1.7); opacity: 0;}
                }
                `;
                document.head.appendChild(style);
            }
            if (!galaxyContainer.querySelector('.galaxy-star')) {
                createGalaxyStars();
            }
            if (!galaxyContainer._xdustAutoTransfer) {
                galaxyContainer._xdustAutoTransfer = setInterval(() => {
                    const filtered = sectors.filter(s => s.name !== "Ğ¡Ğ˜Ğ Ğ˜Ğ£Ğ¡" && s.name !== "SIRIUS" && s.type !== "mission");
                    const randomSector = filtered[Math.floor(Math.random() * filtered.length)];
                    if (randomSector) {
                        createResourceStream(randomSector);
                    }
                }, 5000);
            }
        }

        
        function spawnResourceAsteroid(sectors, container) {
            const candidates = sectors.filter(s => !["xdust", "xdust9999", "mission"].includes(s.type));
            const target = candidates[Math.floor(Math.random() * candidates.length)];

            const asteroid = document.createElement('div');
            asteroid.className = 'sector asteroid-event';
            asteroid.id = `asteroid-${Date.now()}`; // unique ID
            asteroid.style.position = 'absolute';
            asteroid.style.left = `${target.x + (Math.random() * 10 - 5)}%`;
            asteroid.style.top = `${target.y + (Math.random() * 10 - 5)}%`;
            asteroid.style.width = '60px';
            asteroid.style.height = '60px';
            asteroid.style.background = 'radial-gradient(circle, #aaa 40%, #333 100%)';
            asteroid.style.border = '2px solid #ffaa00';
            asteroid.style.boxShadow = '0 0 20px #ffaa00, 0 0 60px #ffaa00';
            asteroid.style.zIndex = 100;
            asteroid.innerHTML = '<div style="text-align:center;font-size:10px;color:#ffaa00;">ğŸª¨ ASTEROID<br>+RESOURCES</div>';

            asteroid.addEventListener('click', () => {
                loadUpgradeData(); // ensures upgrades/resources are current
                const base = 400 + Math.floor(Math.random() * 400);
                currentEnergy += base;
                currentMetals += Math.floor(base * 0.7);
                currentCrystals += Math.floor(base * 0.25);
                // Optional: reward some $XDUST
                currentXSDC += 50;
                displayResources();
                saveDataAll && saveDataAll();
                asteroid.remove();
                if (tg && tg.showAlert) tg.showAlert("ğŸª¨ Resource asteroid collected! Resources + $XDUST gained.");
            });

            container.appendChild(asteroid);
            setTimeout(() => asteroid.remove(), 11000);
        }

        // 2. Ğ’Ñ€Ğ°Ğ¶ĞµÑĞºĞ¸Ğ¹ Ñ€ĞµĞ¹Ğ´ (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)
        function enemyRaid(sectors, container) {
                    const targets = sectors.filter(s => s.type === 'controlled');
                    if (targets.length === 0) return;
                    const target = targets[Math.floor(Math.random() * targets.length)];
                    const raid = document.createElement('div');
                    raid.className = 'sector raid-event';
                    raid.style.position = 'absolute';
                    raid.style.left = `${target.x}%`;
                    raid.style.top = `${target.y}%`;
                    raid.style.width = '70px';
                    raid.style.height = '70px';
                    raid.style.borderRadius = '50%';
                    raid.style.background = 'radial-gradient(circle, #ff4444 0%, #cc0000 50%, #660000 100%)';
                    raid.style.border = '3px solid #ff2222';
                    raid.style.boxShadow = '0 0 30px #ff2222, 0 0 60px rgba(255,34,34,0.5)';
                    raid.style.zIndex = 110;
                    raid.style.display = 'flex';
                    raid.style.alignItems = 'center';
                    raid.style.justifyContent = 'center';
                    raid.style.cursor = 'pointer';
                    raid.innerHTML = '<div style="text-align:center;font-size:11px;color:#fff;font-weight:bold;text-shadow:0 0 8px #ff2222;">Ã¢Å¡"Ã¯Â¸<br>RAID<br><span style="font-size:9px;">CLICK!</span></div>';
                    
                    // ĞŸÑƒĞ»ÑŒÑĞ¸Ñ€ÑƒÑÑ‰Ğ°Ñ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ
                    raid.animate([
                        { transform: 'scale(1)', boxShadow: '0 0 30px #ff2222, 0 0 60px rgba(255,34,34,0.5)' },
                        { transform: 'scale(1.15)', boxShadow: '0 0 45px #ff2222, 0 0 90px rgba(255,34,34,0.8)' },
                        { transform: 'scale(1)', boxShadow: '0 0 30px #ff2222, 0 0 60px rgba(255,34,34,0.5)' }
                    ], { duration: 1500, iterations: Infinity });
                    
                    raid.addEventListener('click', () => {
                        // Lose resources
                        const loss = 250 + Math.floor(Math.random() * 200);
                        currentEnergy = Math.max(0, currentEnergy - loss);
                        currentMetals = Math.max(0, currentMetals - Math.floor(loss * 0.6));
                        currentCrystals = Math.max(0, currentCrystals - Math.floor(loss * 0.2));
                        displayResources();
                        saveDataAll && saveDataAll();
                        
                        // Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚ Ğ²Ğ·Ñ€Ñ‹Ğ²Ğ°
                        const burst = document.createElement('div');
                        burst.style.position = 'absolute';
                        burst.style.left = raid.style.left;
                        burst.style.top = raid.style.top;
                        burst.style.width = '150px';
                        burst.style.height = '150px';
                        burst.style.borderRadius = '50%';
                        burst.style.background = 'radial-gradient(circle, rgba(255,68,68,0.8), transparent 70%)';
                        burst.style.transform = 'translate(-50%, -50%)';
                        burst.style.pointerEvents = 'none';
                        burst.style.zIndex = 111;
                        burst.style.animation = 'burstFade 1.5s ease-out forwards';
                        container.appendChild(burst);
                        setTimeout(() => burst.remove(), 1500);
                        
                        raid.remove();
                        if (typeof tg !== "undefined" && tg && tg.showAlert) {
                            tg.showAlert(`Ã¢Å¡"Ã¯Â¸ Enemy raid repelled! Lost ${loss} resources.`);
                        }
                    });
                    container.appendChild(raid);
                    setTimeout(() => { if (raid.parentNode) raid.remove(); }, 9000);
                }

        // 3. Ğ¢Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)
        function offerTrade(sectors, container) {
            // Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ ÑĞµĞºÑ‚Ğ¾Ñ€ (Ğ±ĞµĞ· ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ…)
            const candidates = sectors.filter(s => !["xdust", "xdust9999", "mission"].includes(s.type));
            const target = candidates[Math.floor(Math.random() * candidates.length)];
            const trade = document.createElement('div');
            trade.className = 'sector trade-event';
            trade.style.position = 'absolute';
            trade.style.left = `${target.x + (Math.random() * 8 - 4)}%`;
            trade.style.top = `${target.y + (Math.random() * 8 - 4)}%`;
            trade.style.width = '56px';
            trade.style.height = '56px';
            trade.style.background = 'radial-gradient(circle, #00ffaa 40%, #006666 100%)';
            trade.style.border = '2px solid #00ffaa';
            trade.style.boxShadow = '0 0 20px #00ffaa';
            trade.style.zIndex = 120;
            trade.innerHTML = '<div style="text-align:center;font-size:10px;color:#00ffaa;">ğŸ¤ TRADE<br>+/-RESOURCES</div>';
            trade.addEventListener('click', () => {
                // Random trade: gain or loss
                const isGood = Math.random() < 0.5;
                if (isGood) {
                    currentEnergy += 200;
                    currentMetals += 90;
                    currentCrystals += 35;
                } else {
                    currentEnergy = Math.max(0, currentEnergy - 140);
                    currentMetals = Math.max(0, currentMetals - 60);
                    currentCrystals = Math.max(0, currentCrystals - 15);
                }
                displayResources();
                saveDataAll && saveDataAll();
                trade.remove();
                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                    tg.showAlert(isGood ? "ğŸ¤ Successful trade! Resources gained." : "ğŸ¤ Bad deal! Resources lost.");
                }
            });
            container.appendChild(trade);
            setTimeout(() => trade.remove(), 8000);
        }

        // 4. Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ» Ğ±ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)
        function triggerDistressSignal(sectors, container) {
            // Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ ÑĞµĞºÑ‚Ğ¾Ñ€ (Ğ±ĞµĞ· ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ…)
            const candidates = sectors.filter(s => !["xdust", "xdust9999", "mission"].includes(s.type));
            const target = candidates[Math.floor(Math.random() * candidates.length)];
            const distress = document.createElement('div');
            distress.className = 'sector distress-event';
            distress.style.position = 'absolute';
            distress.style.left = `${target.x + (Math.random() * 7 - 3)}%`;
            distress.style.top = `${target.y + (Math.random() * 7 - 3)}%`;
            distress.style.width = '50px';
            distress.style.height = '50px';
            distress.style.background = 'radial-gradient(circle, #ff00ff 40%, #330044 100%)';
            distress.style.border = '2px solid #ff00ff';
            distress.style.boxShadow = '0 0 18px #ff00ff';
            distress.style.zIndex = 130;
            distress.innerHTML = '<div style="text-align:center;font-size:10px;color:#ff00ff;">ğŸ†˜ DISTRESS<br>+/-RESOURCES</div>';
            distress.addEventListener('click', () => {
                // 70% chance gain, 30% lose
                const isRescue = Math.random() < 0.7;
                if (isRescue) {
                    currentEnergy += 150;
                    currentMetals += 60;
                    currentCrystals += 18;
                } else {
                    currentEnergy = Math.max(0, currentEnergy - 120);
                    currentMetals = Math.max(0, currentMetals - 50);
                    currentCrystals = Math.max(0, currentCrystals - 10);
                }
                displayResources();
                saveDataAll && saveDataAll();
                distress.remove();
                if (typeof tg !== "undefined" && tg && tg.showAlert) {
                    tg.showAlert(isRescue ? "ğŸ†˜ Ship rescued! Resources gained." : "ğŸ†˜ Ship lost! Resources lost.");
                }
            });
            container.appendChild(distress);
            setTimeout(() => distress.remove(), 7000);
        }

        // 5. ĞŸĞ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€Ğ¾Ğ½Ñƒ (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)
        function buildDefense(sectors, container) {
            const controlled = sectors.filter(s => s.type === 'controlled');
            if (controlled.length === 0) return;
            const target = controlled[Math.floor(Math.random() * controlled.length)];
            const defense = document.createElement('div');
            defense.className = 'sector defense-event';
            defense.style.position = 'absolute';
            defense.style.left = `${target.x}%`;
            defense.style.top = `${target.y}%`;
            defense.style.width = '58px';
            defense.style.height = '58px';
            defense.style.background = 'radial-gradient(circle, #00aaff 40%, #003355 100%)';
            defense.style.border = '2px solid #00aaff';
            defense.style.boxShadow = '0 0 18px #00aaff';
            defense.style.zIndex = 140;
            defense.innerHTML = '<div style="text-align:center;font-size:10px;color:#00aaff;">ğŸ›¡ï¸ DEFENSE<br>-ENERGY</div>';
            defense.addEventListener('click', () => {
                if (currentEnergy > 300) {
                    currentEnergy -= 300;
                    // Bonus: temporarily boost mining
                    if (!window._defenseBonus) window._defenseBonus = 0;
                    window._defenseBonus += 0.05;
                    setTimeout(() => { window._defenseBonus -= 0.05; }, 15000);
                    displayResources();
                    saveDataAll && saveDataAll();
                    if (typeof tg !== "undefined" && tg && tg.showAlert) {
                        tg.showAlert("ğŸ›¡ï¸ Defense built! Mining boosted for 15 sec.");
                    }
                } else {
                    if (typeof tg !== "undefined" && tg && tg.showAlert) {
                        tg.showAlert("Not enough energy for defense!");
                    }
                }
                defense.remove();
            });
            container.appendChild(defense);
            setTimeout(() => defense.remove(), 9000);
        }

        // 6. ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ² Ğ² ÑĞµĞºÑ‚Ğ¾Ñ€Ğ°Ñ… (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€)
        function produceSectorResources(sectors) {
            sectors.forEach(sector => {
                if (sector.type === 'controlled') {
                    sector.resources += Math.floor(Math.random() * 15 + 5);
                }
            });
        }

        // 7. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ "Ğ±Ğ»Ğ°Ğ³Ğ¾ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ" ÑĞµĞºÑ‚Ğ¾Ñ€Ğ° (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€)
        function updateSectorProsperity(sectors) {
            // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞµÑĞ»Ğ¸ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ² > 3000
            sectors.forEach(sector => {
                if (sector.resources > 3000 && sector.type === 'controlled') {
                    // Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¿ĞµÑ†ÑÑ„Ñ„ĞµĞºÑ‚ Ğ¸Ğ»Ğ¸ Ğ±Ğ¾Ğ½ÑƒÑ
                }
            });
        }

        // 8. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ°ÑÑĞ¸Ğ² ÑĞµĞºÑ‚Ğ¾Ñ€Ğ¾Ğ² (Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼Ñ‹Ğ¹)
        function getGalaxySectors() {
            const baseSectors = [
                { id: 1, x: 15, y: 20, name: "Ğ¡Ğ˜Ğ Ğ˜Ğ£Ğ¡", type: "controlled", resources: 2000 },
                { id: 2, x: 25, y: 60, name: "ĞĞ›Ğ¬Ğ¤Ğ Ğ¦Ğ•ĞĞ¢ĞĞ’Ğ Ğ", type: "enemy", resources: 1500 },
                { id: 3, x: 50, y: 30, name: "Ğ‘Ğ•Ğ¢Ğ•Ğ›Ğ¬Ğ“Ğ•Ğ™Ğ—Ğ•", type: "neutral", resources: 800 },
                { id: 4, x: 70, y: 50, name: "ĞŸĞ ĞĞ¦Ğ˜ĞĞ", type: "controlled", resources: 1200 },
                { id: 5, x: 40, y: 70, name: "Ğ’Ğ•Ğ“Ğ", type: "enemy", resources: 1800 },
                { id: 6, x: 60, y: 20, name: "ĞĞ ĞšĞ¢Ğ£Ğ ", type: "neutral", resources: 600 },
                { id: 7, x: 80, y: 40, name: "Ğ Ğ˜Ğ“Ğ•Ğ›Ğ¬", type: "controlled", resources: 2500 },
                {
                    id: 9001,
                    x: 55, y: 80,
                    name: "$XDUST-9001",
                    type: "mission",
                    resources: 9001,
                    locked: currentEnergy < 3000,
                    requiredEnergy: 3000
                }
            ];
            // Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞµĞºÑ‚Ğ¾Ñ€Ğ°
            baseSectors.push({
                id: 9999,
                x: 75,
                y: 85,
                name: "$XDUST-9999",
                type: "xdust9999",
                resources: 9999,
                description: "Ğ¡Ğ•ĞšĞ Ğ•Ğ¢ĞĞ«Ğ™ Ğ¡Ğ•ĞšĞ¢ĞĞ ",
            });
            baseSectors.push({
                id: 7777,
                x: 30,
                y: 88,
                name: "$XDUST",
                type: "xdust",
                resources: 7777,
                description: "Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµĞºÑ‚Ğ¾Ñ€ XDUST",
                visited: false
            });
            return baseSectors;
        }

        // ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ² Ñ Ğ¡Ğ¸Ñ€Ğ¸ÑƒÑĞ°
        function createResourceStream(targetSector) {
            const sectors = [
                { id: 1, x: 15, y: 20, name: "Ğ¡Ğ˜Ğ Ğ˜Ğ£Ğ¡", type: "controlled", resources: 2000 },
                { id: 2, x: 25, y: 60, name: "ĞĞ›Ğ¬Ğ¤Ğ Ğ¦Ğ•ĞĞ¢ĞĞ’Ğ Ğ", type: "enemy", resources: 1500 },
                { id: 3, x: 50, y: 30, name: "Ğ‘Ğ•Ğ¢Ğ•Ğ›Ğ¬Ğ“Ğ•Ğ™Ğ—Ğ•", type: "neutral", resources: 800 },
                { id: 4, x: 70, y: 50, name: "ĞŸĞ ĞĞ¦Ğ˜ĞĞ", type: "controlled", resources: 1200 },
                { id: 5, x: 40, y: 70, name: "Ğ’Ğ•Ğ“Ğ", type: "enemy", resources: 1800 },
                { id: 6, x: 60, y: 20, name: "ĞĞ ĞšĞ¢Ğ£Ğ ", type: "neutral", resources: 600 },
                { id: 7, x: 80, y: 40, name: "Ğ Ğ˜Ğ“Ğ•Ğ›Ğ¬", type: "controlled", resources: 2500 }
            ];
            
            const sirius = sectors.find(s => s.name === "Ğ¡Ğ˜Ğ Ğ˜Ğ£Ğ¡");
            const stream = document.createElement('div');
            stream.style.position = 'absolute';
            stream.style.left = `${sirius.x}%`;
            stream.style.top = `${sirius.y}%`;
            stream.style.width = '4px';
            stream.style.height = '4px';
            stream.style.background = '#00ffff';
            stream.style.borderRadius = '50%';
            stream.style.boxShadow = '0 0 10px #00ffff';
            document.getElementById('galaxyContainer').appendChild(stream);
            
            // ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ
            const animation = stream.animate([
                {
                    left: `${sirius.x}%`,
                    top: `${sirius.y}%`,
                    opacity: 1
                },
                {
                    left: `${targetSector.x}%`,
                    top: `${targetSector.y}%`,
                    opacity: 0
                }
            ], {
                duration: 2000,
                easing: 'ease-out'
            });
            
            animation.onfinish = () => {
                stream.remove();
                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµÑÑƒÑ€ÑÑ‹
                updateGalaxyResources(targetSector.resources * 0.3);
            };
        }

        function updateGalaxyResources(amount) {
            // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
            currentEnergy += amount;
            currentMetals += amount * 0.7;
            currentCrystals += amount * 0.3;
            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ $XSDC
            displayResources();
            // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ² Ğ¸ $XSDC
            saveDataAll();
            // Ğ­Ñ„Ñ„ĞµĞºÑ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
            document.body.style.animation = 'glow 0.5s';
            setTimeout(() => {
                document.body.style.animation = '';
            }, 500);
        }

        // === $XDUST-9001 ĞœĞ•Ğ“Ğ-ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯: Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ¬ĞĞĞ¯ ĞĞĞ“Ğ ĞĞ”Ğ Ğ˜ ĞœĞ•Ğ“ĞĞ Ğ•Ğ¡Ğ£Ğ Ğ¡Ğ« ===
        function rewardXDUST9001Resources(targetSector) {
            const galaxyContainer = document.getElementById('galaxyContainer');
            const sirius = { x: 15, y: 20 }; // Sirius coordinates on map

            const rewards = [
                { type: 'energy', amount: currentEnergy },
                { type: 'metals', amount: currentMetals },
                { type: 'crystals', amount: currentCrystals }
            ];

            rewards.forEach(reward => {
                const stream = document.createElement('div');
                stream.style.position = 'absolute';
                stream.style.left = `${sirius.x}%`;
                stream.style.top = `${sirius.y}%`;
                stream.style.width = '6px';
                stream.style.height = '6px';
                stream.style.background = reward.type === 'energy' ? '#00ffff' :
                                         reward.type === 'metals' ? '#ffaa00' : '#ff00ff';
                stream.style.borderRadius = '50%';
                stream.style.boxShadow = `0 0 12px ${stream.style.background}`;
                galaxyContainer.appendChild(stream);

                const anim = stream.animate([
                    { left: `${sirius.x}%`, top: `${sirius.y}%`, opacity: 1 },
                    { left: `${targetSector.x}%`, top: `${targetSector.y}%`, opacity: 0 }
                ], {
                    duration: 2000,
                    easing: 'ease-out'
                });

                anim.onfinish = () => {
                    stream.remove();
                    switch (reward.type) {
                        case 'energy': currentEnergy += reward.amount; break;
                        case 'metals': currentMetals += reward.amount; break;
                        case 'crystals': currentCrystals += reward.amount; break;
                    }
                    displayResources();
                    saveDataAll();
                };
            });
        }

        function handleXDUST9001Click(isUnlocked, requiredEnergy) {
            if (!isUnlocked) {
                if (tg && tg.showAlert) {
                    tg.showAlert(`ğŸ”’ ĞœĞ¸ÑÑĞ¸Ñ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!\nĞ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ: ${requiredEnergy}`);
                } else {
                    alert(`ğŸ”’ ĞœĞ¸ÑÑĞ¸Ñ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!\nĞ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ: ${requiredEnergy}`);
                }
                return;
            }

            if (tg && tg.showAlert) {
                tg.showAlert('ğŸš€ ĞœĞ•Ğ“Ğ-ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯ $XDUST-9001 Ğ—ĞĞŸĞ£Ğ©Ğ•ĞĞ!\nĞ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· 5 ÑĞµĞº...');
            } else {
                alert('ğŸš€ ĞœĞ•Ğ“Ğ-ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯ $XDUST-9001 Ğ—ĞĞŸĞ£Ğ©Ğ•ĞĞ!\nĞ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· 5 ÑĞµĞº...');
            }

            const galaxyContainer = document.getElementById('galaxyContainer');
            const burst = document.createElement('div');
            burst.style.position = 'absolute';
            burst.style.left = '50%';
            burst.style.top = '50%';
            burst.style.width = '200px';
            burst.style.height = '200px';
            burst.style.borderRadius = '50%';
            burst.style.background = 'radial-gradient(circle, rgba(255,0,255,0.6), transparent 70%)';
            burst.style.transform = 'translate(-50%, -50%)';
            burst.style.animation = 'burstFade 2s ease-out forwards';
            galaxyContainer.appendChild(burst);
            setTimeout(() => burst.remove(), 2000);

            setTimeout(() => {
                const sector = { type: 'mission', resources: 9001, x: 55, y: 80 };
                sector.type = 'controlled';

                rewardXDUST9001Resources(sector);

                const xsdcReward = 5000;
                currentXSDC += xsdcReward;
                displayResources();
                saveDataAll();

                if (tg && tg.showAlert) {
                    tg.showAlert(`âœ… ĞœĞ¸ÑÑĞ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°! ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ +${xsdcReward} $XSDC`);
                } else {
                    alert(`âœ… ĞœĞ¸ÑÑĞ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°! ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ +${xsdcReward} $XSDC`);
                }

                initGalaxyMap();
            }, 5000);
        }

        function createGalaxyStars() {
            const galaxyContainer = document.getElementById('galaxyContainer');
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.style.position = 'absolute';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 2 + 1}px`;
                star.style.height = star.style.width;
                star.style.background = 'white';
                star.style.borderRadius = '50%';
                star.style.opacity = Math.random() * 0.7 + 0.3;
                star.style.animation = `twinkle ${Math.random() * 3 + 2}s infinite alternate`;
                galaxyContainer.appendChild(star);
            }
        }

        // === ĞšĞĞ¡ĞœĞ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ Ğ¨Ğ£Ğ¢Ğ•Ğ  ===
        // === Ğ—Ğ’Ğ£ĞšĞ˜: ĞŸĞ£Ğ› Ğ”Ğ›Ğ¯ Ğ”Ğ˜ĞĞĞœĞ˜Ğ§ĞĞĞ™ Ğ˜Ğ“Ğ Ğ« ===
        const shootSounds = [
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/shoot.ogg'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/shoot.mp3'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/shoot.m4a')
        ];
        const explosionSounds = [
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/explosion.ogg'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/explosion.mp3'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/explosion.m4a')
        ];
        const powerupSounds = [
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/powerup.ogg'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/powerup.mp3'),
            new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/powerup.m4a')
        ];

        const backgroundMusic = new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/melody.mp3');
        backgroundMusic.loop = true;
        backgroundMusic.volume = 0.5;

        const galaxyMusic = new Audio('https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/map.mp3');
        galaxyMusic.loop = true;
        galaxyMusic.volume = 0.4;
        galaxyMusic.load();

        function playGalaxyMusic() {
            if (galaxyMusic.paused) galaxyMusic.play().catch(e => console.warn("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ¼ÑƒĞ·Ñ‹ĞºĞ¸ ĞºĞ°Ñ€Ñ‚Ñ‹:", e));
        }
        function pauseGalaxyMusic() {
            if (!galaxyMusic.paused) galaxyMusic.pause();
        }

        let shootIndex = 0, explosionIndex = 0, powerupIndex = 0;

        // === Web Audio API Enhanced ===
        let audioContext = null;
        let shootBuffer = null;
        let isAudioLoaded = false;
        let fireIntensity = 0;
        const MAX_INTENSITY = 1.0;
        const shootSoundPath = "https://raw.githubusercontent.com/0penAGI/SPACEDUST/main/shoot.ogg";

        function initAudio() {
            if (isAudioLoaded) return;
            try { audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { return; }

            fetch(shootSoundPath)
                .then(r => r.arrayBuffer())
                .then(b => audioContext.decodeAudioData(b))
                .then(buffer => { shootBuffer = buffer; isAudioLoaded = true; });
        }

        function playShoot() {
            if (audioContext && shootBuffer && isAudioLoaded) {
                try {
                    const src = audioContext.createBufferSource();
                    src.buffer = shootBuffer;

                    // Pitch variation
                    let morph = Math.min(1, Math.max(0, fireIntensity / MAX_INTENSITY));
                    src.playbackRate.value = 1.0 + morph * 0.25 + (Math.random() - 0.5) * 0.05;

                    // Gain
                    const gain = audioContext.createGain();
                    gain.gain.value = 0.4 + morph * 0.4;

                    // Stereo panner
                    const pan = audioContext.createStereoPanner();
                    pan.pan.value = (Math.random() - 0.5) * morph * 2;

                    src.connect(gain).connect(pan).connect(audioContext.destination);

                    // Short granular slice
                    const duration = Math.max(0.08, 0.12 + morph * 0.04);
                    const offset = Math.random() * (shootBuffer.duration - duration - 0.01);
                    src.start(0, offset, duration);
                } catch (e) { fallbackShoot(); }
            } else { fallbackShoot(); }
        }

        function fallbackShoot() {
            const s = shootSounds[shootIndex];
            s.currentTime = 0;
            s.play().catch(() => {});
            shootIndex = (shootIndex + 1) % shootSounds.length;
        }

        function playExplosion() {
            if (audioContext) {
                const gain = audioContext.createGain();
                gain.gain.value = 0.6;
                const src = audioContext.createBufferSource();
                src.buffer = shootBuffer;
                src.playbackRate.value = 0.8 + Math.random() * 0.4;
                src.connect(gain).connect(audioContext.destination);
                src.start(0, 0, 0.15 + Math.random()*0.1);
            }
            const s = explosionSounds[explosionIndex];
            s.currentTime = 0;
            s.play().catch(() => {});
            explosionIndex = (explosionIndex + 1) % explosionSounds.length;
        }

        function playPowerup() {
            if (audioContext) {
                const gain = audioContext.createGain();
                gain.gain.value = 0.6;
                const src = audioContext.createBufferSource();
                src.buffer = shootBuffer;
                src.playbackRate.value = 1.0 + Math.random()*0.15;
                src.connect(gain).connect(audioContext.destination);
                src.start(0, 0, 0.12 + Math.random()*0.05);
            }
            const s = powerupSounds[powerupIndex];
            s.currentTime = 0;
            s.play().catch(() => {});
            powerupIndex = (powerupIndex + 1) % powerupSounds.length;
        }

        // ĞŸÑ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ·Ğ²ÑƒĞºĞ¾Ğ²
        function preloadSounds() {
            [...shootSounds, ...explosionSounds, ...powerupSounds].forEach(sound => {
                sound.load();
                sound.volume = 0.7;
            });
            backgroundMusic.load();
        }

        // Telegram WebApp
        let tg = window.Telegram?.WebApp;
        if (tg) { tg.expand(); tg.ready(); }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Ğ—Ğ²Ñ‘Ğ·Ğ´Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ğ½
        function createStars() {
            const starsContainer = document.getElementById('stars');
            starsContainer.innerHTML = '';
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 2;
                star.style.width = `${size}px`; star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`; star.style.top = `${Math.random() * 100}%`;
                star.style.opacity = 0.5 + Math.random() * 0.5;
                star.style.animationDelay = `${Math.random() * 2}s`;
                starsContainer.appendChild(star);
            }
        }
        createStars();

        // ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ² canvas
        function resizeCanvas() {
            const maxWidth = window.innerWidth - 20;
            const maxHeight = window.innerHeight - 20;
            const aspectRatio = 3 / 4;
            if (maxWidth / maxHeight > aspectRatio) {
                canvas.height = maxHeight;
                canvas.width = maxHeight * aspectRatio;
            } else {
                canvas.width = maxWidth;
                canvas.height = maxWidth / aspectRatio;
            }
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let gameRunning = false;
        let score = 0;
        let lives = 3;
        let animationId;
        let lastShot = 0;
        let shootCooldown = 250;

        const player = { x: canvas.width / 2 - 20, y: canvas.height - 60, width: 40, height: 40, speed: 5, dx: 0, isDamaged: false, damageTime: 0, flashTime: 0 };
        let bullets = [], enemies = [], stars = [], particles = [], powerUps = [];
        let enemySpawnRate = 0.03;
        let lastSpawnIncrease = Date.now();
        let bossTimer = Date.now();
        let bossInterval = 45000;
        let bossActive = false;
        let boss = null;
        let shieldActive = false;
        let megaShieldStage = 0;
        let megaShieldEnd = 0;
        let speedBoostEnd = 0;
        let laserModeEnd = 0;

        function createGameStars() {
            stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2 + 0.5, speed: Math.random() * 1.5 + 0.5, opacity: 0.5 + Math.random() * 0.5 });
            }
        }
        createGameStars();

        function createParticles(x, y, color = null, count = 12) {
            for (let i = 0; i < count; i++) {
                const colors = color ? [color] : ['#ff0000', '#ff8800', '#ffff00'];
                particles.push({ x, y, vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 0.5) * 8, life: 30 + Math.random() * 20, size: 3 + Math.random() * 2, color: colors[Math.floor(Math.random() * colors.length)] });
            }
            playExplosion();
        }

        let activeCombos = []; // Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²
        const COMBO_DURATION = 5000; // Ğ²Ñ€ĞµĞ¼Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ ĞºĞ¾Ğ¼Ğ±Ğ¾ Ğ² Ğ¼Ñ

        function createPowerUp(x, y, forcedType = null) {
            if (forcedType) {
                powerUps.push({ x: x - 10, y: y - 10, width: 24, height: 24, speed: 2, type: forcedType });
                return;
            }
            if (Math.random() < 0.3) {
                const types = ['shield', 'speed', 'laser'];
                powerUps.push({ x: x - 10, y: y - 10, width: 20, height: 20, speed: 2, type: types[Math.floor(Math.random() * types.length)] });
            }
        }

        function applyPowerUp(type) {
            playPowerup();
            player.flashTime = Date.now() + 300;

            // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ±Ğ¾Ğ½ÑƒÑ Ğ² Ğ¼Ğ°ÑÑĞ¸Ğ² ĞºĞ¾Ğ¼Ğ±Ğ¾
            activeCombos.push({ type: type, expires: Date.now() + COMBO_DURATION });

            // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹ Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… ĞºĞ¾Ğ¼Ğ±Ğ¾
            updateComboEffects();
        }

        function updateComboEffects() {
            const now = Date.now();

            // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸ÑÑ‚Ñ‘ĞºÑˆĞ¸Ğµ ĞºĞ¾Ğ¼Ğ±Ğ¾
            activeCombos = activeCombos.filter(combo => combo.expires > now);

            // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹
            shieldActive = false;
            speedBoostEnd = 0;
            laserModeEnd = 0;
            megaShieldStage = 0;
            megaShieldEnd = 0;

            // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹
            let shieldCount = 0;
            let speedCount = 0;
            let laserCount = 0;
            let megaCount = 0;

            activeCombos.forEach(combo => {
                switch(combo.type) {
                    case 'shield': shieldCount++; break;
                    case 'speed': speedCount++; break;
                    case 'laser': laserCount++; break;
                    case 'megaShield': megaCount++; break;
                }
            });

            if (shieldCount > 0) shieldActive = true;
            if (speedCount > 0) speedBoostEnd = now + 10000 + speedCount * 2000; // ÑƒÑĞ¸Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ñ ĞºĞ¾Ğ¼Ğ±Ğ¾
            if (laserCount > 0) laserModeEnd = now + 10000 + laserCount * 2000;  // ÑƒÑĞ¸Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ»Ğ°Ğ·ĞµÑ€
            if (megaCount > 0) { megaShieldStage = 2; megaShieldEnd = now + 15000 + megaCount * 5000; }

            // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹ ĞºĞ¾Ğ¼Ğ±Ğ¾
            // Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ÑƒÑĞ¸Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ flash Ğ¸Ğ»Ğ¸ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
        }

        // === Ğ Ğ˜Ğ¡ĞĞ’ĞĞĞ˜Ğ• (Ğ’Ğ¡Ğ ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ®) ===
        function drawPlayer() {
            ctx.save();
            let blink = false;
            if (player.isDamaged && Date.now() - player.damageTime < 1000) {
                blink = Math.floor((Date.now() - player.damageTime) / 60) % 2 === 0;
                ctx.globalAlpha = blink ? 0.2 : 1;
            }
            if (player.flashTime && Date.now() < player.flashTime) {
                ctx.save();
                ctx.globalAlpha = 0.7 * (1 - (player.flashTime - Date.now()) / 300);
                ctx.beginPath();
                ctx.arc(player.x + player.width/2, player.y + player.height/2, player.width * 1.2, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.shadowBlur = 50;
                ctx.shadowColor = '#fff';
                ctx.fill();
                ctx.restore();
            }
            const gradient = ctx.createLinearGradient(player.x, player.y, player.x, player.y + player.height);
            gradient.addColorStop(0, '#00ffff');
            gradient.addColorStop(1, '#0088ff');
            ctx.fillStyle = gradient;
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#00ffff';
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.lineTo(player.x + player.width / 2, player.y + player.height - 10);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ff00ff';
            ctx.shadowColor = '#ff00ff';
            ctx.beginPath();
            ctx.moveTo(player.x + 5, player.y + player.height - 15);
            ctx.lineTo(player.x + 10, player.y + player.height);
            ctx.lineTo(player.x + 15, player.y + player.height - 15);
            ctx.closePath();
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(player.x + 25, player.y + player.height - 15);
            ctx.lineTo(player.x + 30, player.y + player.height);
            ctx.lineTo(player.x + 35, player.y + player.height - 15);
            ctx.closePath();
            ctx.fill();
            const flameHeight = 10 + Math.random() * 10;
            const flameGradient = ctx.createLinearGradient(0, 0, 0, flameHeight);
            flameGradient.addColorStop(0, '#ffff00');
            flameGradient.addColorStop(1, '#ff8800');
            ctx.fillStyle = flameGradient;
            ctx.shadowColor = '#ffff00';
            ctx.beginPath();
            ctx.moveTo(player.x + 7, player.y + player.height);
            ctx.lineTo(player.x + 13, player.y + player.height);
            ctx.lineTo(player.x + 10, player.y + player.height + flameHeight);
            ctx.closePath();
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(player.x + 27, player.y + player.height);
            ctx.lineTo(player.x + 33, player.y + player.height);
            ctx.lineTo(player.x + 30, player.y + player.height + flameHeight);
            ctx.closePath();
            ctx.fill();

            // --- Ğ­Ğ¤Ğ¤Ğ•ĞšĞ¢ Ğ”Ğ«ĞœĞ/ĞšĞĞ¡ĞœĞ˜Ğ§Ğ•Ğ¡ĞšĞĞ“Ğ Ğ¡Ğ›Ğ•Ğ”Ğ ---
            for (let i = 0; i < 3; i++) {
                particles.push({
                    x: player.x + player.width/2 + (Math.random()*12 - 6),
                    y: player.y + player.height + 4,
                    vx: (Math.random() - 0.5) * 0.6,
                    vy: Math.random() * 2 + 1.5,
                    life: 12 + Math.random() * 6,
                    size: 1.5 + Math.random() * 1.5,
                    color: 'rgba(255,180,60,0.85)'
                });
            }
            if (megaShieldStage > 0 && Date.now() < megaShieldEnd) {
                ctx.save();
                ctx.beginPath();
                ctx.ellipse(player.x + player.width / 2, player.y + player.height / 2, player.width / 1.25, player.height / 1.05, 0, 0, Math.PI * 2);
                ctx.strokeStyle = megaShieldStage === 2 ? '#00ccff' : '#00ff00';
                ctx.lineWidth = 6;
                ctx.shadowColor = megaShieldStage === 2 ? '#00ccff' : '#00ff00';
                ctx.shadowBlur = 35;
                ctx.globalAlpha = 0.7;
                ctx.stroke();
                ctx.beginPath();
                ctx.ellipse(player.x + player.width / 2, player.y + player.height / 2, player.width / 1.7, player.height / 1.45, 0, 0, Math.PI * 2);
                ctx.strokeStyle = megaShieldStage === 2 ? '#00ff00' : '#0055ff';
                ctx.lineWidth = 3;
                ctx.shadowColor = megaShieldStage === 2 ? '#00ff00' : '#0055ff';
                ctx.shadowBlur = 18;
                ctx.globalAlpha = 0.5;
                ctx.stroke();
                ctx.restore();
            } else if (shieldActive) {
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.ellipse(player.x + player.width / 2, player.y + player.height / 2, player.width / 1.5, player.height / 1.2, 0, 0, Math.PI * 2);
                ctx.stroke();
            }
            ctx.restore();
            ctx.globalAlpha = 1;
        }

        function drawBullet(bullet) {
            ctx.save();
            const isLaser = Date.now() < laserModeEnd;
            ctx.fillStyle = isLaser ? '#ff00ff' : '#ffff00';
            ctx.shadowBlur = isLaser ? 15 : 10;
            ctx.shadowColor = isLaser ? '#ff00ff' : '#ffff00';
            const width = isLaser ? 8 : 4;
            const height = isLaser ? 20 : 12;
            ctx.beginPath();
            ctx.moveTo(bullet.x, bullet.y + height);
            ctx.lineTo(bullet.x + width, bullet.y + height);
            ctx.lineTo(bullet.x + width / 2, bullet.y);
            ctx.closePath();
            ctx.fill();
            if (isLaser) {
                const trailGradient = ctx.createLinearGradient(bullet.x + width / 2, bullet.y + height, bullet.x + width / 2, bullet.y + height + 10);
                trailGradient.addColorStop(0, 'rgba(255, 0, 255, 0.8)');
                trailGradient.addColorStop(1, 'rgba(255, 0, 255, 0)');
                ctx.fillStyle = trailGradient;
                ctx.fillRect(bullet.x, bullet.y + height, width, 10);
            }
            ctx.restore();
        }

        function drawEnemy(enemy) {
            ctx.save();
            const gradient = ctx.createLinearGradient(enemy.x, enemy.y, enemy.x, enemy.y + enemy.height);
            gradient.addColorStop(0, '#ff3232');
            gradient.addColorStop(1, '#880000');
            ctx.fillStyle = gradient;
            ctx.shadowBlur = 12;
            ctx.shadowColor = '#ff3232';
            ctx.beginPath();
            ctx.moveTo(enemy.x + enemy.width / 2, enemy.y + enemy.height);
            ctx.lineTo(enemy.x, enemy.y);
            ctx.lineTo(enemy.x + enemy.width / 2, enemy.y + 12);
            ctx.lineTo(enemy.x + enemy.width, enemy.y);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ff9999';
            ctx.beginPath();
            ctx.arc(enemy.x + 10, enemy.y + 10, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(enemy.x + enemy.width - 10, enemy.y + 10, 5, 0, Math.PI * 2);
            ctx.fill();
            const flameHeight = 3 + Math.random() * 3;
            ctx.fillStyle = '#ffff00';
            ctx.shadowColor = '#ffff00';
            ctx.fillRect(enemy.x + 5, enemy.y - flameHeight, 5, flameHeight);
            ctx.fillRect(enemy.x + enemy.width - 10, enemy.y - flameHeight, 5, flameHeight);
            ctx.restore();
        }

        function drawPowerUp(powerUp) {
            ctx.save();
            let color, symbol;
            switch(powerUp.type) {
                case 'shield': color = '#00aaff'; symbol = 'S'; break;
                case 'speed': color = '#00ff00'; symbol = 'P'; break;
                case 'laser': color = '#ffaa00'; symbol = 'L'; break;
                case 'megaShield': color = '#00ccff'; symbol = 'M'; break;
            }
            const gradient = ctx.createRadialGradient(powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, 0, powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, powerUp.width/2);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(1, color);
            ctx.fillStyle = gradient;
            ctx.shadowBlur = 18;
            ctx.shadowColor = color;
            ctx.beginPath();
            ctx.arc(powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, powerUp.width/2, 0, Math.PI * 2);
            ctx.fill();
            ctx.font = 'bold 14px Orbitron';
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(symbol, powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2);
            ctx.restore();
        }

        function drawBoss(bossObj) {
            ctx.save();
            ctx.shadowBlur = 30;
            ctx.shadowColor = '#ff00cc';
            ctx.fillStyle = '#ff0055';
            ctx.beginPath();
            ctx.moveTo(bossObj.x + bossObj.width/2, bossObj.y);
            ctx.lineTo(bossObj.x, bossObj.y + bossObj.height);
            ctx.lineTo(bossObj.x + bossObj.width/2, bossObj.y + bossObj.height - 20);
            ctx.lineTo(bossObj.x + bossObj.width, bossObj.y + bossObj.height);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(bossObj.x + 20, bossObj.y + 30, 8, 0, Math.PI*2);
            ctx.arc(bossObj.x + bossObj.width - 20, bossObj.y + 30, 8, 0, Math.PI*2);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.globalAlpha = 0.8;
            ctx.fillStyle = '#222';
            ctx.fillRect(bossObj.x + 10, bossObj.y + bossObj.height + 4, bossObj.width - 20, 10);
            ctx.fillStyle = '#00ffcc';
            ctx.fillRect(bossObj.x + 10, bossObj.y + bossObj.height + 4, (bossObj.width - 20) * (bossObj.hp/bossObj.maxhp), 10);
            ctx.globalAlpha = 1;
            ctx.restore();
        }

        function drawStars() {
            ctx.fillStyle = '#ffffff';
            stars.forEach(star => {
                ctx.globalAlpha = star.opacity;
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });
            ctx.globalAlpha = 1;
        }

        function drawParticles() {
            particles.forEach((p, i) => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 50;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }


        function movePlayer() {
            const currentSpeed = Date.now() < speedBoostEnd ? player.speed * 1.5 : player.speed;
            player.x += player.dx;
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
        }

        function shoot() {
            const now = Date.now();
            if (now - lastShot > shootCooldown) {
                const isLaser = now < laserModeEnd;
                bullets.push({
                    x: player.x + player.width / 2 - (isLaser ? 4 : 2),
                    y: player.y,
                    width: isLaser ? 8 : 4,
                    height: isLaser ? 20 : 12,
                    speed: isLaser ? 12 : 8
                });
                lastShot = now;
                playShoot();

                // --- Overheat effect ---
                fireIntensity += 0.1;
                if (fireIntensity > MAX_INTENSITY) fireIntensity = MAX_INTENSITY;
                applyOverheatEffect(fireIntensity);
            }
        }


        // --- Enemy Spawn System ---
        // Constants for spawn logic
    const ENEMY_SPAWN_INCREASE_INTERVAL = 15000;
    const MIN_ENEMY_SPAWN_RATE = 0.0055;
    // Lower initial spawn chances for elite enemies for smooth start
    const ENEMY_TYPES = [
        {
            type: 'normal',
            baseChance: () => enemySpawnRate,
            minRate: 0,
            spawn: () => {
                const size = 30 + Math.random() * 10;
                return {
                    x: Math.random() * (canvas.width - size),
                    y: -size,
                    width: size,
                    height: size,
                    speed: 1.3 + Math.random() * 1.5,
                    type: 'normal'
                };
            }
        },
        {
            type: 'code-drone',
            // Lower initial chance for first wave
            baseChance: () => Math.max(0.002, 0.004 + (enemySpawnRate * 0.08)),
            minRate: 0.01,
            spawn: () => {
                const size = 30;
                return {
                    x: Math.random() * (canvas.width - size),
                    y: -size,
                    width: size,
                    height: size,
                    speed: 3 + Math.random() * enemySpawnRate * 2,
                    type: 'code-drone'
                };
            }
        },
        {
            type: 'tank',
            // Lower initial chance for first wave
            baseChance: () => Math.max(0.003, 0.006 + (enemySpawnRate * 0.10)),
            minRate: 0.012,
            spawn: () => {
                const size = 45;
                return {
                    x: Math.random() * (canvas.width - size),
                    y: -size,
                    width: size,
                    height: size,
                    speed: 0.8 + enemySpawnRate,
                    hp: 5 + Math.floor(enemySpawnRate * 5),
                    type: 'tank',
                    color: '#888888'
                };
            }
        },
        {
            type: 'splitter',
            // Lower initial chance for first wave
            baseChance: () => Math.max(0.004, 0.008 + (enemySpawnRate * 0.13)),
            minRate: 0.015,
            spawn: () => {
                const size = 35;
                return {
                    x: Math.random() * (canvas.width - size),
                    y: -size,
                    width: size,
                    height: size,
                    speed: 2 + enemySpawnRate,
                    type: 'splitter',
                    splitCount: 2
                };
            }
        }
    ];

    // --- Staged Enemy Spawn System ---
    // Maximum number of enemies to spawn per frame (adjustable by stage)
    let MAX_ENEMIES_PER_FRAME = 2;

    // Track game start time for staging
    let gameStartTime = Date.now();
    let lastStage = 1;
    let stageAnnounced = 0;
    let bossSpawned = false;

    function spawnEnemyOfType(typeObj, spawnedCount, maxPerFrame) {
        // Try to spawn this enemy type based on its chance and minRate
        if (spawnedCount >= maxPerFrame) return false;
        if (enemySpawnRate >= typeObj.minRate && Math.random() < typeObj.baseChance()) {
            enemies.push(typeObj.spawn());
            return true;
        }
        return false;
    }

    function baseEliteEnemyChance() {
        // Returns a base value for elite-type enemy spawn chances (not used directly)
        return 0.01 + (enemySpawnRate * 0.1);
    }

    function getCurrentStage() {
        // Stages determined by elapsed game time in ms
        const elapsed = Date.now() - gameStartTime;
        if (elapsed < 20000) return 1; // Stage 1: 0-20s
        if (elapsed < 40000) return 2; // Stage 2: 20-40s
        if (elapsed < 60000) return 3; // Stage 3: 40-60s
        if (elapsed < 90000) return 4; // Stage 4: 60-90s
        return 5; // Stage 5: Boss
    }

    function announceStage(stage) {
        if (stageAnnounced !== stage) {
            stageAnnounced = stage;
                // let msg = "";
                // switch (stage) {
                //     case 2: msg = "âš¡ New enemy: Code-Drone!"; break;
                //     case 3: msg = "âš¡ New enemy: Splitter!"; break;
                //     case 4: msg = "âš¡ New enemy: Tank!"; break;
                //     case 5: msg = "âš¡ Boss incoming after wave!"; break;
                // }
                // if (msg && typeof tg !== "undefined" && tg && tg.showAlert) tg.showAlert(msg);
        }
    }
        
    function spawnEnemy() {
        // 1. Increase general spawn rate over time (capped)
        if (Date.now() - lastSpawnIncrease > ENEMY_SPAWN_INCREASE_INTERVAL) {
            // Gradual chaos: increase spawn rate over time
            enemySpawnRate = Math.min(enemySpawnRate + 0.005, 0.15);
            lastSpawnIncrease = Date.now();
        }

        // Calculate current stage
        const stage = getCurrentStage();
        announceStage(stage);

        // Gradually increase MAX_ENEMIES_PER_FRAME for later stages
        if (stage === 1) MAX_ENEMIES_PER_FRAME = 1;
        else if (stage === 2) MAX_ENEMIES_PER_FRAME = 1;
        else if (stage === 3) MAX_ENEMIES_PER_FRAME = 2;
        else if (stage === 4) MAX_ENEMIES_PER_FRAME = 3;
        else MAX_ENEMIES_PER_FRAME = 4;

        // 2. Staged enemy spawning
        let spawned = 0;
        // Stage 1: only normal enemies
        if (stage === 1) {
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[0], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
        }
        // Stage 2: normal + code-drones
        else if (stage === 2) {
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[0], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[1], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
        }
        // Stage 3: normal + code-drones + splitters
        else if (stage === 3) {
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[0], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[1], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[3], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
        }
        // Stage 4: normal + code-drones + splitters + tanks
        else if (stage === 4) {
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[0], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[1], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[3], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
            if (spawned < MAX_ENEMIES_PER_FRAME) {
                if (spawnEnemyOfType(ENEMY_TYPES[2], spawned, MAX_ENEMIES_PER_FRAME)) spawned++;
            }
        }
        // Stage 5: boss after wave is cleared
        else if (stage >= 5) {
            // If boss not spawned and all enemies are cleared, spawn boss
            if (!bossActive && !bossSpawned && enemies.length === 0) {
                bossActive = true;
                bossSpawned = true;
                boss = {
                    x: canvas.width / 2 - 40,
                    y: -90,
                    width: 80,
                    height: 80,
                    speed: 1 + enemySpawnRate,
                    hp: 20 + Math.floor(enemySpawnRate * 20),
                    maxhp: 20 + Math.floor(enemySpawnRate * 20),
                    type: 'boss',
                    shootCooldown: 2000,
                    lastShot: 0
                };
                if (typeof tg !== "undefined" && tg && tg.showAlert) tg.showAlert("âš¡ BOSS INCOMING!");
            }
            // After boss defeated, reset for next possible boss
            if (!bossActive && bossSpawned && enemies.length === 0) {
                bossSpawned = false;
                bossTimer = Date.now();
                // Optionally, increase difficulty or loop stages
                // gameStartTime = Date.now(); // Uncomment to loop stages
            }
            // Still allow some minor enemies to spawn for pressure
            if (spawned < MAX_ENEMIES_PER_FRAME && Math.random() < 0.03) {
                spawnEnemyOfType(ENEMY_TYPES[0], spawned, MAX_ENEMIES_PER_FRAME);
            }
        }
        // If boss should spawn by old timer logic (for backward compatibility)
        if (!bossActive && !bossSpawned && Date.now() - bossTimer > bossInterval) {
            bossActive = true;
            bossSpawned = true;
            boss = {
                x: canvas.width / 2 - 40,
                y: -90,
                width: 80,
                height: 80,
                speed: 1 + enemySpawnRate,
                hp: 20 + Math.floor(enemySpawnRate * 20),
                maxhp: 20 + Math.floor(enemySpawnRate * 20),
                type: 'boss',
                shootCooldown: 2000,
                lastShot: 0
            };
        }
    }

        // === Code Drone movement & destruction ===
        function updateCodeDrone(drone, time) {
            drone.x += Math.sin(time / 200) * 1.5 * timeDilationFactor;
            drone.y += 1.2 * timeDilationFactor;

            if (!drone.nextGlitch || Date.now() > drone.nextGlitch) {
                drone.nextGlitch = Date.now() + 2500 + Math.random() * 1000;
                setTimeout(() => {
                    drone.x += (Math.random() - 0.5) * 120;
                    drone.y += (Math.random() - 0.5) * 60;

                    // --- ĞĞ• Ğ’Ğ«ĞŸĞĞ”ĞĞ¢Ğ¬ Ğ—Ğ Ğ“Ğ ĞĞĞ˜Ğ¦Ğ« ---
                    drone.x = Math.max(0, Math.min(canvas.width - drone.width, drone.x));
                    drone.y = Math.max(0, Math.min(canvas.height - drone.height, drone.y));
                    // ------------------------------

                    createVisualGlitch(drone.x, drone.y);
                }, 100);
            }
        }

        function destroyCodeDrone(drone) {
            createCodeExplosion(drone.x, drone.y);
            timeDilationFactor = 0.4;
            setTimeout(() => timeDilationFactor = 1.0, 2000);
        }
        // === Boss Shooting Logic ===
        function bossShoot() {
            if (!bossActive || !boss) return;
            const now = Date.now();

            // Ğ¤Ğ°Ğ·Ñ‹ Ğ±Ğ¾ÑÑĞ°
            let phase = 1;
            if (boss.hp < boss.maxhp / 2) phase = 2;
            if (boss.hp < boss.maxhp / 4) phase = 3;

            // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿ĞµÑ€ĞµĞ·Ğ°Ñ€ÑĞ´ĞºĞ¸ Ğ¸ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ° Ğ¿Ğ¾ Ñ„Ğ°Ğ·Ğµ
            let angles = [];
            let cooldown = 2000;
            switch (phase) {
                case 1: // Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ²ĞµĞµÑ€
                    angles = [-Math.PI/3, -Math.PI/4, -Math.PI/6, -Math.PI/12, 0, Math.PI/12, Math.PI/6, Math.PI/4, Math.PI/3];
                    cooldown = 2000;
                    break;
                case 2: // ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²ĞµĞµÑ€, Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¿ÑƒĞ»ÑŒ
                    angles = [];
                    for (let i = -Math.PI/2; i <= Math.PI/2; i += Math.PI/12) angles.push(i);
                    cooldown = 1000;
                    break;
                case 3: // Ñ…Ğ°Ğ¾Ñ‚Ğ¸Ñ‡Ğ½Ğ°Ñ ÑĞ¿Ğ¸Ñ€Ğ°Ğ»ÑŒ
                    angles = [];
                    const step = Math.PI / 16;
                    for (let i = 0; i < 12; i++) {
                        angles.push((i * step + now/500) % Math.PI - Math.PI/2); // ÑĞ¿Ğ¸Ñ€Ğ°Ğ»ÑŒ Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼
                    }
                    cooldown = 800;
                    break;
            }

            if (now - boss.lastShot > cooldown) {
                const centerX = boss.x + boss.width / 2;
                const centerY = boss.y + boss.height;

                angles.forEach(angle => {
                    bullets.push({
                        x: centerX - 4,
                        y: centerY,
                        width: 8,
                        height: 12,
                        speed: 5 + phase, // Ñ„Ğ°Ğ·Ğ° ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿ÑƒĞ»ÑŒ
                        angle: angle,
                        isEnemy: true
                    });
                });

                boss.lastShot = now;
            }
        }


        // === Time Dilation Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ•Ğ Ğ•ĞœĞ•ĞĞĞ«Ğ• ===
        let timeDilationFactor = 1.0;
        let timeDilationMax = 0.5; // Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ½Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ¸Ğ¸
        let isDilating = false;
        let overheatLevel = 0;
        const MAX_OVERHEAT = 100;
        const DILATED_SHOOT_COOLDOWN = 250;

        // === ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Time Dilation ===
        function updateStars() {
            stars.forEach(star => {
                star.y += star.speed * timeDilationFactor;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx * timeDilationFactor;
                p.y += p.vy * timeDilationFactor;
                p.vx *= 0.95;
                p.vy *= 0.95;
                p.life -= timeDilationFactor;
                p.size *= 0.98;
                if (p.life <= 0 || p.size <= 0.1) particles.splice(i, 1);
            }
        }

        function updatePowerUps() {
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                powerUp.y += powerUp.speed * timeDilationFactor;
                if (player.x < powerUp.x + powerUp.width && player.x + player.width > powerUp.x && player.y < powerUp.y + powerUp.height && player.y + player.height > powerUp.y) {
                    applyPowerUp(powerUp.type);
                    powerUps.splice(i, 1);
                    createParticles(powerUp.x + powerUp.width/2, powerUp.y + powerUp.height/2, '#00ffff', 20);
                    score += 50;
                    updateUI();
                } else if (powerUp.y > canvas.height) {
                    powerUps.splice(i, 1);
                }
            }
        }

        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                if (bullet.isEnemy) {
                    if (bullet.angle !== undefined) {
                        bullet.x += Math.sin(bullet.angle) * bullet.speed * timeDilationFactor;
                        bullet.y += Math.cos(bullet.angle) * bullet.speed * timeDilationFactor;
                    } else {
                        bullet.y += bullet.speed * timeDilationFactor;
                    }
                    if (bullet.y > canvas.height || bullet.x < 0 || bullet.x > canvas.width) bullets.splice(i, 1);
                    else if (player.x < bullet.x + bullet.width && player.x + player.width > bullet.x &&
                             player.y < bullet.y + bullet.height && player.y + player.height > bullet.y) {
                        bullets.splice(i, 1);
                        if (shieldActive || (megaShieldStage > 0 && Date.now() < megaShieldEnd)) {
                            // Ğ¿Ğ¾Ğ¿Ğ°Ğ» Ğ¿Ğ¾ Ñ‰Ğ¸Ñ‚Ñƒ
                        } else {
                            lives--;
                            player.isDamaged = true;
                            player.damageTime = Date.now();
                            if (lives <= 0) endGame();
                        }
                        updateUI();
                    }
                } else {
                    bullet.y -= bullet.speed * timeDilationFactor;
                    if (bullet.y < 0) bullets.splice(i, 1);
                }
            }
        }

        // === ĞŸĞµÑ€ĞµĞ³Ñ€ĞµĞ² Ğ¾Ñ€ÑƒĞ¶Ğ¸Ñ: ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ===
        function updateOverheat() {
            // ĞŸĞ»Ğ°Ğ²Ğ½Ğ¾Ğµ ÑĞ½Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ²Ñ‹ÑÑ‚Ñ€ĞµĞ»Ğ°
            fireIntensity *= 0.95;
            if (fireIntensity < 0.01) fireIntensity = 0;

            // Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ/ÑƒĞ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¸Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ğ¿ĞµÑ€ĞµĞ³Ñ€ĞµĞ²Ğ°
            if (fireIntensity > 0.7) {
                overheatLevel += 0.8; // Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ñ€Ğ¾ÑÑ‚ Ğ¿ĞµÑ€ĞµĞ³Ñ€ĞµĞ²Ğ° Ğ¿Ñ€Ğ¸ ÑĞ¸Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¾Ğ³Ğ½Ğµ
            } else {
                overheatLevel -= 0.5; // Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾Ğµ Ğ¾Ñ…Ğ»Ğ°Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ
            }
            if (overheatLevel < 0) overheatLevel = 0;
            if (overheatLevel > MAX_OVERHEAT) overheatLevel = MAX_OVERHEAT;

            // Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ³Ñ€ĞµĞ²Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ñ„Ğ¾Ğ½/Ğ³Ñ€Ğ°Ğ´Ğ¸ĞµĞ½Ñ‚)
            const overheatBar = document.getElementById('overheatBar');
            if (overheatBar) {
                overheatBar.style.width = `${(overheatLevel / MAX_OVERHEAT) * 100}%`;
                overheatBar.style.background = `linear-gradient(to right, #ff3300, #ffcc00)`;
            }
        }

        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.y += enemy.speed * timeDilationFactor;
                if (enemy.type === 'code-drone') {
                    updateCodeDrone(enemy, Date.now());
                }
                if (enemy.y > canvas.height) {
                    enemies.splice(i, 1);
                    lives--;
                    updateUI();
                    if (lives <= 0) endGame();
                }
            }
            if (bossActive && boss) {
                boss.y += boss.speed * timeDilationFactor;
                if (boss.y > 40) boss.y = 40;
                bossShoot();
            }
        }

        function checkCollisions() {
            const bulletsToRemove = [];
            const enemiesToRemove = [];
            const powerUpsToCreate = [];

            for (let b = 0; b < bullets.length; b++) {
                const bullet = bullets[b];
                for (let e = 0; e < enemies.length; e++) {
                    const enemy = enemies[e];
                    if (bullet.x < enemy.x + enemy.width && bullet.x + bullet.width > enemy.x && bullet.y < enemy.y + enemy.height && bullet.y + bullet.height > enemy.y) {
                        // --- NEW LOGIC ---
                        if (enemy.type === 'tank') {
                            const dmg = UPGRADE_DATA.bulletDamage.effect(upgradeLevels.bulletDamage);
                            enemy.hp -= dmg;
                            createParticles(bullet.x + bullet.width/2, bullet.y + bullet.height/2, '#888888', 6);
                            score += Math.round(10 * dmg);
                            updateUI();
                            if (enemy.hp <= 0) {
                                enemiesToRemove.push(e);
                                createParticles(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2, null, 20);
                                powerUpsToCreate.push({x: enemy.x + enemy.width / 2, y: enemy.y + enemy.height / 2});
                            }
                        } else {
                            // add scoring for non-tank enemies
                            let gained = 0;
                            switch ((enemy && enemy.type) || 'normal') {
                                case 'code-drone':
                                    gained = 25;
                                    break;
                                case 'splitter':
                                    gained = 15;
                                    break;
                                case 'mini-splitter':
                                    gained = 8;
                                    break;
                                case 'normal':
                                default:
                                    gained = 10;
                                    break;
                            }

                            // apply score and visual/audio feedback
                            score += Math.round(gained);
                            updateUI();

                            enemiesToRemove.push(e);
                            createParticles(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2, null, 20);
                            powerUpsToCreate.push({x: enemy.x + enemy.width / 2, y: enemy.y + enemy.height / 2});
                            if (enemy.type === 'splitter') splitEnemy(enemy);
                            if (enemy.type === 'code-drone') destroyCodeDrone(enemy);
                        }
                        bulletsToRemove.push(b);
                        break;
                    }
                }
            }

            for (let e = 0; e < enemies.length; e++) {
                const enemy = enemies[e];
                if (player.x < enemy.x + enemy.width && player.x + player.width > enemy.x && player.y < enemy.y + enemy.height && player.y + player.height > enemy.y) {
                    enemiesToRemove.push(e);
                    createParticles(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2, null, 20);
                    if (megaShieldStage > 0 && Date.now() < megaShieldEnd) {
                        megaShieldStage--;
                        if (megaShieldStage === 0) megaShieldEnd = 0;
                    } else if (shieldActive) {
                        shieldActive = false;
                    } else {
                        lives--;
                        player.isDamaged = true;
                        player.damageTime = Date.now();
                    }
                    updateUI();
                    if (lives <= 0) endGame();
                }
            }

            if (bossActive && boss) {
                for (let b = 0; b < bullets.length; b++) {
                    const bullet = bullets[b];
                    if (bullet.x < boss.x + boss.width && bullet.x + bullet.width > boss.x && bullet.y < boss.y + boss.height && bullet.y + bullet.height > boss.y) {
                        bulletsToRemove.push(b);
                        // ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑƒÑ€Ğ¾Ğ½Ğ° Ğ¿Ğ¾ Ğ±Ğ¾ÑÑÑƒ
                        const dmg = UPGRADE_DATA.bulletDamage.effect(upgradeLevels.bulletDamage);
                        boss.hp -= dmg;
                        createParticles(bullet.x + bullet.width/2, bullet.y + bullet.height/2, '#00ccff', 6);
                        if (boss.hp <= 0) {
                            createParticles(boss.x + boss.width/2, boss.y + boss.height/2, null, 60);
                            score += Math.round(500 * dmg);
                            updateUI();
                            if (Math.random() < 0.1) createPowerUp(boss.x + boss.width/2, boss.y + boss.height/2, 'megaShield');
                            bossActive = false;
                            boss = null;
                            bossTimer = Date.now();
                        }
                        break;
                    }
                }
            }

            if (bossActive && boss) {
                if (player.x < boss.x + boss.width && player.x + player.width > boss.x && player.y < boss.y + boss.height && player.y + player.height > boss.y) {
                    if (megaShieldStage > 0 && Date.now() < megaShieldEnd) {
                        megaShieldStage--;
                        if (megaShieldStage === 0) megaShieldEnd = 0;
                    } else if (shieldActive) {
                        shieldActive = false;
                    } else {
                        lives--;
                        player.isDamaged = true;
                        player.damageTime = Date.now();
                    }
                    updateUI();
                    if (lives <= 0) endGame();
                }
            }

            bulletsToRemove.sort((a, b) => b - a).forEach(idx => bullets.splice(idx, 1));
            enemiesToRemove.sort((a, b) => b - a).forEach(idx => enemies.splice(idx, 1));
            powerUpsToCreate.forEach(pos => createPowerUp(pos.x, pos.y));
        }

        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
        }

        // ĞÑ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° ĞšĞ¾Ğ´Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ”Ñ€Ğ¾Ğ½Ğ°
        function drawCodeDrone(enemy) {
            ctx.save();
            // Ğ¢ĞµĞ»Ğ¾ Ğ´Ñ€Ğ¾Ğ½Ğ°
            const grad = ctx.createLinearGradient(enemy.x, enemy.y, enemy.x + enemy.width, enemy.y + enemy.height);
            grad.addColorStop(0, '#00ffff');
            grad.addColorStop(1, '#ff00ff');
            ctx.fillStyle = grad;
            ctx.shadowBlur = 16;
            ctx.shadowColor = '#00ffff';
            ctx.beginPath();
            ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.width/2, 0, Math.PI*2);
            ctx.fill();
            // "ĞšĞ¾Ğ´Ğ¾Ğ²Ñ‹Ğµ" Ğ»Ğ¸Ğ½Ğ¸Ğ¸
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.6;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                const angle = (Math.PI * 2 / 5) * i + (Date.now()/500 % Math.PI*2);
                ctx.lineTo(
                    enemy.x + enemy.width/2 + Math.cos(angle) * enemy.width/2,
                    enemy.y + enemy.height/2 + Math.sin(angle) * enemy.height/2
                );
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
            // Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ "Ğ¼Ğ¸Ğ³Ğ°ÑÑ‰Ğ°Ñ" Ñ‚Ğ¾Ñ‡ĞºĞ°
            ctx.beginPath();
            ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height/2, 4 + 2*Math.sin(Date.now()/150), 0, Math.PI*2);
            ctx.fillStyle = '#fff';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#fff';
            ctx.fill();
            ctx.restore();
        }

        function drawTankEnemy(enemy) {
            ctx.save();
            ctx.fillStyle = enemy.color || '#888888';
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#ffffff';
            ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            // HP bar
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(enemy.x, enemy.y - 8, enemy.width, 4);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(enemy.x, enemy.y - 8, enemy.width * (enemy.hp / 5), 4);
            ctx.restore();
        }

        function splitEnemy(enemy) {
            for (let i = 0; i < enemy.splitCount; i++) {
                enemies.push({
                    x: enemy.x + (Math.random() - 0.5) * 40,
                    y: enemy.y,
                    width: enemy.width * 0.6,
                    height: enemy.height * 0.6,
                    speed: enemy.speed * 1.5,
                    type: 'mini-splitter'
                });
            }
        }
        // === Visual Glitch & Code Explosion Particle Effects ===
        function createVisualGlitch(x, y) {
            for (let i = 0; i < 12; i++) {
                particles.push({
                    x: x + (Math.random() * 30 - 15),
                    y: y + (Math.random() * 30 - 15),
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 18 + Math.random() * 12,
                    size: 2,
                    color: `rgba(${100 + Math.random()*155}, ${50 + Math.random()*105}, 255, 0.9)`
                });
            }
        }

        function createCodeExplosion(x, y) {
            for (let i = 0; i < 40; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    life: 25 + Math.random() * 20,
                    size: 2.5 + Math.random() * 1.5,
                    color: `rgba(${100 + Math.random()*155}, ${50 + Math.random()*105}, 255, 1)`
                });
            }
        }

        function gameLoop() {
            if (!gameRunning) return;
            updateOverheat(); // Ğ¿Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ ÑĞ½Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ fireIntensity
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawStars(); updateStars();
            drawParticles(); updateParticles();
            powerUps.forEach(drawPowerUp); updatePowerUps();
            drawPlayer(); movePlayer();
            bullets.forEach(drawBullet); updateBullets();
            enemies.forEach(enemy => {
                if (enemy.type === 'code-drone') drawCodeDrone(enemy);
                else if (enemy.type === 'tank') drawTankEnemy(enemy);
                else drawEnemy(enemy);
            }); updateEnemies(); spawnEnemy();
            if (bossActive && boss) drawBoss(boss);
            if (megaShieldStage > 0 && Date.now() > megaShieldEnd) megaShieldStage = 0;
            if (player.isDamaged && Date.now() - player.damageTime > 1000) player.isDamaged = false;
            checkCollisions();
            animationId = requestAnimationFrame(gameLoop);
        }

        // === Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ===
        let isLeftPressed = false, isRightPressed = false, fireInterval;
        function updateDx() {
            const currentSpeed = Date.now() < speedBoostEnd ? player.speed * 1.5 : player.speed;
            player.dx = (isRightPressed ? currentSpeed : 0) - (isLeftPressed ? currentSpeed : 0);
        }
        function setLeft(active) { isLeftPressed = active; document.getElementById('leftBtn').classList.toggle('active', active); updateDx(); }
        function setRight(active) { isRightPressed = active; document.getElementById('rightBtn').classList.toggle('active', active); updateDx(); }
        // --- Time Dilation Fire/Overheat ---
        function setFire(active) {
            document.getElementById('fireBtn').classList.toggle('active', active);
            clearInterval(fireInterval);
            if (active) {
                // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¸
                if (!isAudioLoaded) initAudio();
                fireIntensity = Math.min(MAX_INTENSITY, fireIntensity + 0.25);
                // Time Dilation: ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ³Ñ€ĞµÑ‚Ğ¾, Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
                if (overheatLevel < MAX_OVERHEAT) {
                    isDilating = true;
                    timeDilationFactor = timeDilationMax;
                } else {
                    isDilating = false;
                    timeDilationFactor = 1.0;
                }
                shoot();
                fireInterval = setInterval(() => {
                    // ĞŸĞµÑ€ĞµĞ³Ñ€ĞµĞ² ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ÑÑ‚Ñ€ĞµĞ»ÑŒĞ±Ğµ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ¸Ñ
                    if (isDilating) {
                        overheatLevel += 2;
                        if (overheatLevel >= MAX_OVERHEAT) {
                            overheatLevel = MAX_OVERHEAT;
                            isDilating = false;
                            timeDilationFactor = 1.0;
                        }
                    } else {
                        // ĞÑÑ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ·Ğ°Ğ¼ĞµĞ´Ğ»ÑĞµĞ¼
                        overheatLevel = Math.max(0, overheatLevel - 1);
                    }
                    fireIntensity = Math.min(MAX_INTENSITY, fireIntensity + 0.08);
                    shoot();
                }, DILATED_SHOOT_COOLDOWN);
            } else {
                fireIntensity = 0;
                isDilating = false;
                timeDilationFactor = 1.0;
                // Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ Ğ¾ÑÑ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°Ğ½Ğ¸Ğ¸ FIRE
                const coolInterval = setInterval(() => {
                    overheatLevel = Math.max(0, overheatLevel - 2);
                    if (overheatLevel === 0) clearInterval(coolInterval);
                }, 40);
            }
        }

        const leftBtn = document.getElementById('leftBtn'), rightBtn = document.getElementById('rightBtn'), fireBtn = document.getElementById('fireBtn');
        const leftZone = document.getElementById('leftZone'), rightZone = document.getElementById('rightZone');
        [leftBtn, leftZone].forEach(el => {
            el.addEventListener('touchstart', e => { e.preventDefault(); setLeft(true); });
            el.addEventListener('touchend', e => { e.preventDefault(); setLeft(false); });
        });
        [rightBtn, rightZone].forEach(el => {
            el.addEventListener('touchstart', e => { e.preventDefault(); setRight(true); });
            el.addEventListener('touchend', e => { e.preventDefault(); setRight(false); });
        });
        fireBtn.addEventListener('touchstart', e => { e.preventDefault(); setFire(true); });
        fireBtn.addEventListener('touchend', e => { e.preventDefault(); setFire(false); });
        window.addEventListener('blur', () => { setLeft(false); setRight(false); setFire(false); });

        document.addEventListener('keydown', e => {
            if (!gameRunning || e.repeat) return;
            if (e.code === 'ArrowLeft') setLeft(true);
            if (e.code === 'ArrowRight') setRight(true);
            if (e.code === 'Space') setFire(true);
        });
        document.addEventListener('keyup', e => {
            if (e.code === 'ArrowLeft') setLeft(false);
            if (e.code === 'ArrowRight') setRight(false);
            if (e.code === 'Space') setFire(false);
        });

        

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('bottomPanel').style.display = 'flex';
            gameRunning = true;
            try { backgroundMusic.play().catch(() => {}); } catch(e) {}
            score = 0; lives = 3; bullets = []; enemies = [];
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            // Reset spawn system for new run
            gameStartTime = Date.now();
            lastStage = 1;
            stageAnnounced = 0;
            bossSpawned = false;
            enemySpawnRate = 0.03;
            lastSpawnIncrease = Date.now();
            bossTimer = Date.now();
            bossActive = false;
            boss = null;
            gameLoop();
        }

        function endGame() {
            try { backgroundMusic.pause(); backgroundMusic.currentTime = 0; } catch(e) {}
            try { galaxyMusic.pause(); galaxyMusic.currentTime = 0; } catch(e) {}
            gameRunning = false;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('bottomPanel').style.display = 'none';
            if (tg) tg.showAlert(`Ğ˜Ğ³Ñ€Ğ° Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°! Ğ¡Ñ‡Ñ‘Ñ‚: ${score}`);
        }

        function restartGame() { startGame(); }

        document.body.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

        // ĞŸÑ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ·Ğ²ÑƒĞºĞ¾Ğ² Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
        window.addEventListener('load', preloadSounds);
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¿Ğ¾ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼Ñƒ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ´Ğ»Ñ Web Audio API)
        document.body.addEventListener('touchstart', initAudio, { once: true });
        document.body.addEventListener('mousedown', initAudio, { once: true });
    </script>
</body>
</html>

